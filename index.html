<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreHub Pro</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/m8Pq2Sb.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff85; --bg: #0b0e11; --card: #161b22; --border: #30363d; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; letter-spacing: -0.02em; overflow-x: hidden; }
        header { background: rgba(11, 14, 17, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; max-width: 448px; z-index: 100; }

        .date-nav { display: flex; align-items: center; justify-content: space-between; padding: 16px; margin-top: 70px; }
        .date-display { font-weight: 900; font-size: 14px; text-transform: uppercase; text-align: center; flex: 1; }
        .nav-arrow { width: 36px; height: 36px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; font-weight: bold; }
        .today-btn { background: var(--accent); color: #000; font-size: 10px; font-weight: 900; padding: 6px 14px; border-radius: 6px; cursor: pointer; margin-top: 4px; }

        .league-container { background: #121212; border-radius: 16px; margin: 12px; overflow: hidden; border: 1px solid #222; }
        .league-header { background: #1a1a1a; padding: 12px 16px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 13px; color: #fff; border-bottom: 1px solid #222; }
        .league-logo { width: 20px; height: 20px; object-fit: contain; }
        .match-row { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #1a1a1a; }
        .team-box { display: flex; align-items: center; gap: 10px; flex: 1; }
        .team-logo { width: 24px; height: 24px; object-fit: contain; }
        .team-name { font-size: 13px; font-weight: 700; }
        .match-info { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .match-score { font-family: 'Roboto Mono', monospace; font-weight: 900; font-size: 16px; color: var(--accent); }

        .qualify-indicator { width: 4px; height: 24px; border-radius: 2px; margin-right: 10px; }
        .active-league { background: var(--accent) !important; color: #000 !important; }

        .nav-bottom { position: fixed; bottom: 0; width: 100%; max-width: 448px; background: #111; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .nav-item { color: #555; font-size: 10px; font-weight: 800; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .nav-item.active { color: var(--accent); }

        .player-avatar { width: 80px; height: 80px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #666; }
        .stat-card { background: #1a1a1a; border-radius: 12px; padding: 16px; border: 1px solid #222; }

        .search-input { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px 16px; color: #fff; width: 100%; font-size: 14px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .header-search-input { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 8px 10px; color: #fff; width: 170px; font-size: 12px; }
        .header-search-input:focus { outline: none; border-color: var(--accent); }

        .player-logo-dup { display:none !important; }

        .search-suggestions{
            position:absolute;
            right:16px;
            top:64px;
            background:#1a1a1a;
            border:1px solid #333;
            border-radius:10px;
            width:300px;
            max-height:320px;
            overflow-y:auto;
            z-index:200;
        }
        .search-suggestion{
            padding:10px 12px;
            cursor:pointer;
            font-size:12px;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .search-suggestion:hover{ background:#222; }

        .leader-pill{
            background:#111;
            border:1px solid #2a2a2a;
            border-radius:12px;
            padding:12px;
            cursor:pointer;
        }
        .leader-pill:hover{ border-color:#00ff85; }

        /* ===== LAST 5 MATCH RATING PILLS (PLAYER PAGE) ===== */
        .rating-pill{
            font-family: 'Roboto Mono', monospace;
            font-weight: 900;
            letter-spacing: -0.02em;
            border-radius: 9999px;
            padding: 8px 12px;
            min-width: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            line-height: 1;
        }
        .rating-pill.r-elite{ background: rgba(34,197,94,0.16); border-color: rgba(34,197,94,0.35); color: #22c55e; }   /* 8.0+ */
        .rating-pill.r-good{  background: rgba(34,197,94,0.10); border-color: rgba(34,197,94,0.20); color: #86efac; }   /* 7.0‚Äì7.9 */
        .rating-pill.r-ok{    background: rgba(250,204,21,0.14); border-color: rgba(250,204,21,0.32); color: #facc15; }  /* 6.0‚Äì6.9 */
        .rating-pill.r-bad{   background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.32); color: #ef4444; }    /* <6.0 */
        .rating-pill.r-na{    background: rgba(113,113,122,0.12); border-color: rgba(113,113,122,0.25); color: #a1a1aa; }/* n/a */
    </style>
</head>
<body class="max-w-md mx-auto pb-24">

    <header class="p-4">
        <div class="flex items-center justify-between gap-3 relative">
            <h1 class="text-xl font-black italic uppercase">Score<span class="text-[#00ff85]">Hub</span></h1>
            <input type="text" id="globalSearch" class="header-search-input" placeholder="Search teams or players." onkeyup="searchPlayer(event, 'globalSearch')" oninput="queueSuggestions('globalSearch', 'globalSearchSuggestions')" onfocus="queueSuggestions('globalSearch', 'globalSearchSuggestions')">
            <div id="globalSearchSuggestions" class="search-suggestions hidden"></div>
        </div>
    </header>

    <div id="hub-tab">
        <div class="date-nav">
            <div class="nav-arrow" onclick="prevDate()">‚Äπ</div>
            <div class="flex flex-col items-center">
                <div class="date-display" id="dateText">Loading...</div>
                <div class="today-btn" onclick="jumpToToday()">JUMP TO TODAY</div>
            </div>
            <div class="nav-arrow" onclick="nextDate()">‚Ä∫</div>
        </div>

        <div id="matches"></div>
    </div>

    <div id="standings-tab" class="hidden pt-20 pb-6">
        <div class="px-4">
            <div class="flex gap-2 mb-4">
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="standings-prem" onclick="showStandings('PREM')">PREM</button>
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="standings-laliga" onclick="showStandings('LALIGA')">LA LIGA</button>
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="standings-mls" onclick="showStandings('MLS')">MLS</button>
            </div>
        </div>
        <div id="standingsContent" class="px-4"></div>
    </div>

    <div id="stats-tab" class="hidden pt-20 pb-6">
        <div class="px-4">
            <div class="flex gap-2 mb-4">
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="stats-prem" onclick="showStats('PREM')">PREM</button>
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="stats-laliga" onclick="showStats('LALIGA')">LA LIGA</button>
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="stats-mls" onclick="showStats('MLS')">MLS</button>
                <button class="flex-1 py-2 rounded-lg bg-zinc-800 text-xs font-black" id="stats-combined" onclick="showStats('COMBINED')">COMBINED</button>
            </div>
        </div>
        <div id="statsContent" class="px-4"></div>
    </div>

    <div id="team-tab" class="hidden pt-20 pb-6">
        <div class="px-4" id="teamContent"></div>
    </div>

    <div id="player-tab" class="hidden pt-20 pb-6">
        <div class="px-4" id="playerContent"></div>
    </div>

    <div class="nav-bottom">
        <div class="nav-item active" onclick="switchTab('hub')">üèü<span>Hub</span></div>
        <div class="nav-item" onclick="switchTab('standings')">üìä<span>Standings</span></div>
        <div class="nav-item" onclick="switchTab('stats')">‚≠ê<span>Stats</span></div>
    </div>

<script>
const LOGOS = {
  "Inter Miami": "https://upload.wikimedia.org/wikipedia/en/thumb/4/46/Inter_Miami_CF_logo.svg/1200px-Inter_Miami_CF_logo.svg.png"
};

const TEAM_ALIASES = {};

const STATS_URLS = {
    PREM: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1721616887&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1758506604&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1783693750&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1445532075&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1378592215&single=true&output=csv'
    },
    LALIGA: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1828601090&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1875623411&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=812230696&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=692292778&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=701085531&single=true&output=csv'
    },
    MLS: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=138803585&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=414682584&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1700456254&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1656171976&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=2039536787&single=true&output=csv'
    }
};

const STANDINGS_URLS = {
    PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1691422592&single=true&output=csv',
    LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=730715571&single=true&output=csv',
    MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1098863787&single=true&output=csv'
};

let allMatches = [], uniqueDates = [], dateIdx = 0, currentView = 'hub', currentTeam = null, currentPlayer = null;
let statsData = { PREM: {}, LALIGA: {}, MLS: {}, COMBINED: {} };

let currentTeamPlayersList = [];
let currentTeamLeague = null;
let currentTeamName = null;

function parseSheetDate(raw) {
    if (!raw) return null;
    const str = raw.trim();
    const monthNameRegex = /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|June|July|August|September|October|November|December)/i;
    if (/matchday/i.test(str) || (!monthNameRegex.test(str) && /^\s*\d+[A-Z]?\b/i.test(str))) return 'MATCHDAY_MARKER';

    const monthMap = {
        "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5,
        "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11,
        "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "Jun": 5,
        "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11
    };

    const has2025 = str.includes('2025');
    let match = str.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)\.?\s*(\d+)/i);
    if (match) {
        const monthStr = match[1];
        const day = parseInt(match[2], 10);
        let month = -1;
        for (let key in monthMap) {
            if (key.toLowerCase() === monthStr.toLowerCase()) { month = monthMap[key]; break; }
        }
        if (month === -1) return null;
        const year = has2025 ? 2025 : 2026;
        const d = new Date(year, month, day);
        d.setHours(0, 0, 0, 0);
        return d;
    }
    return null;
}

function _stripLeadingPosFromTeam(pos, team) {
    const t = (team || '').toString().trim();
    const p = (pos || '').toString().trim();
    const m = t.match(/^\s*(\d{1,2})\s*[\.\)\-:]?\s+(.+)\s*$/);
    if (!m) return { pos: p, team: t };
    const lead = m[1];
    const rest = m[2].trim();
    if (!p) return { pos: lead, team: rest };
    const pn = parseInt(p, 10);
    const ln = parseInt(lead, 10);
    if (!Number.isNaN(pn) && !Number.isNaN(ln) && pn === ln) return { pos: p, team: rest };
    return { pos: p, team: t };
}

/* helpers */
function _fmtRating(x){
    const v = Number(x);
    if (Number.isNaN(v)) return '-';
    return v.toFixed(2);
}

function ratingClass(v){
    const n = Number(v);
    if (Number.isNaN(n)) return 'r-na';
    if (n >= 8.0) return 'r-elite';
    if (n >= 7.0) return 'r-good';
    if (n >= 6.0) return 'r-ok';
    return 'r-bad';
}

function canonicalTeamName(name) {
    if (!name) return '';
    const n = name.toString().trim();
    const k = n.toLowerCase();
    if (TEAM_ALIASES[k]) return TEAM_ALIASES[k].toLowerCase();
    return k;
}

function getLogo(teamName) {
    if (!teamName) return '';
    const key = Object.keys(LOGOS).find(k => canonicalTeamName(k) === canonicalTeamName(teamName));
    return key ? LOGOS[key] : '';
}

function getTeamEmoji(teamName){
    return '';
}

function switchTab(tab) {
    currentView = tab;
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('team-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    if (tab === 'hub') document.getElementById('hub-tab').classList.remove('hidden');
    if (tab === 'standings') document.getElementById('standings-tab').classList.remove('hidden');
    if (tab === 'stats') document.getElementById('stats-tab').classList.remove('hidden');
    if (tab === 'team') document.getElementById('team-tab').classList.remove('hidden');
    if (tab === 'player') document.getElementById('player-tab').classList.remove('hidden');

    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const idx = tab === 'hub' ? 0 : tab === 'standings' ? 1 : 2;
    document.querySelectorAll('.nav-item')[idx].classList.add('active');
}

/* CSV parsing */
function parseCsv(url, header = true){
    return new Promise((resolve) => {
        Papa.parse(url, {
            download: true,
            header,
            complete: (res) => resolve(res.data || []),
            error: () => resolve([])
        });
    });
}

/* standings cache */
const standingsCache = {};
async function loadStandingsCache(league) {
    if (standingsCache[league]) return standingsCache[league];

    standingsCache[league] = await new Promise((resolve) => {
        Papa.parse(STANDINGS_URLS[league], {
            download: true,
            header: true,
            complete: (res) => {
                const map = {};
                (res.data || []).forEach(r => {
                    let pos = r.Position || r.position || r['#'] || '';
                    let team = r.Team || r.team || '';
                    const fixed = _stripLeadingPosFromTeam(pos, team);
                    pos = fixed.pos;
                    team = fixed.team;

                    const teamKey = canonicalTeamName(team);
                    if (!teamKey) return;

                    map[teamKey] = {
                        pos: pos,
                        team: team,
                        mp: r.MP || r.mp || '',
                        wdl: r['W-D-L'] || r.wdl || '',
                        pts: r.Points || r.Pts || r.pts || ''
                    };
                });
                resolve(map);
            },
            error: () => resolve({})
        });
    });

    return standingsCache[league];
}

/* fuzzy helpers */
function _normMatch(s){ return (s||'').toString().trim().toLowerCase(); }
function _editDistance(a, b, limit = 999) {
    a = _normMatch(a);
    b = _normMatch(b);
    if (a === b) return 0;
    if (!a) return b.length;
    if (!b) return a.length;

    const al = a.length, bl = b.length;
    if (Math.abs(al - bl) > limit) return limit + 1;

    const prev = new Array(bl + 1);
    const curr = new Array(bl + 1);
    for (let j = 0; j <= bl; j++) prev[j] = j;

    for (let i = 1; i <= al; i++) {
        curr[0] = i;
        let minRow = curr[0];
        const ca = a.charCodeAt(i - 1);
        for (let j = 1; j <= bl; j++) {
            const cost = ca === b.charCodeAt(j - 1) ? 0 : 1;
            const v = Math.min(prev[j] + 1, curr[j - 1] + 1, prev[j - 1] + cost);
            curr[j] = v;
            if (v < minRow) minRow = v;
        }
        if (minRow > limit) return limit + 1;
        for (let j = 0; j <= bl; j++) prev[j] = curr[j];
    }
    return prev[bl];
}

function _makePlayerKey(league, team, name) {
    return `${league}:::${(team || '').trim()}:::${(name || '').trim()}`;
}
function _splitPlayerKey(key) {
    const parts = (key || '').split(':::');
    if (parts.length < 3) return { league: null, team: null, name: key };
    return { league: parts[0], team: parts[1], name: parts.slice(2).join(':::') };
}
function _bestFuzzyPlayerMatch(query, candidates) {
    const q = _normMatch(query);
    if (!q) return null;

    let best = null;
    let best2 = null;

    for (const c of candidates) {
        const n1 = _normMatch(c.name);
        const n2 = _normMatch(`${c.name} ${c.team || ''}`);
        const lim = Math.max(2, Math.floor(Math.max(q.length, n1.length) * 0.25));

        const d1 = _editDistance(q, n1, lim);
        const d2 = _editDistance(q, n2, lim);

        const d = Math.min(d1, d2);
        if (d <= lim) {
            if (!best || d < best.dist) {
                best2 = best;
                best = { dist: d, cand: c };
            } else if (!best2 || d < best2.dist) {
                best2 = { dist: d, cand: c };
            }
        }
    }

    if (best) return best.cand;
    return null;
}

function _norm(s) { return (s || '').toString().trim().toLowerCase(); }
function _bestMatch(query, candidates) {
    const q = _norm(query);
    if (!q) return null;
    const exact = candidates.find(c => _norm(c) === q);
    if (exact) return exact;
    const starts = candidates.find(c => _norm(c).startsWith(q));
    if (starts) return starts;
    const incl = candidates.find(c => _norm(c).includes(q));
    if (incl) return incl;
    return null;
}

function _guessLeagueForTeam(teamName) {
    const logo = getLogo(teamName) || '';
    if (logo.includes('mlssoccer')) return 'MLS';
    if (logo.includes('premierleague')) return 'PREM';
    return 'LALIGA';
}
function _findTeamLeague(teamName) {
    const tk = canonicalTeamName(teamName);
    const m = allMatches.find(x => x.homeKey === tk || x.awayKey === tk);
    if (m) return m.league;
    return _guessLeagueForTeam(teamName);
}
function _resolveTeamFromQuery(query) {
    const rep = {};
    const add = (t) => {
        if (!t) return;
        const k = canonicalTeamName(t);
        if (!rep[k]) rep[k] = t;
    };

    allMatches.forEach(m => { add(m.home); add(m.away); });
    Object.keys(LOGOS).forEach(add);
    Object.keys(TEAM_ALIASES).forEach(aliasNorm => add(TEAM_ALIASES[aliasNorm]));

    const qKey = canonicalTeamName(query);
    if (rep[qKey]) return rep[qKey];

    const candidates = Object.values(rep);
    return _bestMatch(query, candidates);
}

/* SEARCH */
async function searchPlayer(e, inputId = 'globalSearch') {
    if (e.key !== 'Enter') return;
    const el = document.getElementById(inputId);
    if (!el) return;
    const query = el.value.trim();
    if (!query) return;

    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    const playerCandidates = [];
    ['PREM', 'LALIGA', 'MLS'].forEach(lg => {
        const players = statsData[lg].players ? Object.values(statsData[lg].players) : [];
        players.forEach(p => {
            if (p && p.key && p.name) playerCandidates.push({ key: p.key, name: p.name, team: p.team || '' });
        });
    });

    const matchedPlayer = _bestFuzzyPlayerMatch(query, playerCandidates);
    if (matchedPlayer) {
        viewPlayer(matchedPlayer.key);
        return;
    }

    const matchedTeam = _resolveTeamFromQuery(query);
    if (matchedTeam) {
        viewTeam(matchedTeam, _findTeamLeague(matchedTeam));
        return;
    }

    viewPlayer(query);
}

function getPlayerInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

/* STATS LOADING */
function ensurePlayerForEntry(entry){
    if (!entry) return '';
    const league = entry.league || entry.League || entry.LEAGUE || '';
    const team = entry.team || entry.Team || entry.TEAM || entry['Team Name'] || '';
    const name = entry.name || entry.Name || entry.Player || entry['Player Name'] || '';
    return _makePlayerKey(league || '', team || '', name || '');
}

function _buildTeamPlayerIndex(playersMap){
    const index = {};
    Object.values(playersMap || {}).forEach(p=>{
        const tk = canonicalTeamName(p.team);
        if (!index[tk]) index[tk] = [];
        index[tk].push(p);
    });
    return index;
}

async function loadStats(league){
    if (statsData[league] && statsData[league].loaded) return;

    const src = STATS_URLS[league];
    if (!src) { statsData[league] = { loaded:true, goals:[], assists:[], cleanSheets:[], ratings:[], players:{} }; return; }

    try {
        const [goalsRows, assistsRows, csRows, avgRows] = await Promise.all([
            parseCsv(src.goals, true),
            parseCsv(src.assists, true),
            parseCsv(src.cleanSheets, true),
            parseCsv(src.avgRatings, true)
        ]);

        const data = {
            goals: [],
            assists: [],
            cleanSheets: [],
            ratings: [],
            players: {}
        };

        (avgRows || []).forEach(r=>{
            const name = (r.Player || r.Name || r['Player Name'] || r['Player'] || '').toString().trim();
            const team = (r.Team || r.Club || r['Team'] || '').toString().trim();
            const pos = (r.Position || r.Pos || r['POS'] || '').toString().trim();
            const rating = parseFloat(r.Rating || r.Avg || r['Avg Rating'] || r['Average Rating'] || '');
            const apps = parseInt(r.Apps || r.Appearances || r.Matches || r['MP'] || r['Appearances'] || '', 10);

            if (!name) return;

            const key = _makePlayerKey(league, team, name);
            data.players[key] = {
                key,
                league,
                name,
                team,
                position: pos,
                avgRating: Number.isNaN(rating) ? null : rating,
                matches: Number.isNaN(apps) ? 0 : apps,
                goals: 0,
                assists: 0,
                cs: 0,
                photoUrl: r.Photo || r.PhotoUrl || r.photoUrl || ''
            };
        });

        (goalsRows || []).forEach(r=>{
            const name = (r['Player Name'] || r.Player || r.Name || r['player name'] || r['PLAYER'] || '').toString().trim();
            const goals = parseInt(r.Goals || r.goals || r.Value || r.value || r['Goals'] || '', 10);
            const team = (r.Team || r['Team Name'] || r.team || r['Club'] || '').toString().trim();
            if (!name) return;
            const key = _makePlayerKey(league, team, name);
            if (!data.players[key]) {
                data.players[key] = { key, league, name, team, position:'', avgRating:null, matches:0, goals:0, assists:0, cs:0, photoUrl:'' };
            }
            data.players[key].goals = Number.isNaN(goals) ? 0 : goals;
            data.goals.push({ league, team, name, value: data.players[key].goals, key });
        });

        (assistsRows || []).forEach(r=>{
            const name = (r['Player Name'] || r.Player || r.Name || '').toString().trim();
            const assists = parseInt(r.Assists || r.assists || r.Value || r.value || '', 10);
            const team = (r.Team || r['Team Name'] || r.team || '').toString().trim();
            if (!name) return;
            const key = _makePlayerKey(league, team, name);
            if (!data.players[key]) {
                data.players[key] = { key, league, name, team, position:'', avgRating:null, matches:0, goals:0, assists:0, cs:0, photoUrl:'' };
            }
            data.players[key].assists = Number.isNaN(assists) ? 0 : assists;
            data.assists.push({ league, team, name, value: data.players[key].assists, key });
        });

        (csRows || []).forEach(r=>{
            const name = (r['Player Name'] || r.Player || r.Name || '').toString().trim();
            const cs = parseInt(r['Clean Sheets'] || r.CS || r.Value || r.value || '', 10);
            const team = (r.Team || r['Team Name'] || r.team || '').toString().trim();
            if (!name) return;
            const key = _makePlayerKey(league, team, name);
            if (!data.players[key]) {
                data.players[key] = { key, league, name, team, position:'', avgRating:null, matches:0, goals:0, assists:0, cs:0, photoUrl:'' };
            }
            data.players[key].cs = Number.isNaN(cs) ? 0 : cs;
            data.cleanSheets.push({ league, team, name, value: data.players[key].cs, key });
        });

        statsData[league] = { ...data, loaded: true };
    } catch (e) {
        statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
    }
}

/* STATS PAGE */
async function showStats(league){
    switchTab('stats');

    document.getElementById('stats-prem').classList.remove('active-league');
    document.getElementById('stats-laliga').classList.remove('active-league');
    document.getElementById('stats-mls').classList.remove('active-league');
    document.getElementById('stats-combined').classList.remove('active-league');

    if (league === 'PREM') document.getElementById('stats-prem').classList.add('active-league');
    if (league === 'LALIGA') document.getElementById('stats-laliga').classList.add('active-league');
    if (league === 'MLS') document.getElementById('stats-mls').classList.add('active-league');
    if (league === 'COMBINED') document.getElementById('stats-combined').classList.add('active-league');

    const content = document.getElementById('statsContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading stats...</div>';

    if (league === 'COMBINED') {
        await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

        const combined = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {} };
        ['PREM', 'LALIGA', 'MLS'].forEach(lg => {
            if (!statsData[lg] || !statsData[lg].loaded) return;
            combined.goals.push(...statsData[lg].goals);
            combined.assists.push(...statsData[lg].assists);
            combined.cleanSheets.push(...statsData[lg].cleanSheets);
            combined.ratings.push(...statsData[lg].ratings);
        });
        combined.goals.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.assists.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.cleanSheets.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.ratings.sort((a, b) => parseFloat(b.value) - parseFloat(a.value));
        renderStatsView(combined, 'COMBINED');
        return;
    }

    await loadStats(league);
    renderStatsView(statsData[league], league);
}

function renderStatsView(data, league){
    const content = document.getElementById('statsContent');
    const players = data.players ? Object.values(data.players) : [];
    const goals = (data.goals || []).slice().sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,15);
    const assists = (data.assists || []).slice().sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,15);

    const ratingsList = players
        .filter(p => p.avgRating != null && !Number.isNaN(Number(p.avgRating)))
        .map(p => ({ name:p.name, team:p.team, key:p.key, value:Number(p.avgRating), matches:p.matches || 0 }))
        .sort((a,b)=> b.value - a.value)
        .slice(0,15);

    const showCS = (league !== 'COMBINED'); // keep as you had it
    const cs = (data.cleanSheets || []).slice().sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,15);

    content.innerHTML = `
        <div class="stat-card mb-4">
            <div class="text-xs font-black text-zinc-400 mb-3">GOALS LEADERS (${league})</div>
            <div class="flex flex-col gap-2">
                ${goals.map((p,i)=>`
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-500 font-black w-4">${i+1}</span>
                            <div class="flex flex-col leading-tight">
                                <span class="font-black cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${p.key}')">${p.name}</span>
                                <span class="text-zinc-500 text-[10px]">${p.team}</span>
                            </div>
                        </div>
                        <span class="text-[#00ff85] font-black">${p.value || 0}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="stat-card mb-4">
            <div class="text-xs font-black text-zinc-400 mb-3">ASSISTS LEADERS (${league})</div>
            <div class="flex flex-col gap-2">
                ${assists.map((p,i)=>`
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-500 font-black w-4">${i+1}</span>
                            <div class="flex flex-col leading-tight">
                                <span class="font-black cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${p.key}')">${p.name}</span>
                                <span class="text-zinc-500 text-[10px]">${p.team}</span>
                            </div>
                        </div>
                        <span class="text-[#00ff85] font-black">${p.value || 0}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="stat-card mb-4">
            <div class="text-xs font-black text-zinc-400 mb-3">RATING LEADERS (${league})</div>
            <div class="flex flex-col gap-2">
                ${ratingsList.map((p,i)=>`
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-500 font-black w-4">${i+1}</span>
                            <div class="flex flex-col leading-tight">
                                <span class="font-black cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${p.key}')">${p.name}</span>
                                <span class="text-zinc-500 text-[10px]">${p.team} ‚Ä¢ ${p.matches || 0} apps</span>
                            </div>
                        </div>
                        <span class="text-[#00ff85] font-black">${parseFloat(p.value).toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        ${showCS ? `
        <div class="stat-card">
            <div class="text-xs font-black text-zinc-400 mb-3">CLEAN SHEETS (${league})</div>
            <div class="flex flex-col gap-2">
                ${cs.map((p,i)=>`
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-500 font-black w-4">${i+1}</span>
                            <div class="flex flex-col leading-tight">
                                <span class="font-black cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${p.key}')">${p.name}</span>
                                <span class="text-zinc-500 text-[10px]">${p.team}</span>
                            </div>
                        </div>
                        <span class="text-[#00ff85] font-black">${p.value || 0}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ``}
    `;
}

/* STANDINGS PAGE */
async function showStandings(league){
    switchTab('standings');

    document.getElementById('standings-prem').classList.remove('active-league');
    document.getElementById('standings-laliga').classList.remove('active-league');
    document.getElementById('standings-mls').classList.remove('active-league');

    if (league === 'PREM') document.getElementById('standings-prem').classList.add('active-league');
    if (league === 'LALIGA') document.getElementById('standings-laliga').classList.add('active-league');
    if (league === 'MLS') document.getElementById('standings-mls').classList.add('active-league');

    const content = document.getElementById('standingsContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading standings...</div>';

    const standings = await loadStandingsCache(league);
    const rows = Object.values(standings || {}).sort((a,b)=>parseInt(a.pos||999)-parseInt(b.pos||999));

    content.innerHTML = `
        <div class="stat-card">
            <div class="flex flex-col gap-3">
                ${rows.map(r=>{
                    const posNum = parseInt(r.pos||'');
                    let indicator = '';
                    if (league === 'PREM' || league === 'LALIGA'){
                        if (posNum >= 1 && posNum <= 4) indicator = 'bg-green-500';
                        else if (posNum === 5) indicator = 'bg-blue-500';
                        else if (posNum === 6) indicator = 'bg-green-900';
                        else if (posNum === 18) indicator = 'bg-yellow-400';
                        else if (posNum >= 19 && posNum <= 20) indicator = 'bg-red-500';
                    } else if (league === 'MLS'){
                        if (posNum >= 1 && posNum <= 9) indicator = 'bg-green-500';
                        else if (posNum === 10) indicator = 'bg-yellow-400';
                        else if (posNum >= 11 && posNum <= 15) indicator = 'bg-blue-500';
                        else if (posNum >= 18 && posNum <= 18) indicator = 'bg-yellow-400';
                        else if (posNum >= 19 && posNum <= 20) indicator = 'bg-red-500';
                    }

                    return `
                        <div class="flex items-center gap-3 cursor-pointer hover:opacity-90" onclick="viewTeam('${r.team}', '${league}')">
                            <div class="qualify-indicator ${indicator}"></div>
                            <div class="flex items-center gap-2 flex-1">
                                <img class="team-logo" src="${getLogo(r.team)}">
                                <div class="flex flex-col leading-tight">
                                    <span class="text-xs font-black text-zinc-500">#${r.pos}</span>
                                    <span class="team-name">${r.team}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-zinc-400">${r['wdl'] || r.wdl || ''}</div>
                                <div class="text-sm font-black text-[#00ff85]">${r.pts || ''}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

/* TEAM PAGE */
function _teamLeaders(players){
    const valid = (players || []).slice();
    const goalsSorted = valid.slice().sort((a,b)=> (b.goals||0)-(a.goals||0));
    const assistsSorted = valid.slice().sort((a,b)=> (b.assists||0)-(a.assists||0));
    const ratingSorted = valid.slice().filter(p=>p.avgRating!=null && !Number.isNaN(Number(p.avgRating)))
        .sort((a,b)=> Number(b.avgRating)-Number(a.avgRating));
    return {
        goals: goalsSorted[0] || null,
        assists: assistsSorted[0] || null,
        rating: ratingSorted[0] || null
    };
}

async function viewTeam(teamName, league){
    document.getElementById('team-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    const content = document.getElementById('teamContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading team...</div>';

    await loadStats(league);

    const teamKey = canonicalTeamName(teamName);
    const standings = await loadStandingsCache(league);
    const st = standings[teamKey];

    const players = Object.values(statsData[league].players || {}).filter(p => canonicalTeamName(p.team) === teamKey);
    currentTeamPlayersList = players;
    currentTeamLeague = league;
    currentTeamName = teamName;

    const leaders = _teamLeaders(players);

    content.innerHTML = `
        <div class="stat-card mb-4">
            <div class="flex items-center gap-3">
                <img class="team-logo" src="${getLogo(teamName)}">
                <div class="flex flex-col leading-tight">
                    <div class="text-[10px] font-black text-zinc-500 uppercase">${league}</div>
                    <div class="text-xl font-black">${teamName}</div>
                    <div class="text-xs text-zinc-400">${st ? `#${st.pos} ‚Ä¢ ${st.wdl || ''} ‚Ä¢ ${st.pts || ''} pts` : ''}</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="leader-pill" onclick="showTeamLeaderboard('goals')">
                <div class="text-[10px] font-black text-zinc-500 uppercase mb-1">Goal Leader</div>
                <div class="text-xs font-black">${leaders.goals ? leaders.goals.name : '‚Äî'}</div>
                <div class="text-[10px] text-zinc-400">${leaders.goals ? `${leaders.goals.goals||0} goals` : ''}</div>
            </div>
            <div class="leader-pill" onclick="showTeamLeaderboard('assists')">
                <div class="text-[10px] font-black text-zinc-500 uppercase mb-1">Assist Leader</div>
                <div class="text-xs font-black">${leaders.assists ? leaders.assists.name : '‚Äî'}</div>
                <div class="text-[10px] text-zinc-400">${leaders.assists ? `${leaders.assists.assists||0} assists` : ''}</div>
            </div>
            <div class="leader-pill" onclick="showTeamLeaderboard('rating')">
                <div class="text-[10px] font-black text-zinc-500 uppercase mb-1">Rating Leader</div>
                <div class="text-xs font-black">${leaders.rating ? leaders.rating.name : '‚Äî'}</div>
                <div class="text-[10px] text-zinc-400">${leaders.rating ? `${_fmtRating(leaders.rating.avgRating)}` : ''}</div>
            </div>
        </div>

        <div class="stat-card mb-4">
            <div class="text-xs font-black text-zinc-400 mb-3">PLAYERS</div>
            <div class="flex flex-col gap-2">
                ${players
                    .slice()
                    .sort((a,b)=> a.name.localeCompare(b.name))
                    .map(p=>`
                    <div class="flex items-center justify-between cursor-pointer hover:opacity-90" onclick="viewPlayer('${p.key}')">
                        <div class="flex items-center gap-3">
                            <div class="player-avatar" style="width:42px;height:42px;font-size:16px;">${getPlayerInitials(p.name)}</div>
                            <div class="flex flex-col leading-tight">
                                <span class="font-black">${p.name}</span>
                                <span class="text-zinc-500 text-[10px]">${p.position || ''}</span>
                            </div>
                        </div>
                        <span class="text-[#00ff85] font-black">${p.avgRating!=null ? _fmtRating(p.avgRating) : '-'}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="stat-card hidden" id="teamLeaderboardBox"></div>
    `;

    switchTab('team');
}

function showTeamLeaderboard(type){
    const box = document.getElementById('teamLeaderboardBox');
    if (!box) return;

    const players = (currentTeamPlayersList || []).slice();
    let title = '';
    let list = [];

    if (type === 'goals'){
        title = 'GOALS LEADERBOARD';
        list = players.slice().sort((a,b)=>(b.goals||0)-(a.goals||0))
            .map(p=>({ name:p.name, team:p.team, value:(p.goals||0), key:p.key }));
    } else if (type === 'assists'){
        title = 'ASSISTS LEADERBOARD';
        list = players.slice().sort((a,b)=>(b.assists||0)-(a.assists||0))
            .map(p=>({ name:p.name, team:p.team, value:(p.assists||0), key:p.key }));
    } else {
        title = 'RATINGS LEADERBOARD';
        list = players.slice().filter(p=>p.avgRating!=null && !Number.isNaN(Number(p.avgRating)))
            .sort((a,b)=>Number(b.avgRating)-Number(a.avgRating))
            .map(p=>({ name:p.name, team:p.team, value:Number(p.avgRating), key:p.key }));
    }

    box.classList.remove('hidden');
    box.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <div class="text-xs font-black text-zinc-400">${title}</div>
            <button class="text-[10px] font-black text-zinc-500 hover:text-[#00ff85]" onclick="document.getElementById('teamLeaderboardBox').classList.add('hidden')">CLOSE</button>
        </div>
        <div class="flex flex-col gap-2">
            ${list.slice(0, 30).map((p,i)=>`
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-zinc-500 font-black w-4">${i+1}</span>
                        <span class="font-black cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${p.key}')">${p.name}</span>
                    </div>
                    <span class="text-[#00ff85] font-black">${type==='rating' ? _fmtRating(p.value) : (p.value||0)}</span>
                </div>
            `).join('')}
        </div>
    `;
}

/* PLAYER PAGE */
async function viewPlayer(playerKeyOrName) {
    document.getElementById('player-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('team-tab').classList.add('hidden');

    const content = document.getElementById('playerContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading player...</div>';

    const parts = _splitPlayerKey(playerKeyOrName);
    if (parts.league) await loadStats(parts.league);
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    let playerData = null;

    if (parts.league && statsData[parts.league].players && statsData[parts.league].players[playerKeyOrName]) {
        playerData = statsData[parts.league].players[playerKeyOrName];
    } else {
        for (const lg of ['PREM', 'LALIGA', 'MLS']) {
            const pool = statsData[lg].players || {};
            if (pool[playerKeyOrName]) { playerData = pool[playerKeyOrName]; break; }
        }
    }

    if (!playerData) {
        content.innerHTML = '<div class="text-center text-zinc-500 py-8">Player not found</div>';
        return;
    }

    const isGK = playerData.position && playerData.position.toLowerCase().includes('gk');
    const photoUrl = (playerData.photoUrl || '').toString().trim();

    content.innerHTML = `
        <div class="stat-card mb-4">
            <div class="flex items-center gap-4">
                ${photoUrl ? `<img src="${photoUrl}" class="player-avatar object-cover">` : `<div class="player-avatar">${getPlayerInitials(playerData.name)}</div>`}
                <div class="flex flex-col leading-tight">
                    <div class="text-xl font-black">${playerData.name}</div>
                    <div class="text-zinc-400 text-xs flex items-center gap-2">
                        <img src="${getLogo(playerData.team)}" class="w-4 h-4 object-contain">
                        <span class="font-bold">${playerData.team}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="stat-card text-center">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Goals</div>
                <div class="text-2xl font-black text-[#00ff85]">${playerData.goals || 0}</div>
            </div>
            <div class="stat-card text-center">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Assists</div>
                <div class="text-2xl font-black text-[#00ff85]">${playerData.assists || 0}</div>
            </div>
            <div class="stat-card text-center">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Games</div>
                <div class="text-2xl font-black text-[#00ff85]" id="appsValue">${playerData.matches || 0}</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="stat-card text-center">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Avg Rating</div>
                <div class="text-2xl font-black text-[#00ff85]">${playerData.avgRating != null ? _fmtRating(playerData.avgRating) : '-'}</div>
            </div>
            <div class="stat-card text-center ${isGK ? '' : 'hidden'}" id="csCard">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Clean Sheets</div>
                <div class="text-2xl font-black text-[#00ff85]">${playerData.cs || 0}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="text-xs font-black text-zinc-400 mb-3">LAST 5 MATCH RATINGS</div>
            <div id="last5Ratings"><div class="text-zinc-500">Loading...</div></div>
        </div>
    `;

    switchTab('player');
}

/* SEARCH AUTOFILL (your existing system) */
let __suggestTimer = null;
function queueSuggestions(inputId, boxId){
    if (__suggestTimer) clearTimeout(__suggestTimer);
    __suggestTimer = setTimeout(()=>{
        const el = document.getElementById(inputId);
        if (!el) return;
        showSearchSuggestions(el.value, inputId, boxId);
    }, 90);
}

let __searchIndex = null;
async function ensureSearchIndex(){
    if (__searchIndex) return __searchIndex;
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    const players = [];
    const teams = [];

    ['PREM','LALIGA','MLS'].forEach(lg=>{
        const pool = statsData[lg].players ? Object.values(statsData[lg].players) : [];
        pool.forEach(p=>{
            if (p && p.key && p.name) players.push({ type:'player', key:p.key, name:p.name, team:p.team||'' });
            if (p && p.team) teams.push(p.team);
        });
    });

    const uniqTeams = Array.from(new Set(teams.map(t=>t.trim()).filter(Boolean)))
        .map(t=>({ type:'team', name:t }));

    __searchIndex = { players, teams: uniqTeams };
    return __searchIndex;
}

function _jsEscapeSingle(s){ return (s||'').toString().replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

async function showSearchSuggestions(query, inputId, boxId) {
    const box = document.getElementById(boxId);
    const input = document.getElementById(inputId);
    if (!box || !input) return;

    const q = (query || '').trim();
    if (q.length < 1) { box.classList.add('hidden'); box.innerHTML=''; return; }

    await ensureSearchIndex();

    const qn = _normMatch(q);

    const pMatches = __searchIndex.players
        .filter(p => _normMatch(p.name).includes(qn))
        .slice(0, 8);

    const tMatches = __searchIndex.teams
        .filter(t => _normMatch(t.name).includes(qn))
        .slice(0, 6);

    const items = [...pMatches, ...tMatches].slice(0, 12);

    if (!items.length) { box.classList.add('hidden'); box.innerHTML=''; return; }

    box.innerHTML = items.map(item => {
        if (item.type === 'player') {
            return `<div class="search-suggestion" onclick="selectSuggestion('player','${_jsEscapeSingle(item.key)}','${_jsEscapeSingle(item.name)}','${inputId}','${boxId}')">
                <span class="text-[#00ff85] font-black">P</span>
                <div class="flex flex-col leading-tight">
                    <span class="font-bold">${item.name}</span>
                    <span class="text-zinc-500 text-[10px]">${item.team}</span>
                </div>
            </div>`;
        }
        return `<div class="search-suggestion" onclick="selectSuggestion('team','${_jsEscapeSingle(item.name)}','${_jsEscapeSingle(item.name)}','${inputId}','${boxId}')">
            <span class="text-[#00ff85] font-black">T</span>
            <div class="flex items-center gap-2">
                <img src="${getLogo(item.name)}" class="w-4 h-4 object-contain">
                <span class="font-bold">${item.name}</span>
            </div>
        </div>`;
    }).join('');

    box.classList.remove('hidden');
}

function selectSuggestion(type, value, displayName, inputId, boxId) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(boxId);
    if (input) input.value = displayName || value;
    if (box) { box.classList.add('hidden'); box.innerHTML=''; }

    if (type === 'player') viewPlayer(value);
    else viewTeam(value, _findTeamLeague(value));
}

document.addEventListener('click', (e) => {
    const box = document.getElementById('globalSearchSuggestions');
    const input = document.getElementById('globalSearch');
    if (!box || !input) return;
    if (box.contains(e.target) || input.contains(e.target)) return;
    box.classList.add('hidden');
});

/* ------------------ PLAYER PAGE: logos cleanup + appearances + last-5 ratings ------------------ */
async function lookupAppsFromAvgSheets(name){
    const leagues = Object.keys(window.STATS_URLS||{});
    for (const lg of leagues){
        const src = STATS_URLS[lg]||{}; if (!src.avgRatings) continue;
        const rows = await parseCsv(src.avgRatings, false);
        for (const row of rows){
            if (!Array.isArray(row)) continue;
            const n = (row[8]||'').trim(); // Column I = Player Name
            const apps = parseInt(row[5], 10); // Column F = Appearances
            if (!n || Number.isNaN(apps)) continue;
            if (n.toLowerCase() === name.toLowerCase()) return apps;
        }
    }
    return null;
}

async function getLast5FromRatingsLog(name){
    const leagues = Object.keys(window.STATS_URLS||{});
    for (const lg of leagues){
        const src = STATS_URLS[lg]||{}; if (!src.ratingsLog) continue;
        const rows = await parseCsv(src.ratingsLog, true);
        const list = [];
        rows.forEach(r=>{
            const n = r.Player || r.Name || r['Player Name'] || '';
            if (!n || n.trim().toLowerCase() !== name.toLowerCase()) return;
            const rating = parseFloat(r.Rating || r.Score || r['Match Rating'] || '');
            if (Number.isNaN(rating)) return;
            const date = r.Date || r.MatchDate || r.Round || r['Date'] || '';
            const opponent = r.Opponent || r.Opp || r['Opponent'] || '';
            list.push({ date, opponent, rating });
        });
        if (list.length) return list.slice(-5); // earliest->latest already in sheet order
    }
    return [];
}

function keepOnlyTeamLogo(container){
    const teamLine = Array.from(container.querySelectorAll('p, div, span')).find(el => el.querySelector && el.querySelector('img') && /team|fc|sc|united|city|cf|club/i.test((el.textContent||'')));
    const keep = teamLine ? teamLine.querySelector('img') : null;
    const allImgs = container.querySelectorAll('img');
    allImgs.forEach(img => {
        if (keep && img === keep) return;
        if (img.closest('.stat-card') || (img.width && img.width <= 64) || (img.height && img.height <= 64)) {
            img.classList.add('hide-team-logo');
        }
        const op = parseFloat(getComputedStyle(img).opacity||'1');
        if (op < 0.5) img.classList.add('hide-team-logo');
    });
}

function waitUntil(cond, fn, tries=0){
    if (cond()) return fn();
    if (tries > 40) return;
    setTimeout(()=>waitUntil(cond, fn, tries+1), 200);
}

function wrapViewPlayer(){
    if (window.__addonWrapped_v5b) return;
    if (typeof window.viewPlayer !== 'function'){ setTimeout(wrapViewPlayer, 500); return; }
    const _orig = window.viewPlayer;
    window.viewPlayer = function(playerKeyOrName){
        const ret = _orig.apply(this, arguments);
        (async ()=>{
            try{
                const content = document.getElementById('playerContent');
                if (!content) return;
                const playerName = (()=>{
                    const parts = _splitPlayerKey(playerKeyOrName);
                    if (parts && parts.name && parts.name !== playerKeyOrName) return parts.name;
                    const h = content.querySelector('div.text-xl.font-black');
                    return h ? h.textContent.trim() : (playerKeyOrName||'').toString();
                })();

                const container = content;
                keepOnlyTeamLogo(container);

                const isGK = /gk/i.test((content.textContent||''));
                const csCard = document.getElementById('csCard');
                if (csCard && !isGK) csCard.classList.add('hidden');

                // Fill appearances
                try {
                    const apps = await lookupAppsFromAvgSheets(playerName);
                    const appsEl = container.querySelector('#appsValue');
                    if (appsEl) appsEl.textContent = (apps!=null) ? apps : '0';
                } catch(e){}

                // Fill last 5 (UPDATED: colored pills + font)
                try {
                    const last5 = await getLast5FromRatingsLog(playerName);
                    const box = container.querySelector('#last5Ratings');
                    if (box){
                        if (!last5 || !last5.length) {
                            box.innerHTML = '<div class="text-zinc-500">No recent ratings</div>';
                        } else {
                            const items = last5.slice(-5).map(r => {
                                const raw = (r && r.rating != null) ? r.rating : NaN;
                                const val = Number.isNaN(Number(raw)) ? '‚Äî' : Number(raw).toFixed(2);
                                const cls = ratingClass(raw);
                                return '<div class="rating-pill ' + cls + '">' + val + '</div>';
                            }).join('');
                            box.innerHTML = '<div class="flex gap-2 flex-wrap">' + items + '</div>';
                        }
                    }
                } catch(e){}
            }catch(e){}
        })();
        return ret;
    };
    window.__addonWrapped_v5b = true;
}
wrapViewPlayer();

/* HUB (matches) minimal placeholders so file runs even if match CSV not wired here) */
function prevDate(){}
function nextDate(){}
function jumpToToday(){}

switchTab('hub');
</script>

</body>
</html>
