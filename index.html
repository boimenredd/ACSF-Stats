<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Football Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --accent: #00ff85;
            --bg: #0a0a0a;
        }
        body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; background: var(--bg); }
        .tabbar { background: rgba(10,10,10,.9); backdrop-filter: blur(10px); }
        .stat-card { background: rgba(24,24,27,.85); border: 1px solid rgba(39,39,42,.9); border-radius: 16px; padding: 16px; }
        .btn { border-radius: 999px; padding: 10px 14px; font-weight: 900; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-ghost { background: rgba(39,39,42,.75); color: #fff; border: 1px solid rgba(63,63,70,.7); }
        .active-league { background: var(--accent) !important; color: #000 !important; }
        .hidden { display: none !important; }
        .small-muted { color: #a1a1aa; font-size: 12px; }
        .mono { font-family: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .table-row { border-bottom: 1px solid rgba(39,39,42,.8); padding: 10px 0; }
        .table-row:last-child { border-bottom: none; }
        .pill { border: 1px solid rgba(63,63,70,.8); border-radius: 999px; padding: 2px 10px; font-size: 10px; color: #a1a1aa; }
        .pill-green { border-color: rgba(0,255,133,.35); color: var(--accent); }
        .pill-red { border-color: rgba(255,80,80,.35); color: #ff5a5a; }
        .player-avatar { width: 80px; height: 80px; border-radius: 999px; background: rgba(39,39,42,.9); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #fff; }
        .search-input { background: #1a1a1a; border: 1px solid rgba(63,63,70,.7); border-radius: 999px; padding: 10px 14px; width: 100%; color: #fff; font-size: 14px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .header-search-input { background: #1a1a1a; border: 1px solid rgba(63,63,70,.7); border-radius: 999px; padding: 8px 10px; color: #fff; width: 165px; font-size: 12px; }
        .search-suggestions {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            width: 280px;
            max-height: 320px;
            overflow: auto;
            background: rgba(24, 24, 27, 0.98);
            border: 1px solid #27272a;
            border-radius: 12px;
            z-index: 50;
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
            padding: 6px;
        }
        .search-suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 10px;
            cursor: pointer;
        }
        .search-suggestion-item:hover,
        .search-suggestion-item.active {
            background: rgba(39, 39, 42, 0.7);
        }
        .search-suggestion-meta {
            font-size: 10px;
            color: #a1a1aa;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .search-suggestion-pill {
            font-size: 10px;
            color: #a1a1aa;
            border: 1px solid #27272a;
            border-radius: 999px;
            padding: 2px 8px;
            white-space: nowrap;
        }
        .header-search-input:focus { outline: none; border-color: var(--accent); }
    </style>
</head>
<body class="text-white">

    <!-- Header -->
    <header class="p-4">
        <div class="flex items-center justify-between gap-3">
            <h1 class="text-xl font-black tracking-tight">FOOTBALL HUB</h1>
            <div class="relative">
                <input type="text" id="globalSearch" class="header-search-input" placeholder="Search teams or players..." autocomplete="off"
                    oninput="updateGlobalSearchSuggestions('globalSearch')"
                    onfocus="updateGlobalSearchSuggestions('globalSearch')"
                    onblur="hideGlobalSearchSuggestionsDelayed()"
                    onkeyup="globalSearchKeyup(event, 'globalSearch')">
                <div id="globalSearchSuggestions" class="search-suggestions hidden"></div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="p-4 pb-24">

        <!-- Hub -->
        <section id="hub-tab">
            <div class="space-y-6">
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-black text-[#00ff85]">NEXT MATCHES</h2>
                        <span class="pill">Auto</span>
                    </div>
                    <div id="nextMatches" class="space-y-3"></div>
                </div>

                <div class="stat-card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-black text-[#00ff85]">LATEST RESULTS</h2>
                        <span class="pill">Auto</span>
                    </div>
                    <div id="latestResults" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- Standings -->
        <section id="standings-tab" class="hidden">
            <div class="space-y-6">
                <div class="flex gap-2 flex-wrap">
                    <button class="btn btn-ghost active-league" id="stand-btn-PREM" onclick="renderStandings('PREM')">PREM</button>
                    <button class="btn btn-ghost" id="stand-btn-LALIGA" onclick="renderStandings('LALIGA')">LA LIGA</button>
                    <button class="btn btn-ghost" id="stand-btn-MLS" onclick="renderStandings('MLS')">MLS</button>
                </div>
                <div id="standingsContent"></div>
            </div>
        </section>

        <!-- Stats -->
        <section id="stats-tab" class="hidden">
            <div class="space-y-6">
                <div class="flex gap-2 flex-wrap">
                    <button class="btn btn-ghost active-league" id="stat-btn-COMBINED" onclick="renderStats('COMBINED')">COMBINED</button>
                    <button class="btn btn-ghost" id="stat-btn-PREM" onclick="renderStats('PREM')">PREM</button>
                    <button class="btn btn-ghost" id="stat-btn-LALIGA" onclick="renderStats('LALIGA')">LA LIGA</button>
                    <button class="btn btn-ghost" id="stat-btn-MLS" onclick="renderStats('MLS')">MLS</button>
                </div>
                <div id="statsContent"></div>
            </div>
        </section>

        <!-- Team -->
        <section id="team-tab" class="hidden">
            <div id="teamContent"></div>
        </section>

        <!-- Player -->
        <section id="player-tab" class="hidden">
            <div id="playerContent"></div>
        </section>

    </main>

    <!-- Tab Bar -->
    <nav class="tabbar fixed bottom-0 left-0 right-0 border-t border-zinc-800 px-4 py-3">
        <div class="flex items-center justify-between gap-2">
            <button class="btn btn-ghost flex-1" onclick="showTab('hub')">HUB</button>
            <button class="btn btn-ghost flex-1" onclick="showTab('standings')">STANDINGS</button>
            <button class="btn btn-ghost flex-1" onclick="showTab('stats')">STATS</button>
        </div>
    </nav>

<script>
/* =========================
   DATA SOURCES (Google Sheets CSV)
========================= */

const MATCHES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=0&single=true&output=csv';

const STANDINGS_URLS = {
    PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1875623411&single=true&output=csv',
    LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1875623411&single=true&output=csv',
    MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1875623411&single=true&output=csv'
};

const STATS_URLS = {
    PREM: {
        leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=929287509&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1110338530&single=true&output=csv',
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1226517331&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1309306837&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1717080780&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1756355722&single=true&output=csv'
    },
    LALIGA: {
        leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=929287509&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1110338530&single=true&output=csv',
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1226517331&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1309306837&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1717080780&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1756355722&single=true&output=csv'
    },
    MLS: {
        leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=929287509&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1110338530&single=true&output=csv',
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1226517331&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1309306837&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1717080780&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1756355722&single=true&output=csv'
    }
};

/* =========================
   TEAM LOGOS
========================= */

const LOGOS = {
    "Liverpool": "https://resources.premierleague.com/premierleague25/badges-alt/14.svg",
    "Newcastle": "https://resources.premierleague.com/premierleague25/badges-alt/4.svg",
    "Chelsea": "https://resources.premierleague.com/premierleague25/badges-alt/8.svg",
    "Aston Villa": "https://resources.premierleague.com/premierleague25/badges-alt/7.svg",
    "Man City": "https://resources.premierleague.com/premierleague25/badges-alt/43.svg",
    "Man United": "https://resources.premierleague.com/premierleague25/badges-alt/1.svg",
    "Arsenal": "https://resources.premierleague.com/premierleague25/badges-alt/3.svg",
    "Southampton": "https://upload.wikimedia.org/wikipedia/en/thumb/c/c9/FC_Southampton.svg/1051px-FC_Southampton.svg.png",
    "Bournemouth": "https://resources.premierleague.com/premierleague25/badges-alt/91.svg",
    "Leeds": "https://resources.premierleague.com/premierleague25/badges-alt/2.svg",
    "Brighton": "https://resources.premierleague.com/premierleague25/badges-alt/36.svg",
    "West Ham": "https://resources.premierleague.com/premierleague25/badges-alt/21.svg",
    "Brentford": "https://resources.premierleague.com/premierleague25/badges-alt/94.svg",
    "Tottenham": "https://resources.premierleague.com/premierleague25/badges-alt/6.svg",
    "Crystal Palace": "https://resources.premierleague.com/premierleague25/badges-alt/31.svg",
    "Leicester": "https://upload.wikimedia.org/wikipedia/en/thumb/2/2d/Leicester_City_crest.svg/1200px-Leicester_City_crest.svg.png",
    "Nott'm Forest": "https://resources.premierleague.com/premierleague25/badges-alt/17.svg",
    "Nottingham": "https://resources.premierleague.com/premierleague25/badges-alt/17.svg",
    "Sunderland": "https://resources.premierleague.com/premierleague25/badges-alt/56.svg",
    "Burnley": "https://resources.premierleague.com/premierleague25/badges-alt/90.svg",
    "Wolves": "https://resources.premierleague.com/premierleague25/badges-alt/39.svg",
    "Fulham": "https://resources.premierleague.com/premierleague25/badges-alt/54.svg",
    "Everton": "https://resources.premierleague.com/premierleague25/badges-alt/11.svg",
    "Ipswich": "https://resources.premierleague.com/premierleague25/badges-alt/40.svg",
    "Barcelona": "https://ssl.gstatic.com/onebox/media/sports/logos/paYnEE8hcrP96neHRNofhQ_48x48.png",
    "Real Madrid": "https://ssl.gstatic.com/onebox/media/sports/logos/Th4fAVAZeCJWRcKoLW7koA_48x48.png",
    "Sevilla": "https://ssl.gstatic.com/onebox/media/sports/logos/hCTs5EX3WjCMC5Jl3QE4Rw_48x48.png",
    "Real Sociedad": "https://ssl.gstatic.com/onebox/media/sports/logos/w8tb1aeBfVZIj9tZXf7eZg_48x48.png",
    "Girona": "https://ssl.gstatic.com/onebox/media/sports/logos/sHiSmLm_rA0BOC5MfrNt8A_48x48.png",
    "Atletico Madrid": "https://ssl.gstatic.com/onebox/media/sports/logos/pEqmA7CL-VRo4Llq3rwIPA_48x48.png",
    "Athletic Bilbao": "https://ssl.gstatic.com/onebox/media/sports/logos/OSL_5Zm6kYPP1J17Bo5uDA_48x48.png",
    "Athletic": "https://ssl.gstatic.com/onebox/media/sports/logos/OSL_5Zm6kYPP1J17Bo5uDA_48x48.png",
    "Elche": "https://ssl.gstatic.com/onebox/media/sports/logos/uyyqqxLIYT_lQIXRyMI_RA_48x48.png",
    "Osasuna": "https://ssl.gstatic.com/onebox/media/sports/logos/pk-hNCNpGM_JDoHHvLVF-Q_48x48.png",
    "Villarreal": "https://ssl.gstatic.com/onebox/media/sports/logos/WKH7Ak5cYD6Qm1EEqXzmVw_48x48.png",
    "Levante": "https://ssl.gstatic.com/onebox/media/sports/logos/SQB-jlVosxVV1Ce79FhbOA_48x48.png",
    "Las Palmas": "https://upload.wikimedia.org/wikipedia/sco/thumb/2/20/UD_Las_Palmas_logo.svg/1188px-UD_Las_Palmas_logo.svg.png",
    "Mallorca": "https://ssl.gstatic.com/onebox/media/sports/logos/Ss21P4CUmigjrEtcoapjVg_48x48.png",
    "Espanyol": "https://ssl.gstatic.com/onebox/media/sports/logos/TKitIqelDyN6M-kYt4Uc0g_48x48.png",
    "Valencia": "https://ssl.gstatic.com/onebox/media/sports/logos/QPbjvDwI_0Wuu4tCS2O6uw_48x48.png",
    "Real Betis": "https://ssl.gstatic.com/onebox/media/sports/logos/XDClkrMKtkm3UTP2YKN6oQ_48x48.png",
    "Betis": "https://ssl.gstatic.com/onebox/media/sports/logos/XDClkrMKtkm3UTP2YKN6oQ_48x48.png",
    "Oviedo": "https://ssl.gstatic.com/onebox/media/sports/logos/2hbZVQulcYqiPFXkWDkB_g_48x48.png",
    "Celta Vigo": "https://ssl.gstatic.com/onebox/media/sports/logos/wpdhixHP_sloegfP0UlwAw_48x48.png",
    "Celta": "https://ssl.gstatic.com/onebox/media/sports/logos/wpdhixHP_sloegfP0UlwAw_48x48.png",
    "Rayo Vallecano": "https://ssl.gstatic.com/onebox/media/sports/logos/i5LifmxEVIl0sbvIysiyhw_48x48.png",
    "Alaves": "https://ssl.gstatic.com/onebox/media/sports/logos/RUcTOeFcBc7q7uku1nR_iQ_48x48.png",
    "Getafe": "https://ssl.gstatic.com/onebox/media/sports/logos/KfkDhn99TYUcNr8aBaLjqA_48x48.png",
    "Leganes": "https://ssl.gstatic.com/onebox/media/sports/logos/WM1T3GdEWT_BvbUQ0UInaw_48x48.png",
    "Valladolid": "https://ssl.gstatic.com/onebox/media/sports/logos/fsE7yqRo-8qLhH4dqKBMNg_48x48.png",
    "Miami": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755405/assets/logos/mls-clubs/Club_Logo-Miami_tyqe64.png",
    "LAFC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v174775309/assets/logos/mls-clubs/Club_Logo-LAFC_djrhru.png",
    "Atlanta": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747499879/assets/logos/mls-clubs/Club_Logo-Atlanta_jtk7ku.png",
    "Toronto": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265251/assets/logos/mls-clubs/Club_Logo-Toronto_vz6hao.png",
    "San Diego": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748261519/assets/logos/mls-clubs/Club_Logo-San_Diego_nwpyul.png",
    "Orlando": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747769281/assets/logos/mls-clubs/Club_Logo-Orlando_ryyn7a.png",
    "Houston": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500939/assets/logos/mls-clubs/Club_Logo-Houston_oifm77.png",
    "Charlotte": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500045/assets/logos/mls-clubs/Club_Logo-Charlotte_p7sznf.png",
    "Salt Lake": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747776403/assets/logos/mls-clubs/Club_Logo-Salt_Lake_City_hpvde5.png",
    "Vancouver": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265547/assets/logos/mls-clubs/Club_Logo-Vancouver_ao9phl.png",
    "LA Galaxy": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755165/assets/logos/mls-clubs/Club_Logo-LA_Galaxy_fg0wjp.png",
    "Seattle": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265125/assets/logos/mls-clubs/Club_Logo-Seattle_e6jk2x.png",
    "Columbus": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500414/assets/logos/mls-clubs/Club_Logo-Columbus_light_z3eq8l.png",
    "Montreal": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755806/assets/logos/mls-clubs/Club_Logo-Montreal_beeqnh.png",
    "San Jose": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748262048/assets/logos/mls-clubs/Club_Logo-San_Jose_opzlmo.png",
    "NY Red Bulls": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747771783/assets/logos/mls-clubs/Club_Logo-RBNY_dwawvt.png",
    "Colorado": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500322/assets/logos/mls-clubs/Club_Logo-Colorado_n5kpss.png",
    "New England": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1766020750/assets/NE_Logo_PRI_FC_RGB_480x480_fdx2us.png",
    "Minnesota": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747754826/assets/logos/mls-clubs/Club_Logo-Minnesota_ftweor.png",
    "Chicago": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500178/assets/logos/mls-clubs/Club_Logo-Chicago_jm2yev.png",
    "Portland": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747771943/assets/logos/mls-clubs/Club_Logo-Portland_jrihbf.png",
    "Nashville": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747754937/assets/logos/mls-clubs/Club_Logo-Nashville_owcihx.png",
    "Austin": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500115/assets/logos/mls-clubs/Club_Logo-Austin_u0tpqe.png",
    "FC Dallas": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500587/assets/logos/mls-clubs/Club_Logo-Dallas_oxywdo.png",
    "Dallas": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500587/assets/logos/mls-clubs/Club_Logo-Dallas_oxywdo.png",
    "St Louis": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265198/assets/logos/mls-clubs/Club_Logo-St._Louis_oikgm5.png",
    "NYCFC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755975/assets/logos/mls-clubs/Club_Logo-NYC_vhnmkv.png",
    "Philadelphia": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747772038/assets/logos/mls-clubs/Club_Logo-Philadelphia_l8yj9f.png",
    "Sporting KC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265350/assets/logos/mls-clubs/Club_Logo-Sporting_Kansas_City_rrkzdb.png",
    "DC United": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500514/assets/logos/mls-clubs/Club_Logo-DC_United_igj4qy.png",
    "Cincinnati": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500252/assets/logos/mls-clubs/Club_Logo-Cincinatti_ohmgcp.png"
};

/* =========================
   TEAM ALIASES (expanded)
========================= */

const TEAM_ALIASES = {
    // Prem examples / common
    "manchesterunited": "Man United",
    "manunited": "Man United",
    "manutd": "Man United",
    "united": "Man United",
    "manchester city": "Man City",
    "manchestercity": "Man City",
    "mancity": "Man City",
    "city": "Man City",
    "nottinghamforest": "Nott'm Forest",
    "nottmforest": "Nott'm Forest",
    "nottm": "Nott'm Forest",
    "forest": "Nott'm Forest",
    "tottenhamhotspur": "Tottenham",
    "spurs": "Tottenham",
    "leedsunited": "Leeds",
    "newcastleunited": "Newcastle",
    "westhamunited": "West Ham",

    // La Liga common
    "atletico": "Atletico Madrid",
    "atleticomadrid": "Atletico Madrid",
    "real sociedad": "Real Sociedad",
    "realsociedad": "Real Sociedad",
    "athletic club": "Athletic Bilbao",
    "athleticclub": "Athletic Bilbao",
    "bilbao": "Athletic Bilbao",
    "real betis": "Real Betis",
    "realbetis": "Real Betis",
    "celta de vigo": "Celta Vigo",
    "celtadevigo": "Celta Vigo",
    "barca": "Barcelona",
    "rmadrid": "Real Madrid",
    "realmadrid": "Real Madrid",
    "oviedo": "Oviedo",
    "realoviedo": "Oviedo",

    // MLS common (expanded)
    "intermiami": "Miami",
    "miamicf": "Miami",
    "lafc": "LAFC",
    "losangelesfc": "LAFC",
    "lagalaxy": "LA Galaxy",
    "losangelesgalaxy": "LA Galaxy",
    "nycfc": "NYCFC",
    "newyorkcityfc": "NYCFC",
    "newyorkredbulls": "NY Red Bulls",
    "rbny": "NY Red Bulls",
    "sportingkansascity": "Sporting KC",
    "kansascity": "Sporting KC",
    "dcu": "DC United",
    "dcunited": "DC United",
    "fcdallas": "FC Dallas",
    "stlouis": "St Louis",
    "stlouiscity": "St Louis",
    "stlouiscity": "St Louis",
    "newenglandrevolution": "New England",
    "revs": "New England",
    "montrealimpact": "Montreal"
};

function _normMatch(s) {
    return (s || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');
}

function canonicalTeamName(name) {
    const raw = (name || '').toString().trim();
    if (!raw) return raw;
    const norm = _normMatch(raw);
    if (TEAM_ALIASES[norm]) return TEAM_ALIASES[norm];
    return raw;
}

function getLogo(teamName) {
    const t = canonicalTeamName(teamName);
    if (LOGOS[t]) return LOGOS[t];
    return 'https://via.placeholder.com/24/111/fff?text=?';
}

function showTab(tab) {
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('team-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    if (tab === 'hub') document.getElementById('hub-tab').classList.remove('hidden');
    if (tab === 'standings') document.getElementById('standings-tab').classList.remove('hidden');
    if (tab === 'stats') document.getElementById('stats-tab').classList.remove('hidden');
}

let allMatches = [];
let standingsData = { PREM: [], LALIGA: [], MLS: [] };
let statsData = {
    PREM: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false },
    LALIGA: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false },
    MLS: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false }
};

/* =========================
   MATCHES PARSING
========================= */

function parseDateString(s) {
    const v = (s || '').toString().trim();
    if (!v) return null;
    const d = new Date(v);
    if (!isNaN(d.getTime())) return d;
    return null;
}

function parseMatchRow(row, currentMatchday, currentDate) {
    const md = row[0] ? row[0].toString().trim() : '';
    const dateCell = row[1] ? row[1].toString().trim() : '';
    const home = row[2] ? row[2].toString().trim() : '';
    const away = row[3] ? row[3].toString().trim() : '';
    const league = row[4] ? row[4].toString().trim() : '';
    const score = row[5] ? row[5].toString().trim() : '';
    const status = row[6] ? row[6].toString().trim() : '';

    let newMatchday = currentMatchday;
    let newDate = currentDate;

    // new date starts when a new matchday is listed; date is in the row below it
    if (md && /^\d+/.test(md)) {
        newMatchday = md;
        // date is determined by the row below; handled in loadMatches by lookahead
    }

    // If a date cell exists on its own row, update date
    if (dateCell && parseDateString(dateCell)) {
        newDate = parseDateString(dateCell);
    }

    if (!home || !away || !league) {
        return { match: null, matchday: newMatchday, date: newDate };
    }

    const match = {
        matchday: newMatchday,
        date: newDate,
        home: canonicalTeamName(home),
        away: canonicalTeamName(away),
        league,
        score,
        status
    };
    return { match, matchday: newMatchday, date: newDate };
}

async function loadMatches() {
    const rows = await new Promise((resolve) => {
        Papa.parse(MATCHES_URL, {
            download: true,
            complete: (r) => resolve(r.data),
            error: () => resolve([])
        });
    });

    let currentMatchday = '';
    let currentDate = null;
    const out = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i] || [];

        // If this row starts a new matchday, date is in the row below it (even if this row also has a game)
        const md = row[0] ? row[0].toString().trim() : '';
        if (md && /^\d+/.test(md)) {
            currentMatchday = md;
            const nextRow = rows[i + 1] || [];
            const nextDateCell = nextRow[1] ? nextRow[1].toString().trim() : '';
            const nextDate = parseDateString(nextDateCell);
            if (nextDate) currentDate = nextDate;
        }

        const parsed = parseMatchRow(row, currentMatchday, currentDate);
        currentMatchday = parsed.matchday;
        currentDate = parsed.date;

        if (parsed.match) out.push(parsed.match);
    }

    allMatches = out;
}

/* =========================
   HUB RENDER
========================= */

function renderHub() {
    const now = new Date();
    const upcoming = allMatches
        .filter(m => !m.score && m.date && m.date >= now)
        .sort((a, b) => a.date - b.date)
        .slice(0, 6);

    const latest = allMatches
        .filter(m => m.score && m.date)
        .sort((a, b) => b.date - a.date)
        .slice(0, 6);

    const nextEl = document.getElementById('nextMatches');
    const latestEl = document.getElementById('latestResults');

    nextEl.innerHTML = upcoming.length ? upcoming.map(m => `
        <div class="flex items-center justify-between bg-zinc-900/50 rounded-xl p-3">
            <div>
                <div class="font-black text-sm">${m.home} vs ${m.away}</div>
                <div class="small-muted">${m.league} • ${m.matchday ? `MD ${m.matchday}` : ''} • ${m.date ? m.date.toLocaleDateString() : ''}</div>
            </div>
            <div class="flex gap-2">
                <img src="${getLogo(m.home)}" class="w-6 h-6 object-contain">
                <img src="${getLogo(m.away)}" class="w-6 h-6 object-contain">
            </div>
        </div>
    `).join('') : `<div class="small-muted">No upcoming matches found.</div>`;

    latestEl.innerHTML = latest.length ? latest.map(m => `
        <div class="flex items-center justify-between bg-zinc-900/50 rounded-xl p-3">
            <div>
                <div class="font-black text-sm">${m.home} ${m.score} ${m.away}</div>
                <div class="small-muted">${m.league} • ${m.matchday ? `MD ${m.matchday}` : ''} • ${m.date ? m.date.toLocaleDateString() : ''}</div>
            </div>
            <div class="flex gap-2">
                <img src="${getLogo(m.home)}" class="w-6 h-6 object-contain">
                <img src="${getLogo(m.away)}" class="w-6 h-6 object-contain">
            </div>
        </div>
    `).join('') : `<div class="small-muted">No recent results found.</div>`;
}

/* =========================
   STANDINGS
========================= */

async function loadStandings(league) {
    if (standingsData[league] && standingsData[league].length) return;

    const url = STANDINGS_URLS[league];
    const rows = await new Promise((resolve) => {
        Papa.parse(url, {
            download: true,
            complete: (r) => resolve(r.data),
            error: () => resolve([])
        });
    });

    const out = [];
    rows.forEach((row, i) => {
        if (i === 0) return;
        if (!row[0]) return;
        out.push({
            pos: row[0],
            team: canonicalTeamName(row[1]),
            played: row[2],
            wins: row[3],
            draws: row[4],
            losses: row[5],
            gf: row[6],
            ga: row[7],
            gd: row[8],
            pts: row[9]
        });
    });

    standingsData[league] = out;
}

function renderStandings(league) {
    document.querySelectorAll('[id^="stand-btn-"]').forEach(b => b.classList.remove('active-league'));
    document.getElementById(`stand-btn-${league}`).classList.add('active-league');

    const content = document.getElementById('standingsContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading standings...</div>';

    loadStandings(league).then(() => {
        const data = standingsData[league] || [];
        if (!data.length) {
            content.innerHTML = '<div class="text-center text-zinc-500 py-8">No standings available</div>';
            return;
        }

        const getIndicator = (pos) => {
            const p = parseInt(pos, 10);

            if (league === 'PREM' || league === 'LALIGA') {
                if (p <= 4) return { color: '#00ff85', label: 'UCL' };
                if (p === 5) return { color: '#00bfff', label: 'UEL' };
                if (p === 6) return { color: '#0b5d3b', label: 'UECL' };
                if (p >= 18) return { color: '#ff5a5a', label: 'REL' };
            }

            if (league === 'MLS') {
                if (p <= 7) return { color: '#00ff85', label: 'PLAYOFF' };
                if (p >= 19) return { color: '#ff5a5a', label: 'REL' };
                if (p === 18) return { color: '#fbbf24', label: 'REL PO' };
            }

            return null;
        };

        const legend = [];
        if (league === 'PREM' || league === 'LALIGA') {
            legend.push({ color: '#00ff85', text: 'UCL Spots (1-4)' });
            legend.push({ color: '#00bfff', text: 'Europa League (5)' });
            legend.push({ color: '#0b5d3b', text: 'Conference League (6)' });
            legend.push({ color: '#ff5a5a', text: 'Relegation (18-20)' });
        }
        if (league === 'MLS') {
            legend.push({ color: '#00ff85', text: 'Playoff (1-7)' });
            legend.push({ color: '#fbbf24', text: 'Relegation Playoff (18)' });
            legend.push({ color: '#ff5a5a', text: 'Relegation (19-20)' });
        }

        content.innerHTML = `
            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">TABLE</h3>
                <div class="grid grid-cols-12 gap-2 text-[10px] text-zinc-500 pb-2 border-b border-zinc-800">
                    <div class="col-span-1">#</div>
                    <div class="col-span-5">TEAM</div>
                    <div class="col-span-1 text-center">P</div>
                    <div class="col-span-1 text-center">W</div>
                    <div class="col-span-1 text-center">D</div>
                    <div class="col-span-1 text-center">L</div>
                    <div class="col-span-1 text-center">GD</div>
                    <div class="col-span-1 text-center">PTS</div>
                </div>
                ${data.map(r => {
                    const ind = getIndicator(r.pos);
                    return `
                        <div class="grid grid-cols-12 gap-2 items-center py-2 border-b border-zinc-800/60 last:border-b-0 cursor-pointer hover:bg-zinc-900/50 rounded-lg px-1"
                             onclick="viewTeam('${_jsEscapeSingle(r.team)}', '${league}')">
                            <div class="col-span-1 mono text-zinc-500">${r.pos}</div>
                            <div class="col-span-5 flex items-center gap-2">
                                ${ind ? `<span class="w-2 h-2 rounded-full" style="background:${ind.color}"></span>` : `<span class="w-2 h-2 rounded-full bg-zinc-800"></span>`}
                                <img src="${getLogo(r.team)}" class="w-4 h-4 object-contain">
                                <span class="font-bold text-sm">${r.team}</span>
                            </div>
                            <div class="col-span-1 text-center mono">${r.played}</div>
                            <div class="col-span-1 text-center mono">${r.wins}</div>
                            <div class="col-span-1 text-center mono">${r.draws}</div>
                            <div class="col-span-1 text-center mono">${r.losses}</div>
                            <div class="col-span-1 text-center mono">${r.gd}</div>
                            <div class="col-span-1 text-center mono font-black text-[#00ff85]">${r.pts}</div>
                        </div>
                    `;
                }).join('')}
                <div class="mt-4 pt-3 border-t border-zinc-800 space-y-2">
                    ${legend.map(l => `
                        <div class="flex items-center gap-2 text-[11px] text-zinc-400">
                            <span class="w-2.5 h-2.5 rounded-full" style="background:${l.color}"></span>
                            <span>${l.text}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
}

/* =========================
   TEAM PAGE
========================= */

function _findTeamLeague(team) {
    const t = canonicalTeamName(team);
    const inMatches = allMatches.find(m => canonicalTeamName(m.home) === t || canonicalTeamName(m.away) === t);
    if (inMatches) return inMatches.league === 'Prem' ? 'PREM' : (inMatches.league === 'La Liga' ? 'LALIGA' : 'MLS');
    // fallback try standings
    const inStand = ['PREM','LALIGA','MLS'].find(lg => (standingsData[lg] || []).some(r => canonicalTeamName(r.team) === t));
    if (inStand) return inStand;
    return 'PREM';
}

function _getTeamStanding(team, league) {
    const t = canonicalTeamName(team);
    const rows = standingsData[league] || [];
    const found = rows.find(r => canonicalTeamName(r.team) === t);
    return found ? found.pos : '';
}

async function viewTeam(teamName, league) {
    const team = canonicalTeamName(teamName);

    document.getElementById('team-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    const content = document.getElementById('teamContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading team...</div>';

    await loadStandings(league);

    const standing = _getTeamStanding(team, league);

    const matches = allMatches.filter(m => canonicalTeamName(m.home) === team || canonicalTeamName(m.away) === team)
        .sort((a, b) => (a.date || 0) - (b.date || 0));

    const played = matches.filter(m => m.score);
    const upcoming = matches.filter(m => !m.score && m.date && m.date >= new Date()).slice(0, 6);
    const recent = played.slice(-6).reverse();

    // roster from stats sheets (best-effort)
    await loadStats(league);
    const roster = Object.values(statsData[league].players || {}).filter(p => canonicalTeamName(p.team) === team);

    content.innerHTML = `
        <div class="space-y-6">
            <div class="stat-card">
                <div class="flex items-center gap-3">
                    <img src="${getLogo(team)}" class="w-10 h-10 object-contain">
                    <div>
                        <h2 class="text-2xl font-black">${team}</h2>
                        <div class="small-muted">${league}${standing ? ` • Standing: ${standing}` : ''}</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">UPCOMING</h3>
                ${upcoming.length ? upcoming.map(m => `
                    <div class="flex items-center justify-between bg-zinc-900/50 rounded-xl p-3">
                        <div>
                            <div class="font-black text-sm">${m.home} vs ${m.away}</div>
                            <div class="small-muted">${m.matchday ? `MD ${m.matchday}` : ''} • ${m.date ? m.date.toLocaleDateString() : ''}</div>
                        </div>
                        <div class="flex gap-2">
                            <img src="${getLogo(m.home)}" class="w-6 h-6 object-contain">
                            <img src="${getLogo(m.away)}" class="w-6 h-6 object-contain">
                        </div>
                    </div>
                `).join('') : `<div class="small-muted">No upcoming matches.</div>`}
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">RECENT RESULTS</h3>
                ${recent.length ? recent.map(m => `
                    <div class="flex items-center justify-between bg-zinc-900/50 rounded-xl p-3">
                        <div>
                            <div class="font-black text-sm">${m.home} ${m.score} ${m.away}</div>
                            <div class="small-muted">${m.matchday ? `MD ${m.matchday}` : ''} • ${m.date ? m.date.toLocaleDateString() : ''}</div>
                        </div>
                        <div class="flex gap-2">
                            <img src="${getLogo(m.home)}" class="w-6 h-6 object-contain">
                            <img src="${getLogo(m.away)}" class="w-6 h-6 object-contain">
                        </div>
                    </div>
                `).join('') : `<div class="small-muted">No results.</div>`}
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">PLAYERS</h3>
                ${roster.length ? roster
                    .sort((a, b) => (b.avgRating || 0) - (a.avgRating || 0))
                    .map(p => `
                        <div class="flex items-center justify-between bg-zinc-900/50 rounded-xl p-3 cursor-pointer hover:bg-zinc-900/80"
                             onclick="viewPlayer('${_jsEscapeSingle(p.key)}')">
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="small-muted">${p.position || ''}</div>
                            </div>
                            <div class="mono text-[#00ff85] font-black">${p.avgRating ? parseFloat(p.avgRating).toFixed(2) : '—'}</div>
                        </div>
                    `).join('') : `<div class="small-muted">No player data found for this team.</div>`}
            </div>
        </div>
    `;
}

/* =========================
   STATS LOADING + DISPLAY
========================= */

function _jsEscapeSingle(s) {
    return (s || '').toString().replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function _makePlayerKey(league, teamKey, name) {
    return `${league}::${_normMatch(teamKey)}::${_normMatch(name)}`;
}

function _splitPlayerKey(keyOrName) {
    const s = (keyOrName || '').toString();
    if (s.includes('::')) {
        const parts = s.split('::');
        return { league: parts[0] || '', teamNorm: parts[1] || '', nameNorm: parts[2] || '' };
    }
    return { league: '', teamNorm: '', nameNorm: _normMatch(s) };
}

function _extractPhotoUrlFromRow(row) {
    const candidates = [row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7], row[8], row[9], row[10], row[11], row[12], row[13], row[14], row[15]];
    for (const c of candidates) {
        const v = (c || '').toString();
        if (v.includes('http') && (v.includes('.png') || v.includes('.jpg') || v.includes('.jpeg') || v.includes('.webp'))) return v.trim();
    }
    return '';
}

function _editDistance(a, b) {
    a = a || '';
    b = b || '';
    const dp = Array(a.length + 1).fill(0).map(() => Array(b.length + 1).fill(0));
    for (let i = 0; i <= a.length; i++) dp[i][0] = i;
    for (let j = 0; j <= b.length; j++) dp[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            dp[i][j] = Math.min(
                dp[i - 1][j] + 1,
                dp[i][j - 1] + 1,
                dp[i - 1][j - 1] + cost
            );
        }
    }
    return dp[a.length][b.length];
}

function _buildTeamPlayerIndex(playersObj) {
    const idx = {};
    Object.keys(playersObj || {}).forEach(k => {
        const p = playersObj[k];
        const teamKey = (p.teamKey || canonicalTeamName(p.team) || '').toString();
        const teamNorm = _normMatch(teamKey);
        if (!idx[teamNorm]) idx[teamNorm] = { keys: [], byExactName: {}, keyToNameNorm: {} };
        const nameNorm = _normMatch(p.name);
        idx[teamNorm].keys.push(k);
        if (!idx[teamNorm].byExactName[nameNorm]) idx[teamNorm].byExactName[nameNorm] = k;
        idx[teamNorm].keyToNameNorm[k] = nameNorm;
    });
    return idx;
}

function _resolvePlayerKeyForEntry(teamIndex, league, team, name) {
    const teamKey = canonicalTeamName(team);
    const teamNorm = _normMatch(teamKey);
    const nameNorm = _normMatch(name);

    const bucket = teamIndex[teamNorm];
    if (!bucket) return null;

    if (bucket.byExactName[nameNorm]) return bucket.byExactName[nameNorm];

    let bestKey = null;
    let bestD = null;
    let secondBestD = null;

    for (const k of bucket.keys) {
        const candidateNorm = bucket.keyToNameNorm[k];
        const d = _editDistance(nameNorm, candidateNorm);
        if (bestD === null || d < bestD) {
            secondBestD = bestD;
            bestD = d;
            bestKey = k;
        } else if (secondBestD === null || d < secondBestD) {
            secondBestD = d;
        }
    }

    const threshold = Math.max(2, Math.floor(Math.max(nameNorm.length, 1) * 0.25));
    if (bestD === null || bestD > threshold) return null;
    if (secondBestD !== null && secondBestD === bestD) return null;

    return bestKey;
}

async function loadStats(league) {
    if (!STATS_URLS[league].leaderboard) {
        statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
        return;
    }

    if (statsData[league].loaded) return;

    const data = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {} };

    const fetchCsvRows = (url) => new Promise((resolve) => {
        if (!url) return resolve([]);
        Papa.parse(url, {
            download: true,
            complete: (r) => resolve(r.data || []),
            error: () => resolve([])
        });
    });

    const headerLooksReal = (row) => (row || []).some(c => /player|name|team|club|goal|assist|clean|rating|rank|apps|match/i.test((c || '').toString()));

    const findIdx = (headerRow, regexes) => {
        const hdr = headerRow || [];
        for (let i = 0; i < hdr.length; i++) {
            const v = (hdr[i] || '').toString().trim();
            if (!v) continue;
            if (regexes.some(rx => rx.test(v))) return i;
        }
        return -1;
    };

    const parseSimpleStatTable = (rows, kind) => {
        const out = [];
        const rws = rows || [];
        if (!rws.length) return out;

        const hdr = rws[0];
        const hasHdr = headerLooksReal(hdr);

        const start = hasHdr ? 1 : 0;

        let rankIdx = hasHdr ? findIdx(hdr, [/^#$/i, /rank/i, /position/i]) : 0;
        let nameIdx = hasHdr ? findIdx(hdr, [/player/i, /name/i]) : 1;
        let teamIdx = hasHdr ? findIdx(hdr, [/team/i, /club/i]) : 3;
        if (rankIdx === -1) rankIdx = 0;
        if (nameIdx === -1) nameIdx = 1;
        if (teamIdx === -1) teamIdx = 3;

        let valueIdx = 2;
        if (hasHdr) {
            if (kind === 'goals') { const vi = findIdx(hdr, [/goals?/i, /\bg\b/i]); valueIdx = vi !== -1 ? vi : 2; }
            if (kind === 'assists') { const vi = findIdx(hdr, [/assists?/i, /\ba\b/i]); valueIdx = vi !== -1 ? vi : 2; }
            if (kind === 'cleanSheets') { const vi = findIdx(hdr, [/clean\s*sheets?/i, /\bcs\b/i]); valueIdx = vi !== -1 ? vi : 2; }
            if (valueIdx === -1) valueIdx = 2;
        }

        for (let i = start; i < rws.length; i++) {
            const row = rws[i] || [];
            const name = (row[nameIdx] || '').toString().trim();
            const team = (row[teamIdx] || '').toString().trim();
            const value = (row[valueIdx] || '').toString().trim();
            if (!name || !team || !value) continue;
            out.push({ rank: row[rankIdx] || '', name, value, team, league });
        }
        return out;
    };

    const mergeStatEntries = (target, incoming) => {
        const keyOf = (e) => `${_normMatch(e.name)}:::${_normMatch(canonicalTeamName(e.team))}`;
        const index = {};
        (target || []).forEach(e => { if (e && e.name && e.team) index[keyOf(e)] = e; });

        (incoming || []).forEach(e => {
            if (!e || !e.name || !e.team) return;
            const k = keyOf(e);
            const cur = index[k];
            if (!cur) {
                target.push(e);
                index[k] = e;
                return;
            }
            const a = parseFloat(cur.value);
            const b = parseFloat(e.value);
            if (!Number.isNaN(b) && (Number.isNaN(a) || b > a)) cur.value = e.value;
        });
    };

    try {
        const leaderboardData = await fetchCsvRows(STATS_URLS[league].leaderboard);

        leaderboardData.forEach((row, i) => {
            if (i === 0) return;
            if (row[1] && row[2]) data.goals.push({ rank: row[0], name: row[1], value: row[2], team: row[3], league });
            if (row[5] && row[6]) data.assists.push({ rank: row[4], name: row[5], value: row[6], team: row[7], league });
            if (row[13] && row[14]) data.cleanSheets.push({ rank: row[12], name: row[13], value: row[14], team: row[15], league });
        });

        if (STATS_URLS[league].avgRatings) {
            const ratingsData = await fetchCsvRows(STATS_URLS[league].avgRatings);

            ratingsData.forEach((row, i) => {
                if (i === 0) return;
                if (row[8] && row[10]) {
                    const name = row[8];
                    const team = row[11];
                    const teamKey = canonicalTeamName(team);
                    const key = _makePlayerKey(league, teamKey, name);

                    const photoUrl = _extractPhotoUrlFromRow(row);

                    data.ratings.push({
                        rank: row[7],
                        name,
                        position: row[9],
                        value: row[10],
                        team,
                        matches: row[12],
                        league,
                        key
                    });

                    data.players[key] = {
                        key,
                        league,
                        name,
                        team,
                        teamKey,
                        position: row[9],
                        goals: 0,
                        assists: 0,
                        cs: 0,
                        avgRating: row[10],
                        matches: row[12],
                        recentRatings: [],
                        photoUrl
                    };
                }
            });
        }

        const teamIndex = _buildTeamPlayerIndex(data.players);

        function ensurePlayerForEntry(entry) {
            const resolvedKey = _resolvePlayerKeyForEntry(teamIndex, league, entry.team, entry.name);
            if (resolvedKey) return resolvedKey;

            const teamKey = canonicalTeamName(entry.team);
            const key = _makePlayerKey(league, teamKey, entry.name);

            if (!data.players[key]) {
                data.players[key] = {
                    key,
                    league,
                    name: entry.name,
                    team: entry.team,
                    teamKey,
                    position: '',
                    goals: 0,
                    assists: 0,
                    cs: 0,
                    avgRating: 0,
                    matches: 0,
                    recentRatings: [],
                    photoUrl: entry.photoUrl || ''
                };

                const tNorm = _normMatch(teamKey);
                if (!teamIndex[tNorm]) teamIndex[tNorm] = { keys: [], byExactName: {}, keyToNameNorm: {} };
                teamIndex[tNorm].keys.push(key);
                const nNorm = _normMatch(entry.name);
                if (!teamIndex[tNorm].byExactName[nNorm]) teamIndex[tNorm].byExactName[nNorm] = key;
                teamIndex[tNorm].keyToNameNorm[key] = nNorm;
            }

            return key;
        }

        const [goalsRows, assistsRows, csRows] = await Promise.all([
            fetchCsvRows(STATS_URLS[league].goals),
            fetchCsvRows(STATS_URLS[league].assists),
            fetchCsvRows(STATS_URLS[league].cleanSheets)
        ]);

        mergeStatEntries(data.goals, parseSimpleStatTable(goalsRows, 'goals'));
        mergeStatEntries(data.assists, parseSimpleStatTable(assistsRows, 'assists'));
        mergeStatEntries(data.cleanSheets, parseSimpleStatTable(csRows, 'cleanSheets'));

        data.goals.forEach(g => { const k = ensurePlayerForEntry(g); g.key = k; if (data.players[k]) data.players[k].goals = g.value; });
        data.assists.forEach(a => { const k = ensurePlayerForEntry(a); a.key = k; if (data.players[k]) data.players[k].assists = a.value; });
        data.cleanSheets.forEach(c => { const k = ensurePlayerForEntry(c); c.key = k; if (data.players[k]) data.players[k].cs = c.value; });

        if (STATS_URLS[league].ratingsLog) {
            const logRows = await fetchCsvRows(STATS_URLS[league].ratingsLog);

            const hdr = logRows[0] || [];
            const hasHdr = headerLooksReal(hdr);
            const start = hasHdr ? 1 : 0;

            let nameIdx = hasHdr ? findIdx(hdr, [/player/i, /name/i]) : 1;
            let teamIdx = hasHdr ? findIdx(hdr, [/team/i, /club/i]) : 2;
            if (nameIdx === -1) nameIdx = 1;
            if (teamIdx === -1) teamIdx = 2;
            let ratingIdx = hasHdr ? findIdx(hdr, [/rating/i, /rtg/i, /\br\b/i]) : 3;

            if (ratingIdx === -1) ratingIdx = (logRows[0] || []).length - 1;

            const totals = {};
            const byKey = {};

            for (let i = start; i < logRows.length; i++) {
                const row = logRows[i] || [];
                const name = (row[nameIdx] || '').toString().trim();
                const team = (row[teamIdx] || '').toString().trim();
                if (!name || !team) continue;

                let ratingRaw = (row[ratingIdx] || '').toString().trim();
                if (!ratingRaw) {
                    const last = (row || []).slice().reverse().find(v => /^\s*\d+(\.\d+)?\s*$/.test((v || '').toString()));
                    ratingRaw = last ? last.toString().trim() : '';
                }
                const rating = parseFloat(ratingRaw);
                if (Number.isNaN(rating)) continue;

                const entry = { name, team, league };
                const key = ensurePlayerForEntry(entry);
                if (!key) continue;

                if (!byKey[key]) byKey[key] = [];
                byKey[key].push(rating);

                totals[key] = (totals[key] || 0) + 1;
            }

            Object.keys(byKey).forEach(k => {
                if (data.players[k]) {
                    data.players[k].recentRatings = byKey[k].slice(-5);
                    const current = parseInt(data.players[k].matches || 0, 10);
                    const fromLog = totals[k] || 0;
                    if (Number.isNaN(current) || current <= 0) data.players[k].matches = fromLog;
                }
            });
        }

        statsData[league] = { ...data, loaded: true };
    } catch (e) {
        statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
    }
}

async function renderStats(league) {
    document.querySelectorAll('[id^="stat-btn-"]').forEach(b => b.classList.remove('active-league'));
    document.getElementById(`stat-btn-${league}`).classList.add('active-league');

    const content = document.getElementById('statsContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading stats...</div>';

    if (league === 'COMBINED') {
        await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);
        const combined = { goals: [], assists: [], cleanSheets: [], ratings: [] };
        ['PREM', 'LALIGA', 'MLS'].forEach(lg => {
            if (statsData[lg].loaded) {
                combined.goals.push(...statsData[lg].goals);
                combined.assists.push(...statsData[lg].assists);
                combined.cleanSheets.push(...statsData[lg].cleanSheets);
                combined.ratings.push(...statsData[lg].ratings);
            }
        });
        combined.goals.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.assists.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.cleanSheets.sort((a, b) => parseInt(b.value) - parseInt(a.value));
        combined.ratings.sort((a, b) => parseFloat(b.value) - parseFloat(a.value));
        displayStats({ goals: combined.goals.slice(0, 10), assists: combined.assists.slice(0, 10), cleanSheets: combined.cleanSheets.slice(0, 10), ratings: combined.ratings.slice(0, 10) });
    } else {
        await loadStats(league);
        if (!statsData[league].loaded) {
            content.innerHTML = '<div class="text-center text-zinc-500 py-8">No stats available</div>';
            return;
        }
        displayStats({ goals: statsData[league].goals.slice(0, 10), assists: statsData[league].assists.slice(0, 10), cleanSheets: statsData[league].cleanSheets.slice(0, 10), ratings: statsData[league].ratings.slice(0, 10) });
    }
}

function displayStats(data) {
    const content = document.getElementById('statsContent');
    content.innerHTML = `
        <div class="space-y-6">
            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">⚽ TOP SCORERS</h3>
                ${data.goals.map((p, i) => `
                    <div class="flex items-center justify-between py-2 border-b border-zinc-800/60 last:border-b-0 cursor-pointer hover:bg-zinc-900/50" onclick="viewPlayer('${_jsEscapeSingle(p.key || '')}')">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-600 font-mono w-6">${i + 1}</span>
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="text-[10px] text-zinc-500">
                                    <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team}
                                </div>
                            </div>
                        </div>
                        <div class="font-black text-[#00ff85] mono">${p.value}</div>
                    </div>
                `).join('')}
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">🎯 TOP ASSISTS</h3>
                ${data.assists.map((p, i) => `
                    <div class="flex items-center justify-between py-2 border-b border-zinc-800/60 last:border-b-0 cursor-pointer hover:bg-zinc-900/50" onclick="viewPlayer('${_jsEscapeSingle(p.key || '')}')">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-600 font-mono w-6">${i + 1}</span>
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="text-[10px] text-zinc-500">
                                    <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team}
                                </div>
                            </div>
                        </div>
                        <div class="font-black text-[#00ff85] mono">${p.value}</div>
                    </div>
                `).join('')}
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">🧤 CLEAN SHEETS</h3>
                ${data.cleanSheets.map((p, i) => `
                    <div class="flex items-center justify-between py-2 border-b border-zinc-800/60 last:border-b-0 cursor-pointer hover:bg-zinc-900/50" onclick="viewPlayer('${_jsEscapeSingle(p.key || '')}')">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-600 font-mono w-6">${i + 1}</span>
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="text-[10px] text-zinc-500">
                                    <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team}
                                </div>
                            </div>
                        </div>
                        <div class="font-black text-[#00ff85] mono">${p.value}</div>
                    </div>
                `).join('')}
            </div>

            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">⭐ TOP AVG RATINGS</h3>
                ${data.ratings.map((p, i) => `
                    <div class="flex items-center justify-between py-2 border-b border-zinc-800/60 last:border-b-0 cursor-pointer hover:bg-zinc-900/50" onclick="viewPlayer('${_jsEscapeSingle(p.key || '')}')">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-600 font-mono w-6">${i + 1}</span>
                            <div>
                                <div class="font-bold text-sm">${p.name}</div>
                                <div class="text-[10px] text-zinc-500">
                                    <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team} • ${p.matches || 0} apps
                                </div>
                            </div>
                        </div>
                        <div class="font-black text-[#00ff85] mono">${parseFloat(p.value).toFixed(2)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

/* =========================
   SEARCH
========================= */

async function searchPlayer(e, inputId = 'globalSearch') {
    if (e.key !== 'Enter') return;
    const el = document.getElementById(inputId);
    const query = (el.value || '').trim();
    if (!query) return;

    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    // exact-ish team lookup first
    const qTeam = canonicalTeamName(query);
    const league = _findTeamLeague(qTeam);
    const exists = allMatches.some(m => canonicalTeamName(m.home) === qTeam || canonicalTeamName(m.away) === qTeam)
        || ['PREM','LALIGA','MLS'].some(lg => (standingsData[lg] || []).some(r => canonicalTeamName(r.team) === qTeam));

    if (exists) {
        el.value = '';
        viewTeam(qTeam, league);
        return;
    }

    // player lookup across leagues
    const candidates = [];
    ['PREM','LALIGA','MLS'].forEach(lg => {
        const pool = statsData[lg].players || {};
        Object.keys(pool).forEach(k => {
            const p = pool[k];
            if (!p) return;
            candidates.push(p);
        });
    });

    const qNorm = _normMatch(query);
    const matchedPlayer = candidates.find(p => _normMatch(p.name) === qNorm)
        || candidates.find(p => _normMatch(p.name).includes(qNorm));

    el.value = '';
    if (matchedPlayer) {
        viewPlayer(matchedPlayer.key);
        return;
    }

    viewPlayer(query);
}

let __globalSearchIndex = { ready: false, players: [], teams: [] };
let __globalSuggestActive = -1;

async function _ensureGlobalSearchIndex() {
    if (__globalSearchIndex.ready) return;
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    const players = [];
    ['PREM', 'LALIGA', 'MLS'].forEach(lg => {
        const pool = statsData[lg].players || {};
        Object.values(pool).forEach(p => {
            if (!p || !p.key || !p.name || !p.team) return;
            players.push({ type: 'player', key: p.key, name: p.name, team: p.team, league: p.league || lg });
        });
    });

    const rep = {};
    const addTeam = (t) => {
        if (!t) return;
        const k = canonicalTeamName(t);
        if (!k) return;
        if (!rep[k]) rep[k] = t;
    };
    allMatches.forEach(m => { addTeam(m.home); addTeam(m.away); });
    Object.keys(LOGOS).forEach(addTeam);
    Object.keys(TEAM_ALIASES).forEach(aliasNorm => addTeam(TEAM_ALIASES[aliasNorm]));

    const teams = Object.values(rep).map(t => ({ type: 'team', team: t, league: _findTeamLeague(t) }));

    __globalSearchIndex = { ready: true, players, teams };
}

function _scoreCandidate(queryNorm, candidateNorm) {
    if (!queryNorm || !candidateNorm) return 999;
    if (candidateNorm === queryNorm) return 0;
    if (candidateNorm.startsWith(queryNorm)) return 1;
    if (candidateNorm.includes(queryNorm)) return 2;
    return 999;
}

async function updateGlobalSearchSuggestions(inputId = 'globalSearch') {
    const el = document.getElementById(inputId);
    const box = document.getElementById('globalSearchSuggestions');
    if (!el || !box) return;

    const q = (el.value || '').toString().trim();
    if (!q) {
        box.classList.add('hidden');
        box.innerHTML = '';
        __globalSuggestActive = -1;
        return;
    }

    await _ensureGlobalSearchIndex();

    const qNorm = _normMatch(q);
    const items = [];

    __globalSearchIndex.players.forEach(p => {
        const n1 = _normMatch(p.name);
        const n2 = _normMatch(`${p.name} ${p.team}`);
        const s = Math.min(_scoreCandidate(qNorm, n1), _scoreCandidate(qNorm, n2));
        if (s !== 999) items.push({ ...p, score: s });
    });

    __globalSearchIndex.teams.forEach(t => {
        const n = _normMatch(t.team);
        const s = _scoreCandidate(qNorm, n);
        if (s !== 999) items.push({ ...t, score: s });
    });

    items.sort((a, b) => {
        if (a.score !== b.score) return a.score - b.score;
        const an = a.type === 'player' ? a.name : a.team;
        const bn = b.type === 'player' ? b.name : b.team;
        return _normMatch(an).length - _normMatch(bn).length;
    });

    const top = items.slice(0, 8);
    if (!top.length) {
        box.classList.add('hidden');
        box.innerHTML = '';
        __globalSuggestActive = -1;
        return;
    }

    __globalSuggestActive = -1;
    box.classList.remove('hidden');
    box.innerHTML = top.map((it, idx) => {
        if (it.type === 'player') {
            return `
                <div class="search-suggestion-item" data-idx="${idx}" onclick="selectGlobalSuggestion(${idx}, 'player', '${_jsEscapeSingle(it.key)}')">
                    <div>
                        <div class="font-bold text-sm">${it.name}</div>
                        <div class="search-suggestion-meta">
                            <img src="${getLogo(it.team)}" class="w-3 h-3 object-contain">
                            <span>${it.team}</span>
                        </div>
                    </div>
                    <div class="search-suggestion-pill">PLAYER</div>
                </div>
            `;
        }
        return `
            <div class="search-suggestion-item" data-idx="${idx}" onclick="selectGlobalSuggestion(${idx}, 'team', '${_jsEscapeSingle(it.team)}')">
                <div class="flex items-center gap-2">
                    <img src="${getLogo(it.team)}" class="w-4 h-4 object-contain">
                    <div class="font-bold text-sm">${it.team}</div>
                </div>
                <div class="search-suggestion-pill">TEAM</div>
            </div>
        `;
    }).join('');
}

function hideGlobalSearchSuggestionsDelayed() {
    setTimeout(() => {
        const box = document.getElementById('globalSearchSuggestions');
        if (!box) return;
        box.classList.add('hidden');
        box.innerHTML = '';
        __globalSuggestActive = -1;
    }, 160);
}

function selectGlobalSuggestion(idx, type, value) {
    const el = document.getElementById('globalSearch');
    const box = document.getElementById('globalSearchSuggestions');
    if (box) {
        box.classList.add('hidden');
        box.innerHTML = '';
    }
    __globalSuggestActive = -1;

    if (el) el.value = '';

    if (type === 'player') {
        viewPlayer(value);
        return;
    }
    const team = value;
    viewTeam(team, _findTeamLeague(team));
}

function globalSearchKeyup(e, inputId = 'globalSearch') {
    if (e && (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Escape')) {
        const box = document.getElementById('globalSearchSuggestions');
        if (!box || box.classList.contains('hidden')) {
            if (e.key === 'Escape') {
                const el = document.getElementById(inputId);
                if (el) el.value = '';
            }
            return;
        }
        const items = Array.from(box.querySelectorAll('.search-suggestion-item'));
        if (!items.length) return;

        if (e.key === 'Escape') {
            box.classList.add('hidden');
            box.innerHTML = '';
            __globalSuggestActive = -1;
            return;
        }

        if (e.key === 'ArrowDown') __globalSuggestActive = Math.min(items.length - 1, __globalSuggestActive + 1);
        if (e.key === 'ArrowUp') __globalSuggestActive = Math.max(0, __globalSuggestActive - 1);

        items.forEach((n, i) => n.classList.toggle('active', i === __globalSuggestActive));
        return;
    }

    updateGlobalSearchSuggestions(inputId);

    if (e && e.key === 'Enter') {
        const box = document.getElementById('globalSearchSuggestions');
        if (box && !box.classList.contains('hidden')) {
            const items = Array.from(box.querySelectorAll('.search-suggestion-item'));
            if (__globalSuggestActive >= 0 && items[__globalSuggestActive]) {
                items[__globalSuggestActive].click();
                return;
            }
        }
        searchPlayer(e, inputId);
    }
}

document.addEventListener('click', (ev) => {
    const box = document.getElementById('globalSearchSuggestions');
    const input = document.getElementById('globalSearch');
    if (!box || !input) return;

    const t = ev.target;
    if (t === input || input.contains(t) || box.contains(t)) return;
    box.classList.add('hidden');
    box.innerHTML = '';
    __globalSuggestActive = -1;
});

/* =========================
   PLAYER PAGE
========================= */

function getPlayerInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

function loadPlayerPhotoToElement(url, imgEl, fallbackEl) {
    if (!url || !imgEl || !fallbackEl) return;
    imgEl.onload = () => {
        imgEl.style.display = 'block';
        fallbackEl.style.display = 'none';
    };
    imgEl.onerror = () => {
        imgEl.style.display = 'none';
        fallbackEl.style.display = 'flex';
    };
    imgEl.src = url;
}

async function viewPlayer(playerKeyOrName) {
    document.getElementById('player-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('team-tab').classList.add('hidden');

    const content = document.getElementById('playerContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading player...</div>';

    const parts = _splitPlayerKey(playerKeyOrName);
    if (parts.league) await loadStats(parts.league);
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    let playerData = null;

    if (playerKeyOrName.toString().includes('::')) {
        const tryLeague = parts.league;
        if (tryLeague && statsData[tryLeague] && statsData[tryLeague].players[playerKeyOrName]) {
            playerData = statsData[tryLeague].players[playerKeyOrName];
        } else {
            ['PREM','LALIGA','MLS'].forEach(lg => {
                if (statsData[lg].players[playerKeyOrName]) playerData = statsData[lg].players[playerKeyOrName];
            });
        }
    } else {
        const nameNorm = _normMatch(playerKeyOrName);
        const allPlayers = [];
        ['PREM','LALIGA','MLS'].forEach(lg => allPlayers.push(...Object.values(statsData[lg].players || {})));
        playerData = allPlayers.find(p => _normMatch(p.name) === nameNorm) || allPlayers.find(p => _normMatch(p.name).includes(nameNorm));
    }

    if (!playerData) {
        content.innerHTML = `<div class="text-center text-zinc-500 py-8">Player not found.</div>`;
        return;
    }

    const isGK = (playerData.position || '').toLowerCase().includes('gk');
    const photoUrl = playerData.photoUrl || '';
    const teamLeague = playerData.league || _findTeamLeague(playerData.team);

    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex flex-col items-center gap-4">
                <div class="flex flex-col items-center">
                    <img id="playerPhoto" class="w-20 h-20 rounded-full object-cover bg-zinc-800 border border-zinc-800" style="display:none;">
                    <div id="playerAvatarFallback" class="player-avatar">${getPlayerInitials(playerData.name)}</div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <h2 class="text-2xl font-black">${playerData.name}</h2>
                    </div>
                    <p class="text-zinc-500 text-sm flex items-center justify-center gap-2">
                        <img src="${getLogo(playerData.team)}" class="w-4 h-4 object-contain">
                        <span class="cursor-pointer hover:text-white" onclick="viewTeam('${_jsEscapeSingle(playerData.team)}', '${teamLeague}')">${playerData.team}</span>
                        ${playerData.position ? `<span class="pill">${playerData.position}</span>` : ''}
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="stat-card text-center">
                    <div class="text-3xl font-black text-[#00ff85]">${playerData.goals || 0}</div>
                    <div class="text-xs text-zinc-500 mt-1">GOALS</div>
                </div>
                <div class="stat-card text-center">
                    <div class="text-3xl font-black text-[#00ff85]">${playerData.assists || 0}</div>
                    <div class="text-xs text-zinc-500 mt-1">ASSISTS</div>
                </div>
                <div class="stat-card text-center">
                    <div class="text-3xl font-black text-[#00ff85]">${playerData.matches || 0}</div>
                    <div class="text-xs text-zinc-500 mt-1">GAMES</div>
                </div>
                ${isGK ? `
                <div class="stat-card text-center">
                    <div class="text-3xl font-black text-[#00ff85]">${playerData.cs || 0}</div>
                    <div class="text-xs text-zinc-500 mt-1">CLEAN SHEETS</div>
                </div>
                ` : ''}
                <div class="stat-card text-center">
                    <div class="text-3xl font-black text-[#00ff85]">${parseFloat(playerData.avgRating || 0).toFixed(2)}</div>
                    <div class="text-xs text-zinc-500 mt-1">AVG RATING</div>
                </div>
            </div>

            ${playerData.recentRatings && playerData.recentRatings.length > 0 ? `
            <div class="stat-card">
                <h3 class="text-sm font-black text-[#00ff85] mb-4">LAST 5 RATINGS</h3>
                <div class="flex gap-2">
                    ${playerData.recentRatings.map(r => `
                        <div class="flex-1 bg-zinc-900 rounded-lg py-3 text-center">
                            <div class="font-black text-[#00ff85]">${parseFloat(r).toFixed(1)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;

    if (photoUrl) {
        const imgEl = document.getElementById('playerPhoto');
        const fbEl = document.getElementById('playerAvatarFallback');
        loadPlayerPhotoToElement(photoUrl, imgEl, fbEl);
    }
}

/* =========================
   INIT
========================= */

(async function init() {
    await loadMatches();
    renderHub();
    renderStandings('PREM');
    renderStats('COMBINED');
})();
</script>

</body>
</html>
