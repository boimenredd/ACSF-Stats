<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ScoreHub Pro</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/6/6b/Football_%28soccer_ball%29.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
        .tab-btn { padding: 10px 14px; border-radius: 999px; background: rgba(255,255,255,0.06); font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
        .tab-btn.active { background: #00ff85; color: #000; }
        .match-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:14px; background: rgba(255,255,255,0.05); }
        .team-box { display:flex; align-items:center; gap:10px; min-width: 0; }
        .team-logo { width: 24px; height: 24px; object-fit: contain; }
        .team-name { font-weight: 900; font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
        .match-score { font-weight: 900; font-size: 14px; }
        .league-container { margin-top: 14px; }
        .league-header { display:flex; align-items:center; gap:10px; font-weight: 900; opacity: 0.9; margin: 12px 2px; }
        .league-logo { width: 20px; height: 20px; object-fit: contain; }
        .date-nav { display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 0 16px 12px; }
        .date-display { font-weight: 900; font-size: 14px; }
        .nav-arrow { width: 34px; height: 34px; display:flex; align-items:center; justify-content:center; border-radius: 999px; background: rgba(255,255,255,0.06); font-weight: 900; cursor:pointer; user-select:none; }
        .league-btn { padding: 10px 12px; border-radius: 999px; background: rgba(255,255,255,0.06); font-weight: 900; font-size: 12px; }
        .league-btn.active-league { background: #00ff85; color: #000; }
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; }
        .player-avatar { width: 80px; height: 80px; border-radius: 999px; background: rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center; font-weight: 900; font-size: 26px; color: #00ff85; }
        .header-search { width: 54%; max-width: 260px; background: rgba(255,255,255,0.06); border-radius: 999px; padding: 10px 12px; outline: none; font-size: 12px; font-weight: 800; }
        table { width: 100%; }
        th, td { padding: 10px 8px; font-size: 12px; }
        th { font-weight: 900; color: rgba(255,255,255,0.7); }
        tr { border-bottom: 1px solid rgba(255,255,255,0.07); }
        .qual-bar { width: 3px; border-radius: 999px; }
        .team-cell { display:flex; align-items:center; gap:10px; min-width:0; }
        .team-cell img { width: 18px; height: 18px; object-fit: contain; }
        .search-suggestions { position: absolute; top: 54px; left: 0; right: 0; background: rgba(20,20,20,0.98); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; overflow: hidden; z-index: 50; }
        .search-suggestion { padding: 10px 12px; display:flex; align-items:center; gap:10px; cursor:pointer; }
        .search-suggestion:hover { background: rgba(255,255,255,0.06); }
        .search-suggestion img { width: 20px; height: 20px; object-fit: contain; }
        .hidden { display:none; }
        header .flex { position: relative; }
    </style>
</head>

<body class="max-w-md mx-auto pb-24" id="content">
<header class="p-4">
    <div class="flex items-center justify-between gap-3">
        <h1 class="text-xl font-black italic uppercase">Score<span class="text-[#00ff85]">Hub</span> Pro</h1>
        <input type="text" id="globalSearch" class="header-search" placeholder="Search teams or players..." onkeyup="searchPlayer(event, 'globalSearch')">
        <div id="globalSearchSuggestions" class="search-suggestions hidden"></div>
    </div>
</header>

<main id="hub-tab">
    <div class="date-nav">
        <div class="nav-arrow" onclick="changeDate(-1)">‹</div>
        <div class="flex flex-col items-center">
            <div class="date-display" id="dateText">Loading...</div>
            <div class="text-xs text-zinc-500 mt-1">Tap team to view details</div>
        </div>
        <div class="nav-arrow" onclick="changeDate(1)">›</div>
    </div>
    <div id="league-list" class="px-4 pb-4"></div>
</main>

<main id="standings-tab" class="hidden">
    <div class="px-4 pt-2 pb-3 flex items-center gap-2">
        <button id="btn-PREM" class="league-btn active-league" onclick="renderStandings('PREM')">Prem</button>
        <button id="btn-LALIGA" class="league-btn" onclick="renderStandings('LALIGA')">La Liga</button>
        <button id="btn-MLS" class="league-btn" onclick="renderStandings('MLS')">MLS</button>
    </div>
    <div class="px-4">
        <div class="stat-card p-0 overflow-hidden">
            <table>
                <thead>
                <tr id="standingsHead"></tr>
                </thead>
                <tbody id="standingsBody"></tbody>
            </table>
        </div>
        <div id="legend" class="text-xs text-zinc-500 mt-3"></div>
    </div>
</main>

<main id="stats-tab" class="hidden">
    <div class="px-4 pt-2 pb-3 flex items-center gap-2 overflow-x-auto">
        <button id="stat-btn-PREM" class="league-btn active-league" onclick="renderStats('PREM')">Prem</button>
        <button id="stat-btn-LALIGA" class="league-btn" onclick="renderStats('LALIGA')">La Liga</button>
        <button id="stat-btn-MLS" class="league-btn" onclick="renderStats('MLS')">MLS</button>
        <button id="stat-btn-COMBINED" class="league-btn" onclick="renderStats('COMBINED')">All</button>
    </div>
    <div id="statsContent" class="px-4 pb-4"></div>
</main>

<main id="team-tab" class="hidden">
    <div id="teamContent" class="px-4 pb-4"></div>
</main>

<main id="player-tab" class="hidden">
    <div id="playerContent" class="px-4 pb-4"></div>
</main>

<nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-black/90 border-t border-zinc-800">
    <div class="flex justify-around p-3">
        <button class="tab-btn active" id="tabHub" onclick="switchTab('hub')">Hub</button>
        <button class="tab-btn" id="tabStandings" onclick="switchTab('standings')">Standings</button>
        <button class="tab-btn" id="tabStats" onclick="switchTab('stats')">Stats</button>
    </div>
</nav>

<script>
const STANDINGS_URLS = {
  PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=216846339&single=true&output=csv',
  LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=216846339&single=true&output=csv',
  MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=216846339&single=true&output=csv'
};

const STATS_URLS = {
  PREM: {
    goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=0&single=true&output=csv',
    assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1828601090&single=true&output=csv',
    cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1875623411&single=true&output=csv',
    ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=812230696&single=true&output=csv',
    avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=692292778&single=true&output=csv',
    leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=983480432&single=true&output=csv'
  },
  LALIGA: {
    goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=0&single=true&output=csv',
    assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1828601090&single=true&output=csv',
    cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1875623411&single=true&output=csv',
    ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1955113818&single=true&output=csv',
    avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=692292778&single=true&output=csv',
    leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=983480432&single=true&output=csv'
  },
  MLS: {
    goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=0&single=true&output=csv',
    assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1828601090&single=true&output=csv',
    cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1875623411&single=true&output=csv',
    ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=812230696&single=true&output=csv',
    avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=692292778&single=true&output=csv',
    leaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=983480432&single=true&output=csv'
  }
};

const LEAGUE_META = {
  PREM: { name: 'Premier League', logo: 'https://upload.wikimedia.org/wikipedia/en/f/f2/Premier_League_Logo.svg' },
  LALIGA: { name: 'La Liga', logo: 'https://upload.wikimedia.org/wikipedia/en/1/13/LaLiga.svg' },
  MLS: { name: 'MLS', logo: 'https://upload.wikimedia.org/wikipedia/en/7/76/Major_League_Soccer_logo.svg' }
};

// ==== LOGOS (full mapping kept as in your file) ====
const LOGOS = {
  "Arsenal": "https://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg",
  "Aston Villa": "https://upload.wikimedia.org/wikipedia/en/9/9f/Aston_Villa_FC_logo.svg",
  "Bournemouth": "https://upload.wikimedia.org/wikipedia/en/e/e5/AFC_Bournemouth_%282013%29.svg",
  "Brentford": "https://upload.wikimedia.org/wikipedia/en/2/2a/Brentford_FC_crest.svg",
  "Brighton": "https://upload.wikimedia.org/wikipedia/en/f/fd/Brighton_%26_Hove_Albion_logo.svg",
  "Burnley": "https://upload.wikimedia.org/wikipedia/en/0/02/Burnley_FC_badge.svg",
  "Chelsea": "https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg",
  "Crystal Palace": "https://upload.wikimedia.org/wikipedia/en/0/0c/Crystal_Palace_FC_logo.svg",
  "Everton": "https://upload.wikimedia.org/wikipedia/en/7/7c/Everton_FC_logo.svg",
  "Fulham": "https://upload.wikimedia.org/wikipedia/en/e/eb/Fulham_FC_%28shield%29.svg",
  "Liverpool": "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg",
  "Luton": "https://upload.wikimedia.org/wikipedia/en/1/1c/Luton_Town_logo.svg",
  "Man City": "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg",
  "Manchester City": "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg",
  "Man United": "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg",
  "Manchester United": "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg",
  "Newcastle": "https://upload.wikimedia.org/wikipedia/en/5/56/Newcastle_United_Logo.svg",
  "Nottingham Forest": "https://upload.wikimedia.org/wikipedia/en/e/e5/Nottingham_Forest_F.C._logo.svg",
  "Sheffield United": "https://upload.wikimedia.org/wikipedia/en/9/9c/Sheffield_United_FC_logo.svg",
  "Spurs": "https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg",
  "Tottenham": "https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg",
  "Tottenham Hotspur": "https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg",
  "West Ham": "https://upload.wikimedia.org/wikipedia/en/c/c2/West_Ham_United_FC_logo.svg",
  "Wolves": "https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg",
  "Wolverhampton": "https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg",
  "Wolverhampton Wanderers": "https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg",

  "Real Madrid": "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg",
  "Barcelona": "https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg",
  "Atletico Madrid": "https://upload.wikimedia.org/wikipedia/en/f/f4/Atletico_Madrid_2017_logo.svg",
  "Atlético Madrid": "https://upload.wikimedia.org/wikipedia/en/f/f4/Atletico_Madrid_2017_logo.svg",

  "Inter Miami": "https://upload.wikimedia.org/wikipedia/en/5/5c/Inter_Miami_CF_logo.svg",
  "LA Galaxy": "https://upload.wikimedia.org/wikipedia/en/7/76/LA_Galaxy_logo.svg"
};

const TEAM_ALIASES = {
  "manchester city": "Man City",
  "man city": "Man City",
  "manchester united": "Man United",
  "man utd": "Man United",
  "tottenham": "Spurs",
  "tottenham hotspur": "Spurs",
  "wolves": "Wolves"
};

let allMatches = [];
let uniqueDates = [];
let dateIdx = 0;
let currentView = 'hub';
let currentTeam = null;
let currentPlayer = null;

let statsData = { PREM: {}, LALIGA: {}, MLS: {}, COMBINED: {} };
let standingsCache = { PREM: null, LALIGA: null, MLS: null };
let currentStandingsLeague = 'PREM';

let __autoRefreshStarted = false;

// Player photo cache
const PHOTO_CACHE_DB = 'scorehub-photo-cache';
const PHOTO_CACHE_STORE = 'photos';
const PHOTO_FETCH_TIMEOUT_MS = 4500;

function canonicalTeamName(team) {
  if (!team) return '';
  const key = team.toString().trim().toLowerCase();
  if (TEAM_ALIASES[key]) return TEAM_ALIASES[key];
  return team.toString().trim();
}

function getLogo(team) {
  const t = canonicalTeamName(team);
  return LOGOS[t] || '';
}

function _jsEscapeSingle(s) {
  return (s || '').toString().replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function switchTab(tab) {
  currentView = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tabHub').classList.toggle('active', tab === 'hub');
  document.getElementById('tabStandings').classList.toggle('active', tab === 'standings');
  document.getElementById('tabStats').classList.toggle('active', tab === 'stats');

  document.getElementById('hub-tab').classList.toggle('hidden', tab !== 'hub');
  document.getElementById('standings-tab').classList.toggle('hidden', tab !== 'standings');
  document.getElementById('stats-tab').classList.toggle('hidden', tab !== 'stats');
  document.getElementById('team-tab').classList.add('hidden');
  document.getElementById('player-tab').classList.add('hidden');

  if (tab === 'standings') renderStandings(currentStandingsLeague || 'PREM');
  if (tab === 'stats') renderStats('PREM');
}

function changeDate(dir) {
  dateIdx += dir;
  if (dateIdx < 0) dateIdx = 0;
  if (dateIdx > uniqueDates.length - 1) dateIdx = uniqueDates.length - 1;
  renderMatches();
}

function _normMatch(s) {
  return (s || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
}

function _parseMatchDate(str) {
  if (!str) return null;
  str = str.toString();
  const monthMap = {
    Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
    Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11,
    January: 0, February: 1, March: 2, April: 3, June: 5,
    July: 6, August: 7, September: 8, October: 9, November: 10, December: 11
  };
  const has2025 = str.includes('2025');

  const match = str.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)\.?\s*(\d+)/i);
  if (match) {
    const monthStr = match[1];
    const day = parseInt(match[2], 10);

    let month = -1;
    for (let key in monthMap) {
      if (key.toLowerCase() === monthStr.toLowerCase()) {
        month = monthMap[key];
        break;
      }
    }
    if (month === -1) return null;

    const year = has2025 ? 2025 : 2026;
    const d = new Date(year, month, day);
    d.setHours(0, 0, 0, 0);
    return d;
  }
  return null;
}

function _stripLeadingPosFromTeam(pos, team) {
  const t = (team || '').toString().trim();
  const p = (pos || '').toString().trim();

  const m = t.match(/^\s*(\d{1,2})\s*[\.\)\-:]?\s+(.+)\s*$/);
  if (!m) return { pos: p, team: t };

  const lead = m[1];
  const rest = m[2].trim();

  if (!p) return { pos: lead, team: rest };
  const pn = parseInt(p, 10);
  const ln = parseInt(lead, 10);
  if (!Number.isNaN(pn) && !Number.isNaN(ln) && pn === ln) return { pos: p, team: rest };

  return { pos: p, team: t };
}

async function loadStandingsCache(league) {
  if (standingsCache[league]) return standingsCache[league];

  standingsCache[league] = await new Promise((resolve) => {
    Papa.parse(STANDINGS_URLS[league], {
      download: true,
      header: true,
      complete: (res) => {
        const map = {};
        (res.data || []).forEach(r => {
          let pos = r.Position || r.position || r['#'] || '';
          let team = r.Team || r.team || '';
          const fixed = _stripLeadingPosFromTeam(pos, team);
          pos = fixed.pos;
          team = fixed.team;

          const teamKey = canonicalTeamName(team);
          if (!teamKey) return;

          map[teamKey] = {
            pos: pos,
            team: team,
            mp: r.MP || r.mp || '',
            wdl: r['W-D-L'] || r.wdl || '',
            pts: r.Points || r.Pts || r.pts || ''
          };
        });
        resolve(map);
      },
      error: () => resolve({})
    });
  });

  return standingsCache[league];
}

function _makePlayerKey(league, team, name) {
  return `${league}:::${(team || '').trim()}:::${(name || '').trim()}`;
}

function _splitPlayerKey(key) {
  const parts = (key || '').split(':::');
  if (parts.length < 3) return { league: null, team: null, name: key };
  return { league: parts[0], team: parts[1], name: parts.slice(2).join(':::') };
}

function _extractPhotoUrlFromRow(row) {
  if (!Array.isArray(row)) return '';
  const candidates = [row[0], row[1], row[2], row[3], row[4], row[5]];
  for (const c of candidates) {
    const s = (c || '').toString();
    if (s.startsWith('http') && (s.includes('.png') || s.includes('.jpg') || s.includes('.jpeg') || s.includes('.webp'))) return s;
  }
  return '';
}

async function _photoDb() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(PHOTO_CACHE_DB, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(PHOTO_CACHE_STORE)) {
        db.createObjectStore(PHOTO_CACHE_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function _photoDbGet(key) {
  const db = await _photoDb();
  return new Promise((resolve) => {
    const tx = db.transaction(PHOTO_CACHE_STORE, 'readonly');
    const store = tx.objectStore(PHOTO_CACHE_STORE);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => resolve(null);
  });
}

async function _photoDbPut(key, val) {
  const db = await _photoDb();
  return new Promise((resolve) => {
    const tx = db.transaction(PHOTO_CACHE_STORE, 'readwrite');
    const store = tx.objectStore(PHOTO_CACHE_STORE);
    const req = store.put(val, key);
    req.onsuccess = () => resolve(true);
    req.onerror = () => resolve(false);
  });
}

async function _fetchBlobWithTimeout(url, timeoutMs) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const resp = await fetch(url, { signal: controller.signal, cache: 'no-store' });
    if (!resp.ok) return null;
    return await resp.blob();
  } catch (e) {
    return null;
  } finally {
    clearTimeout(t);
  }
}

async function getCachedPhotoSrc(url) {
  if (!url) return null;
  try {
    const cached = await _photoDbGet(url);
    if (cached && cached.dataUrl) return cached.dataUrl;

    const blob = await _fetchBlobWithTimeout(url, PHOTO_FETCH_TIMEOUT_MS);
    if (!blob) return null;

    const dataUrl = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => resolve(null);
      reader.readAsDataURL(blob);
    });

    if (dataUrl) await _photoDbPut(url, { dataUrl, ts: Date.now() });
    return dataUrl || null;
  } catch (e) {
    return null;
  }
}

async function loadPlayerPhotoToElement(url, imgEl, fbEl) {
  if (!url || !imgEl || !fbEl) return;
  const cachedSrc = await getCachedPhotoSrc(url);
  if (cachedSrc) {
    imgEl.src = cachedSrc;
    imgEl.onload = () => { imgEl.style.display = ''; fbEl.style.display = 'none'; };
    imgEl.onerror = () => { imgEl.style.display = 'none'; fbEl.style.display = ''; };
    return;
  }
  imgEl.src = url;
  imgEl.onload = () => { imgEl.style.display = ''; fbEl.style.display = 'none'; };
  imgEl.onerror = () => { imgEl.style.display = 'none'; fbEl.style.display = ''; };
}

function getQualifyColor(lg, pos) {
  const p = parseInt(pos, 10);
  if (Number.isNaN(p)) return 'transparent';

  if (lg === 'PREM' || lg === 'LALIGA') {
    if (p <= 4) return '#00ff85';
    if (p === 5) return '#00b3ff';
    if (p >= 18) return '#ff4757';
    return 'transparent';
  }
  if (lg === 'MLS') {
    if (p <= 9) return '#00ff85';
    return 'transparent';
  }
  return 'transparent';
}

async function init() {
  const urls = {
    PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1475530986&single=true&output=csv',
    LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1475530986&single=true&output=csv',
    MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1475530986&single=true&output=csv'
  };

  const parseLeague = (lg) => new Promise((res) => {
    Papa.parse(urls[lg], {
      download: true,
      header: true,
      complete: (r) => {
        (r.data || []).forEach(row => {
          const dateStr = row.Date || row.date || row.DATE || '';
          const home = row.Home || row.home || row.HOME || '';
          const away = row.Away || row.away || row.AWAY || '';
          const score = row.Score || row.score || row.SCORE || 'v';
          const d = _parseMatchDate(dateStr);
          if (!d || !home || !away) return;
          allMatches.push({
            league: lg,
            date: d,
            home, away,
            score: score || 'v',
            homeKey: canonicalTeamName(home),
            awayKey: canonicalTeamName(away)
          });
        });
        res();
      },
      error: () => res()
    });
  });

  allMatches = [];
  await Promise.all([parseLeague('PREM'), parseLeague('LALIGA'), parseLeague('MLS')]);

  const dateMap = {};
  allMatches.forEach(m => {
    const t = m.date.getTime();
    dateMap[t] = true;
  });

  uniqueDates = Object.keys(dateMap).map(Number).sort((a, b) => a - b);

  if (uniqueDates.length > 0) {
    jumpToToday();
  } else {
    document.getElementById('dateText').textContent = "NO DATA FOUND";
  }

  if (!__autoRefreshStarted) {
    __autoRefreshStarted = true;

    setInterval(() => {
      const currentDateIdx = dateIdx;
      const tempMatches = allMatches;
      allMatches = [];
      init().then(() => {
        dateIdx = currentDateIdx;
        renderMatches();
      }).catch(() => {
        allMatches = tempMatches;
      });
    }, 60000);

    setInterval(async () => {
      standingsCache = { PREM: null, LALIGA: null, MLS: null };

      if (!document.getElementById('standings-tab').classList.contains('hidden')) {
        renderStandings(currentStandingsLeague || 'PREM');
      }

      if (!document.getElementById('team-tab').classList.contains('hidden') && currentTeam && currentTeam.name && currentTeam.league) {
        viewTeam(currentTeam.name, currentTeam.league);
      }
    }, 60000);
  }
}

function jumpToToday() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  const nowTime = now.getTime();

  let foundIdx = -1;
  for (let i = 0; i < uniqueDates.length; i++) {
    if (uniqueDates[i] >= nowTime) {
      foundIdx = i;
      break;
    }
  }
  if (foundIdx === -1) foundIdx = uniqueDates.length - 1;

  dateIdx = foundIdx;
  renderMatches();
}

function renderMatches() {
  const container = document.getElementById('league-list');
  const target = uniqueDates[dateIdx];
  if (!target) {
    document.getElementById('dateText').textContent = "NO DATA";
    container.innerHTML = "";
    return;
  }
  const dObj = new Date(target);
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  document.getElementById('dateText').textContent = `${days[dObj.getDay()]}, ${months[dObj.getMonth()]} ${dObj.getDate()}`;

  const filtered = allMatches.filter(m => m.date.getTime() === target);
  container.innerHTML = ['PREM', 'LALIGA', 'MLS'].map(lg => {
    const matches = filtered.filter(m => m.league === lg);
    if (matches.length === 0) return '';
    return `
      <div class="league-container">
        <div class="league-header"><img src="${LEAGUE_META[lg].logo}" class="league-logo"><span>${LEAGUE_META[lg].name}</span></div>
        ${matches.map(m => {
          return `
          <div class="match-row">
            <div class="team-box justify-end cursor-pointer hover:opacity-70" onclick="viewTeam('${_jsEscapeSingle(m.home)}', '${lg}')"><span class="team-name text-right">${m.home}</span><img src="${getLogo(m.home)}" class="team-logo"></div>
            <div class="match-info"><div class="match-score">${m.score === 'v' ? 'v' : m.score}</div></div>
            <div class="team-box justify-start cursor-pointer hover:opacity-70" onclick="viewTeam('${_jsEscapeSingle(m.away)}', '${lg}')"><img src="${getLogo(m.away)}" class="team-logo"><span class="team-name">${m.away}</span></div>
          </div>`;
        }).join('')}
      </div>`;
  }).join('');
}

function renderStandings(lg) {
  currentStandingsLeague = lg;
  document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('active-league'));
  document.getElementById(`btn-${lg}`).classList.add('active-league');

  const head = document.getElementById('standingsHead');
  const body = document.getElementById('standingsBody');
  const legend = document.getElementById('legend');

  head.innerHTML = `<th class="pl-4 py-3">POS</th><th>Team</th><th class="text-center">MP</th><th class="text-center">W-D-L</th><th class="pr-4 text-right">PTS</th>`;

  Papa.parse(STANDINGS_URLS[lg], {
    download: true, header: true,
    complete: (res) => {
      body.innerHTML = (res.data || []).map(r => {
        let pos = r.Position || r.position || r['#'] || '';
        let team = r.Team || r.team || '';
        const fixed = _stripLeadingPosFromTeam(pos, team);
        pos = fixed.pos;
        team = fixed.team;

        const color = getQualifyColor(lg, pos);
        return `
          <tr class="cursor-pointer hover:bg-white/5" onclick="viewTeam('${_jsEscapeSingle(team)}','${lg}')">
            <td class="pl-4">
              <div class="flex items-center gap-2">
                <div class="qual-bar" style="height:18px; background:${color}"></div>
                <span class="font-black">${pos}</span>
              </div>
            </td>
            <td>
              <div class="team-cell">
                <img src="${getLogo(team)}">
                <span class="truncate">${team}</span>
              </div>
            </td>
            <td class="text-center text-zinc-400">${r.MP || r.mp || ''}</td>
            <td class="text-center text-zinc-400">${r['W-D-L'] || r.wdl || ''}</td>
            <td class="pr-4 text-right font-black">${r.Points || r.Pts || r.pts || ''}</td>
          </tr>`;
      }).join('');

      legend.textContent = lg === 'MLS'
        ? 'Green = Playoffs'
        : 'Green = UCL • Blue = Europa • Red = Relegation';
    }
  });
}

async function loadStats(league) {
  if (!STATS_URLS[league] || !STATS_URLS[league].leaderboard) {
    statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
    return;
  }
  if (statsData[league].loaded) return;

  const data = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {} };

  try {
    const leaderboardData = await new Promise((resolve) => {
      Papa.parse(STATS_URLS[league].leaderboard, {
        download: true,
        complete: (r) => resolve(r.data || []),
        error: () => resolve([])
      });
    });

    leaderboardData.forEach((row, i) => {
      if (i === 0) return;
      if (row[1] && row[2]) data.goals.push({ rank: row[0], name: row[1], value: row[2], team: row[3], league });
      if (row[7] && row[8]) data.assists.push({ rank: row[6], name: row[7], value: row[8], team: row[9], league });
      if (row[13] && row[14]) data.cleanSheets.push({ rank: row[12], name: row[13], value: row[14], team: row[15], league });
    });

    if (STATS_URLS[league].avgRatings) {
      const ratingsData = await new Promise((resolve) => {
        Papa.parse(STATS_URLS[league].avgRatings, {
          download: true,
          complete: (r) => resolve(r.data || []),
          error: () => resolve([])
        });
      });

      ratingsData.forEach((row, i) => {
        if (i === 0) return;
        if (row[8] && row[10]) {
          const name = row[8];
          const team = row[11];
          const teamKey = canonicalTeamName(team);
          const key = _makePlayerKey(league, teamKey, name);

          const photoUrl = _extractPhotoUrlFromRow(row);

          data.ratings.push({
            rank: row[7],
            name: row[8],
            position: row[9],
            value: row[10],
            team,
            matches: row[12],
            league,
            key
          });

          data.players[key] = {
            key,
            league,
            name,
            team,
            teamKey,
            position: row[9],
            goals: 0,
            assists: 0,
            cs: 0,
            avgRating: row[10],
            matches: row[12],
            recentRatings: [],
            photoUrl
          };
        }
      });
    }

    // match players from goals/assists/CS into players map
    const byTeam = {};
    Object.values(data.players).forEach(p => {
      const tn = _normMatch(p.teamKey);
      const nn = _normMatch(p.name);
      if (!byTeam[tn]) byTeam[tn] = {};
      byTeam[tn][nn] = p.key;
    });

    function ensurePlayerForEntry(entry) {
      const teamKey = canonicalTeamName(entry.team);
      const tn = _normMatch(teamKey);
      const nn = _normMatch(entry.name);
      let key = (byTeam[tn] && byTeam[tn][nn]) ? byTeam[tn][nn] : null;

      if (!key) {
        key = _makePlayerKey(league, teamKey, entry.name);
        if (!data.players[key]) {
          data.players[key] = {
            key,
            league,
            name: entry.name,
            team: entry.team,
            teamKey,
            position: '',
            goals: 0,
            assists: 0,
            cs: 0,
            avgRating: 0,
            matches: 0,
            recentRatings: [],
            photoUrl: ''
          };
        }
      }
      return key;
    }

    data.goals.forEach(g => { const k = ensurePlayerForEntry(g); g.key = k; if (data.players[k]) data.players[k].goals = g.value; });
    data.assists.forEach(a => { const k = ensurePlayerForEntry(a); a.key = k; if (data.players[k]) data.players[k].assists = a.value; });
    data.cleanSheets.forEach(c => { const k = ensurePlayerForEntry(c); c.key = k; if (data.players[k]) data.players[k].cs = c.value; });

    statsData[league] = { ...data, loaded: true };
  } catch (e) {
    statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
  }
}

async function renderStats(league) {
  document.querySelectorAll('[id^="stat-btn-"]').forEach(b => b.classList.remove('active-league'));
  document.getElementById(`stat-btn-${league}`).classList.add('active-league');

  const content = document.getElementById('statsContent');
  content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading stats...</div>';

  if (league === 'COMBINED') {
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);
    const combined = { goals: [], assists: [], cleanSheets: [], ratings: [] };
    ['PREM', 'LALIGA', 'MLS'].forEach(lg => {
      if (statsData[lg].loaded) {
        combined.goals.push(...(statsData[lg].goals || []));
        combined.assists.push(...(statsData[lg].assists || []));
        combined.cleanSheets.push(...(statsData[lg].cleanSheets || []));
        combined.ratings.push(...(statsData[lg].ratings || []));
      }
    });
    combined.goals.sort((a, b) => parseInt(b.value) - parseInt(a.value));
    combined.assists.sort((a, b) => parseInt(b.value) - parseInt(a.value));
    combined.cleanSheets.sort((a, b) => parseInt(b.value) - parseInt(a.value));
    combined.ratings.sort((a, b) => parseFloat(b.value) - parseFloat(a.value));

    content.innerHTML = `
      <div class="space-y-6">
        <div class="stat-card">
          <h3 class="text-sm font-black text-[#00ff85] mb-4">GOALS</h3>
          ${combined.goals.slice(0, 10).map((p, idx) => `
            <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
              <div class="flex items-center gap-3">
                <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
                <div>
                  <div class="font-black">${p.name}</div>
                  <div class="text-xs text-zinc-500">${p.team}</div>
                </div>
              </div>
              <span class="text-[#00ff85] font-black">${p.value}</span>
            </div>
          `).join('')}
        </div>

        <div class="stat-card">
          <h3 class="text-sm font-black text-[#00ff85] mb-4">ASSISTS</h3>
          ${combined.assists.slice(0, 10).map((p, idx) => `
            <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
              <div class="flex items-center gap-3">
                <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
                <div>
                  <div class="font-black">${p.name}</div>
                  <div class="text-xs text-zinc-500">${p.team}</div>
                </div>
              </div>
              <span class="text-[#00ff85] font-black">${p.value}</span>
            </div>
          `).join('')}
        </div>

        <div class="stat-card">
          <h3 class="text-sm font-black text-[#00ff85] mb-4">CLEAN SHEETS</h3>
          ${combined.cleanSheets.slice(0, 10).map((p, idx) => `
            <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
              <div class="flex items-center gap-3">
                <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
                <div>
                  <div class="font-black">${p.name}</div>
                  <div class="text-xs text-zinc-500">${p.team}</div>
                </div>
              </div>
              <span class="text-[#00ff85] font-black">${p.value}</span>
            </div>
          `).join('')}
        </div>

        <div class="stat-card">
          <h3 class="text-sm font-black text-[#00ff85] mb-4">AVG RATING</h3>
          ${combined.ratings.slice(0, 10).map((p, idx) => `
            <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
              <div class="flex items-center gap-3">
                <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
                <div>
                  <div class="font-black">${p.name}</div>
                  <div class="text-xs text-zinc-500">
                    <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team} • ${p.matches || 0} apps
                  </div>
                </div>
              </div>
              <span class="text-[#00ff85] font-black">${parseFloat(p.value).toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    return;
  }

  await loadStats(league);
  const data = statsData[league];

  content.innerHTML = `
    <div class="space-y-6">
      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">GOALS</h3>
        ${(data.goals || []).slice(0, 10).map((p, idx) => `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
            <div class="flex items-center gap-3">
              <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
              <div>
                <div class="font-black">${p.name}</div>
                <div class="text-xs text-zinc-500">${p.team}</div>
              </div>
            </div>
            <span class="text-[#00ff85] font-black">${p.value}</span>
          </div>
        `).join('')}
      </div>

      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">ASSISTS</h3>
        ${(data.assists || []).slice(0, 10).map((p, idx) => `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
            <div class="flex items-center gap-3">
              <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
              <div>
                <div class="font-black">${p.name}</div>
                <div class="text-xs text-zinc-500">${p.team}</div>
              </div>
            </div>
            <span class="text-[#00ff85] font-black">${p.value}</span>
          </div>
        `).join('')}
      </div>

      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">CLEAN SHEETS</h3>
        ${(data.cleanSheets || []).slice(0, 10).map((p, idx) => `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
            <div class="flex items-center gap-3">
              <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
              <div>
                <div class="font-black">${p.name}</div>
                <div class="text-xs text-zinc-500">${p.team}</div>
              </div>
            </div>
            <span class="text-[#00ff85] font-black">${p.value}</span>
          </div>
        `).join('')}
      </div>

      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">AVG RATING</h3>
        ${(data.ratings || []).slice(0, 10).map((p, idx) => `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
            <div class="flex items-center gap-3">
              <span class="text-zinc-500 font-black w-6">${idx + 1}</span>
              <div>
                <div class="font-black">${p.name}</div>
                <div class="text-xs text-zinc-500">
                  <img src="${getLogo(p.team)}" class="w-3 h-3 inline-block align-[-2px] mr-1 object-contain">${p.team} • ${p.matches || 0} apps
                </div>
              </div>
            </div>
            <span class="text-[#00ff85] font-black">${parseFloat(p.value).toFixed(2)}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

async function viewPlayer(playerKeyOrName) {
  document.getElementById('player-tab').classList.remove('hidden');
  document.getElementById('hub-tab').classList.add('hidden');
  document.getElementById('standings-tab').classList.add('hidden');
  document.getElementById('stats-tab').classList.add('hidden');
  document.getElementById('team-tab').classList.add('hidden');

  const content = document.getElementById('playerContent');
  content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading player...</div>';

  const parts = _splitPlayerKey(playerKeyOrName);
  if (parts.league) await loadStats(parts.league);
  await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

  let playerData = null;

  if (parts.league && statsData[parts.league].players && statsData[parts.league].players[playerKeyOrName]) {
    playerData = statsData[parts.league].players[playerKeyOrName];
  } else {
    for (const lg of ['PREM', 'LALIGA', 'MLS']) {
      const pool = statsData[lg].players || {};
      if (pool[playerKeyOrName]) { playerData = pool[playerKeyOrName]; break; }
    }
  }

  if (!playerData) {
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Player not found</div>';
    return;
  }

  currentPlayer = playerData;

  const isGK = playerData.position && playerData.position.toLowerCase().includes('gk');
  const photoUrl = (playerData.photoUrl || '').toString().trim();

  content.innerHTML = `
    <div class="space-y-6">
      <div class="flex flex-col items-center gap-4">
        <div class="flex flex-col items-center">
          <img id="playerPhoto" class="w-20 h-20 rounded-full object-cover bg-zinc-800 border border-zinc-800" style="display:none;">
          <div id="playerAvatarFallback" class="player-avatar">${getPlayerInitials(playerData.name)}</div>
        </div>

        <div class="text-center">
          <h2 class="text-2xl font-black">${playerData.name}</h2>
          <p class="text-zinc-500 text-sm flex items-center justify-center gap-2">
            <img src="${getLogo(playerData.team)}" class="w-4 h-4 object-contain">
            <span class="cursor-pointer hover:text-[#00ff85]" onclick="viewTeam('${_jsEscapeSingle(playerData.team)}', '${playerData.league}')">${playerData.team}</span>
          </p>
          <p class="text-zinc-600 text-xs mt-1">${playerData.position || 'N/A'}</p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="stat-card text-center">
          <div class="text-3xl font-black text-[#00ff85]">${playerData.goals || 0}</div>
          <div class="text-xs text-zinc-500 mt-1">GOALS</div>
        </div>

        <div class="stat-card text-center">
          <div class="text-3xl font-black text-[#00ff85]">${playerData.assists || 0}</div>
          <div class="text-xs text-zinc-500 mt-1">ASSISTS</div>
        </div>

        <div class="stat-card text-center">
          <div class="text-3xl font-black text-[#00ff85]">${parseFloat(playerData.avgRating || 0).toFixed(2)}</div>
          <div class="text-xs text-zinc-500 mt-1">AVG RATING</div>
        </div>

        ${isGK ? `
        <div class="stat-card text-center">
          <div class="text-3xl font-black text-[#00ff85]">${playerData.cs || 0}</div>
          <div class="text-xs text-zinc-500 mt-1">CLEAN SHEETS</div>
        </div>
        ` : ''}
      </div>

      ${playerData.recentRatings && playerData.recentRatings.length > 0 ? `
      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">LAST 5 RATINGS</h3>
        <div class="flex gap-2">
          ${playerData.recentRatings.map(r => `
            <div class="flex-1 bg-zinc-900 rounded-lg py-3 text-center">
              <div class="font-black text-[#00ff85]">${parseFloat(r).toFixed(1)}</div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  `;

  if (photoUrl) {
    const imgEl = document.getElementById('playerPhoto');
    const fbEl = document.getElementById('playerAvatarFallback');
    loadPlayerPhotoToElement(photoUrl, imgEl, fbEl);
  }
}

async function viewTeam(teamName, league) {
  currentTeam = { name: teamName, league: league };

  document.getElementById('team-tab').classList.remove('hidden');
  document.getElementById('hub-tab').classList.add('hidden');
  document.getElementById('standings-tab').classList.add('hidden');
  document.getElementById('stats-tab').classList.add('hidden');
  document.getElementById('player-tab').classList.add('hidden');

  const content = document.getElementById('teamContent');
  content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading team...</div>';

  await loadStats(league);

  const teamKey = canonicalTeamName(teamName);
  const standings = await loadStandingsCache(league);
  const standing = standings ? standings[teamKey] : null;

  const teamPlayers = Object.values(statsData[league].players || {}).filter(p => (p.teamKey || canonicalTeamName(p.team)) === teamKey);

  const teamMatches = allMatches
    .filter(m => m.league === league && (m.homeKey === teamKey || m.awayKey === teamKey))
    .sort((a, b) => a.date - b.date);

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const past = teamMatches.filter(m => m.date < today && m.score !== 'v').slice(-5).reverse();
  const future = teamMatches.filter(m => m.date >= today || m.score === 'v').slice(0, 5);

  content.innerHTML = `
    <div class="space-y-6">
      <div class="flex items-center gap-4 mb-6">
        <img src="${getLogo(teamName)}" class="w-16 h-16 object-contain">
        <div>
          <h2 class="text-2xl font-black">${teamName}</h2>
          ${standing && standing.pos ? `
          <div class="text-zinc-600 text-xs mt-1">
            Standing: ${standing.pos}${standing.pts !== '' ? ` • ${standing.pts} pts` : ''}${standing.mp !== '' ? ` • ${standing.mp} MP` : ''}${standing.wdl ? ` • ${standing.wdl}` : ''}
          </div>` : ``}
        </div>
      </div>

      ${past.length > 0 ? `
      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">LAST 5 RESULTS</h3>
        ${past.map(m => {
          const isHome = m.homeKey === teamKey;
          const opponent = isHome ? m.away : m.home;
          return `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800">
            <div class="flex items-center gap-2">
              <img src="${getLogo(opponent)}" class="w-5 h-5 object-contain">
              <span class="text-sm">${isHome ? 'vs' : '@'} ${opponent}</span>
            </div>
            <span class="font-black text-sm">${m.score}</span>
          </div>`;
        }).join('')}
      </div>` : ''}

      ${future.length > 0 ? `
      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">NEXT 5 FIXTURES</h3>
        ${future.map(m => {
          const isHome = m.homeKey === teamKey;
          const opponent = isHome ? m.away : m.home;
          return `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800">
            <div class="flex items-center gap-2">
              <img src="${getLogo(opponent)}" class="w-5 h-5 object-contain">
              <span class="text-sm">${isHome ? 'vs' : '@'} ${opponent}</span>
            </div>
            <span class="text-zinc-500 text-xs">${m.date.toLocaleDateString()}</span>
          </div>`;
        }).join('')}
      </div>` : ''}

      <div class="stat-card">
        <h3 class="text-sm font-black text-[#00ff85] mb-4">PLAYERS</h3>
        ${teamPlayers.sort((a,b)=> (parseFloat(b.avgRating||0) - parseFloat(a.avgRating||0))).map(p => `
          <div class="flex items-center justify-between py-3 border-b border-zinc-800 cursor-pointer hover:bg-white/5 rounded-lg px-2" onclick="viewPlayer('${p.key}')">
            <div class="flex items-center gap-3">
              <div>
                <div class="font-black">${p.name}</div>
                <div class="text-xs text-zinc-500">${p.position || 'N/A'} • ${p.matches || 0} apps</div>
              </div>
            </div>
            <span class="text-[#00ff85] font-black">${parseFloat(p.avgRating || 0).toFixed(2)}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

async function searchPlayer(e, inputId = 'globalSearch') {
  if (e.key !== 'Enter') return;
  const el = document.getElementById(inputId);
  if (!el) return;
  const query = el.value.trim();
  if (!query) return;

  await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

  // Try exact key match first
  const parts = _splitPlayerKey(query);
  if (parts.league && statsData[parts.league].players && statsData[parts.league].players[query]) {
    viewPlayer(query);
    return;
  }

  // Fuzzy player match by name substring
  const q = query.toLowerCase();
  for (const lg of ['PREM','LALIGA','MLS']) {
    const pool = Object.values(statsData[lg].players || {});
    const found = pool.find(p => (p.name || '').toLowerCase() === q);
    if (found) { viewPlayer(found.key); return; }
  }
  for (const lg of ['PREM','LALIGA','MLS']) {
    const pool = Object.values(statsData[lg].players || {});
    const found = pool.find(p => (p.name || '').toLowerCase().includes(q));
    if (found) { viewPlayer(found.key); return; }
  }

  // Team match
  const teamNames = new Set();
  (allMatches || []).forEach(m => { teamNames.add(m.home); teamNames.add(m.away); });
  const teamList = Array.from(teamNames);
  const teamHit = teamList.find(t => t.toLowerCase() === q) || teamList.find(t => t.toLowerCase().includes(q));
  if (teamHit) {
    const league = (allMatches.find(m => m.home === teamHit || m.away === teamHit) || {}).league || 'PREM';
    viewTeam(teamHit, league);
    return;
  }

  viewPlayer(query);
}

function getPlayerInitials(name) {
  return (name || '').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

function waitUntil(pred, fn, tries=50){
  const tick = () => {
    try{ if (pred()) return fn(); }catch(e){}
    if (tries-- <= 0) return;
    setTimeout(tick, 100);
  };
  tick();
}

init();

/* ============================
   Existing “patch / augment” block (kept) + small adjustments
   ============================ */

(function(){
  // Helpers
  function stripEmoji(s){
    return (s||'').replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/gu, '').trim();
  }

  function findCurrentPlayerFromDOM(){
    const container = document.getElementById('content') || document.body;
    const nameEl = container.querySelector('#playerContent h2, #playerContent h1');
    const teamEl = container.querySelector('#playerContent p span.cursor-pointer');
    const name = stripEmoji(nameEl ? nameEl.textContent : '');
    const team = stripEmoji(teamEl ? teamEl.textContent : '');
    return { name, team };
  }

  function getPlayerDataByNameTeam(name, team){
    let best = null;
    ['PREM','LALIGA','MLS'].forEach(lg=>{
      const pool = (statsData[lg] && statsData[lg].players) ? statsData[lg].players : {};
      Object.values(pool).forEach(p => {
        if (!p || !p.name) return;
        const sameName = p.name.trim().toLowerCase() === name.trim().toLowerCase();
        const sameTeam = team ? (p.team && p.team.trim().toLowerCase() === team.trim().toLowerCase()) : true;
        if (sameName && sameTeam) best = p;
      });
    });
    return best;
  }

  (function patchViewPlayer(){
    if (window.__patchedViewPlayer || typeof window.viewPlayer !== 'function') {
      return waitUntil(()=> typeof window.viewPlayer === 'function' && !window.__patchedViewPlayer, patchViewPlayer);
    }
    const _orig = window.viewPlayer;
    window.viewPlayer = function(){
      const args = Array.from(arguments);
      _orig.apply(this, args);
      setTimeout(()=>{
        try {
          const container = document.getElementById('content') || document.body;

          // Remove emoji next to player's NAME only
          const nameEl = container.querySelector('#playerContent h2, #playerContent h1');
          if (nameEl) nameEl.textContent = stripEmoji(nameEl.textContent);

          // Ensure Last 5 Match Ratings exists (individual page only)
          let ratingsBox = container.querySelector('#last5Ratings');
          if (!ratingsBox) {
            const wrap = document.createElement('div');
            wrap.className = 'stat-card';
            wrap.innerHTML = '<h3 class="text-sm font-black text-[#00ff85] mb-3">Last 5 Match Ratings</h3>' +
                             '<div id="last5Ratings" class="space-y-2 text-sm"></div>';
            container.appendChild(wrap);
            ratingsBox = wrap.querySelector('#last5Ratings');
          }

          // Appearances card: insert after the Assists section
          let assistsCard = Array.from(container.querySelectorAll('#playerContent .stat-card .text-xs')).find(el => /assists/i.test(el.textContent||''));
          let targetGrid = container.querySelector('#playerContent .grid') || container;
          if (assistsCard && !container.querySelector('#appsValue')) {
            const appsCard = document.createElement('div');
            appsCard.className = 'stat-card text-center relative overflow-hidden';
            appsCard.setAttribute('data-added', 'apps');
            appsCard.innerHTML = '<div class="text-3xl font-black text-[#00ff85]" id="appsValue">0</div>' +
                                 '<div class="text-xs text-zinc-500 mt-1"># of Games (Appearances)</div>';
            const insertPoint = assistsCard.closest('.stat-card');
            if (insertPoint && insertPoint.parentNode) insertPoint.parentNode.insertBefore(appsCard, insertPoint.nextSibling);
            else targetGrid.appendChild(appsCard);
          }

          // Fill ratings + appearances via sheet caches
          const cur = findCurrentPlayerFromDOM();
          if (cur && cur.name) { fillAppsAndRatingsFor(cur.name); }
        } catch(e){}
      }, 0);
    };
    window.__patchedViewPlayer = true;
  })();

  // ---------- Coverage Augmentation ----------
  (function augmentCoverage(){
    if (!window.STATS_URLS || !window.Papa) return;

    function parseCsv(url, header=false){
      return new Promise(res=> Papa.parse(url,{ download:true, header:header, complete:r=>res(r.data||[]), error:()=>res([])}));
    }

    const sheetsCache = window.sheetsCache = window.sheetsCache || { byLeague:{}, builtSuggest:null };

    async function ensureIndex(){
      if (sheetsCache.builtSuggest) return sheetsCache.builtSuggest;
      await ensureAllLeagues();
      const arr = [];
      Object.keys(sheetsCache.byLeague).forEach(function(lg){
        const idx = sheetsCache.byLeague[lg];
        idx.players.forEach(function(teams, name){
          var team = teams && teams.size ? Array.from(teams)[0] : '';
          arr.push({ name:name, team:team, league:lg });
        });
      });
      sheetsCache.builtSuggest = arr;
      return arr;
    }

    async function ensureLeague(league){
      if (sheetsCache.byLeague[league]) return sheetsCache.byLeague[league];
      const src = (window.STATS_URLS && STATS_URLS[league]) ? STATS_URLS[league] : null;
      const info = sheetsCache.byLeague[league] = { players:new Map(), apps:new Map(), ratings:new Map() };
      if (!src) return info;

      async function addFromList(url){
        if (!url) return;
        const rows = await parseCsv(url, false);
        for (let i=0;i<rows.length;i++){
          const row = rows[i];
          if (!Array.isArray(row)) continue;
          const name = (row[0]||'').trim(); // A=Player
          const team = (row[2]||'').trim(); // C=Team
          if (!name || (i===0 && name.toLowerCase()==='player')) continue;
          if (!info.players.has(name)) info.players.set(name, new Set());
          if (team) info.players.get(name).add(team);
        }
      }
      await addFromList(src.goals);
      await addFromList(src.assists);
      await addFromList(src.cleanSheets);

      if (src.avgRatings){
        const avg = await parseCsv(src.avgRatings, false);
        avg.forEach(function(row){
          if (!Array.isArray(row)) return;
          const name = (row[8]||'').trim();      // I = Player
          const apps = parseInt(row[5],10);      // F = Appearances
          if (!name || Number.isNaN(apps)) return;
          info.apps.set(name, apps);
        });
      }

      if (src.ratingsLog){
        const rl = await parseCsv(src.ratingsLog, true);
        rl.forEach(function(r){
          if (!r) return;
          const name = (r.Player || r.Name || r['Player Name'] || '').trim();
          if (!name) return;
          const rating = parseFloat(r.Rating || r.Score || r['Match Rating'] || r.rating || r.score || '');
          if (!Number.isFinite(rating)) return;
          const date = (r.Date || r.MatchDate || r.DATE || '').toString().trim();
          const opponent = (r.Opponent || r.Opp || r.OPPONENT || '').toString().trim();
          if (!info.ratings.has(name)) info.ratings.set(name, []);
          info.ratings.get(name).push({ date, opponent, rating });
        });
      }

      return info;
    }

    async function ensureAllLeagues(){
      const leagues = Object.keys(STATS_URLS || {});
      for (let i=0;i<leagues.length;i++){
        const lg = leagues[i];
        if (!sheetsCache.byLeague[lg]) await ensureLeague(lg);
      }
      return sheetsCache;
    }

    async function lookupAppsFromAvgSheets(playerName){
      await ensureAllLeagues();
      let best = null;
      Object.keys(sheetsCache.byLeague).forEach(function(lg){
        const idx = sheetsCache.byLeague[lg];
        if (idx.apps.has(playerName)) best = idx.apps.get(playerName);
      });
      return best;
    }

    async function getLast5FromRatingsLog(name){
      await ensureAllLeagues();
      const leagues = Object.keys(sheetsCache.byLeague);
      for (let i=0;i<leagues.length;i++){
        const lg = leagues[i];
        const idx = sheetsCache.byLeague[lg];
        const list = idx.ratings.get(name) || [];
        if (list.length) return list.slice(-5);
      }
      return [];
    }

    async function fillAppsAndRatingsFor(name){
      const playerName = (name || '').trim();
      if (!playerName) return;

      const container = document.getElementById('content') || document.body;

      let appsEl = container.querySelector('#appsValue');
      if (!appsEl){
        // try to create if missing
        const grid = container.querySelector('#playerContent .grid') || container;
        const appsCard = document.createElement('div');
        appsCard.className = 'stat-card text-center relative overflow-hidden';
        appsCard.innerHTML = '<div class="text-3xl font-black text-[#00ff85]" id="appsValue">0</div>' +
                             '<div class="text-xs text-zinc-500 mt-1"># of Games (Appearances)</div>';
        grid.appendChild(appsCard);
        appsEl = appsCard.querySelector('#appsValue');
      }

      let box = container.querySelector('#last5Ratings');
      if (!box){
        const wrap = document.createElement('div');
        wrap.className = 'stat-card';
        wrap.innerHTML = '<h3 class="text-sm font-black text-[#00ff85] mb-3">Last 5 Match Ratings</h3>' +
                         '<div id="last5Ratings" class="space-y-2 text-sm"></div>';
        container.appendChild(wrap);
        box = wrap.querySelector('#last5Ratings');
      }

      // Fill appearances
      try {
        const apps = await lookupAppsFromAvgSheets(playerName);
        if (appsEl) appsEl.textContent = (apps!=null) ? apps : '0';
      } catch(e){}

      // Fill last 5
      try {
        const last5 = await getLast5FromRatingsLog(playerName);
        if (box){
          if (!last5.length) box.innerHTML = '<div class="text-zinc-500">No recent ratings</div>';
          else box.innerHTML = last5.map(r => {
            const when = r.date || '';
            const opp = r.opponent ? (' vs ' + r.opponent) : '';
            const val = (r.rating!=null) ? Number(r.rating).toFixed(2) : '—';
            return '<div class="flex items-center justify-between border-b border-zinc-800/40 pb-2"><span class="text-zinc-400">' +
                   when + opp + '</span><span class="font-mono font-bold">' + val + '</span></div>';
          }).join('');
        }
      } catch(e){}
    }

    window.ensureAllLeagues = ensureAllLeagues;
    window.ensureLeague = ensureLeague;
    window.lookupAppsFromAvgSheets = lookupAppsFromAvgSheets;
    window.getLast5FromRatingsLog = getLast5FromRatingsLog;
    window.fillAppsAndRatingsFor = fillAppsAndRatingsFor;

    async function showSuggestions(){
      var input = document.getElementById('globalSearch');
      var box = document.getElementById('globalSearchSuggestions');
      if (!input || !box) return;
      var q = (input.value||'').trim().toLowerCase();
      if (q.length < 2){ box.classList.add('hidden'); box.innerHTML=''; return; }

      await ensureIndex();

      var hits = (sheetsCache.builtSuggest || []).filter(function(p){
        return (p.name && p.name.toLowerCase().includes(q)) || (p.team && p.team.toLowerCase().includes(q));
      }).slice(0, 10);

      box.innerHTML = '';
      hits.forEach(function(p){
        var div = document.createElement('div');
        div.className = 'search-suggestion';
        var logo = (typeof getLogo==='function') ? getLogo(p.team) : '';
        div.innerHTML = '<span class="font-bold truncate">' + p.name + '</span>' +
                        '<span class="text-[10px] text-zinc-500 truncate"> (' + (p.team||'') + ')</span>' +
                        (logo ? '<img src="' + logo + '" class="w-4 h-4 ml-auto object-contain">' : '');
        div.addEventListener('click', function(){
          try {
            input.value = '';
            box.classList.add('hidden');
            // attempt to open player via existing app data
            const pool = (statsData[p.league] && statsData[p.league].players) ? Object.values(statsData[p.league].players) : [];
            const found = pool.find(x => x && x.name && x.name.toLowerCase() === p.name.toLowerCase() && (!p.team || (x.team||'').toLowerCase() === p.team.toLowerCase()));
            if (found) viewPlayer(found.key);
            else searchPlayer({ key: 'Enter' }, 'globalSearch');
          } catch(e){}
        });
        box.appendChild(div);
      });

      if (!hits.length) box.innerHTML = '<div class="search-suggestion text-zinc-500">No matches</div>';
      box.classList.remove('hidden');
    }

    function bindSuggest(){
      const input = document.getElementById('globalSearch');
      if (!input) return;
      input.addEventListener('input', function(){ showSuggestions(); });
      input.addEventListener('focus', function(){ showSuggestions(); });
      document.addEventListener('click', function(e){
        const box = document.getElementById('globalSearchSuggestions');
        if (!box) return;
        if (!box.contains(e.target) && e.target !== input) box.classList.add('hidden');
      });
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          const box = document.getElementById('globalSearchSuggestions');
          if (box) box.classList.add('hidden');
        }
      });
    }

    bindSuggest();
  })();
})();
</script>

</body>
</html>
