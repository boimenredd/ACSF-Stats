<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreHub Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff85; --bg: #0b0e11; --card: #161b22; --border: #30363d; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; letter-spacing: -0.02em; overflow-x: hidden; }
        header { background: rgba(11, 14, 17, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; max-width: 448px; z-index: 100; }

        .date-nav { display: flex; align-items: center; justify-content: space-between; padding: 16px; margin-top: 70px; }
        .date-display { font-weight: 900; font-size: 14px; text-transform: uppercase; text-align: center; flex: 1; }
        .nav-arrow { width: 36px; height: 36px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; font-weight: bold; }
        .today-btn { background: var(--accent); color: #000; font-size: 10px; font-weight: 900; padding: 6px 14px; border-radius: 6px; cursor: pointer; margin-top: 4px; }

        .league-container { background: #121212; border-radius: 16px; margin: 12px; overflow: hidden; border: 1px solid #222; }
        .league-header { background: #1a1a1a; padding: 12px 16px; display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 13px; color: #fff; border-bottom: 1px solid #222; }
        .league-logo { width: 20px; height: 20px; object-fit: contain; }
        .match-row { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #1a1a1a; }
        .team-box { display: flex; align-items: center; gap: 10px; flex: 1; }
        .team-logo { width: 24px; height: 24px; object-fit: contain; }
        .team-name { font-size: 13px; font-weight: 700; }
        .match-info { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .match-score { font-family: 'Roboto Mono', monospace; font-weight: 900; font-size: 16px; color: var(--accent); }

        .qualify-indicator { width: 4px; height: 24px; border-radius: 2px; margin-right: 10px; }
        .active-league { background: var(--accent) !important; color: #000 !important; }

        .nav-bottom { position: fixed; bottom: 0; width: 100%; max-width: 448px; background: #111; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .nav-item { color: #555; font-size: 10px; font-weight: 800; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .nav-item.active { color: var(--accent); }
        .player-avatar { width: 80px; height: 80px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #666; }
        .stat-card { background: #1a1a1a; border-radius: 12px; padding: 16px; border: 1px solid #222; }
        .search-input { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px 16px; color: #fff; width: 100%; font-size: 14px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .header-search-input { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 8px 10px; color: #fff; width: 170px; font-size: 12px; }
        .header-search-input:focus { outline: none; border-color: var(--accent); }

        .player-logo-dup { display:none !important; }

        .search-suggestions{
            position:absolute;
            right:16px;
            top:64px;
            background:#1a1a1a;
            border:1px solid #333;
            border-radius:10px;
            width:300px;
            max-height:320px;
            overflow-y:auto;
            z-index:200;
        }
        .search-suggestion{
            padding:10px 12px;
            cursor:pointer;
            font-size:12px;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .search-suggestion:hover{ background:#222; }

        .leader-pill{
            background:#111;
            border:1px solid #2a2a2a;
            border-radius:12px;
            padding:12px;
            cursor:pointer;
        }
        .leader-pill:hover{ border-color:#00ff85; }
    </style>
</head>
<body class="max-w-md mx-auto pb-24">

    <header class="p-4">
        <div class="flex items-center justify-between gap-3 relative">
            <h1 class="text-xl font-black italic uppercase cursor-pointer select-none" onclick="switchTab('hub')">Score<span class="text-[#00ff85]">Hub</span></h1>
            <input type="text" id="globalSearch" class="header-search-input" placeholder="Search teams or players..." onkeyup="searchPlayer(event)" oninput="queueSuggestions('globalSearch', 'globalSearchSuggestions')" onfocus="queueSuggestions('globalSearch', 'globalSearchSuggestions')">
            <div id="globalSearchSuggestions" class="search-suggestions hidden"></div>
        </div>
    </header>

    <main id="hub-tab">
        <div class="date-nav">
            <div class="nav-arrow" onclick="changeDate(-1)">‚Äπ</div>
            <div class="flex flex-col items-center">
                <div class="date-display" id="dateText">Loading...</div>
                <div class="today-btn" onclick="jumpToToday()">JUMP TO TODAY</div>
            </div>
            <div class="nav-arrow" onclick="changeDate(1)">‚Ä∫</div>
        </div>
        <div id="league-list"></div>
    </main>

    <div id="standings-tab" class="hidden pt-20">
        <div class="flex gap-2 px-4 py-4 overflow-x-auto no-scrollbar">
            <button id="btn-PREM" onclick="renderStandings('PREM')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap active-league">PREMIER LEAGUE</button>
            <button id="btn-LALIGA" onclick="renderStandings('LALIGA')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap">LA LIGA</button>
            <button id="btn-MLS" onclick="renderStandings('MLS')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap">MLS</button>
        </div>

        <div class="px-2 overflow-x-auto">
            <div class="bg-zinc-900/50 rounded-xl border border-zinc-800 min-w-[600px]">
                <table class="w-full text-left text-[11px]">
                    <thead><tr id="standingsHead" class="uppercase bg-zinc-800/50"></tr></thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="legend" class="mt-6 px-4 flex flex-wrap gap-4"></div>
    </div>

    <div id="stats-tab" class="hidden pt-20 pb-6">
        <div class="flex gap-2 px-4 py-4 overflow-x-auto no-scrollbar">
            <button id="stat-btn-PREM" onclick="renderStats('PREM')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap active-league">PREMIER LEAGUE</button>
            <button id="stat-btn-LALIGA" onclick="renderStats('LALIGA')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap">LA LIGA</button>
            <button id="stat-btn-MLS" onclick="renderStats('MLS')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap">MLS</button>
            <button id="stat-btn-COMBINED" onclick="renderStats('COMBINED')" class="league-btn text-[10px] font-black bg-zinc-800 px-5 py-2.5 rounded-full whitespace-nowrap">COMBINED</button>
        </div>
        <div id="statsContent" class="px-4"></div>
    </div>

    <div id="team-tab" class="hidden pt-20 pb-6">
        <div class="px-4">
            <button onclick="backToView()" class="text-[10px] font-black text-[#00ff85] mb-4">‚Üê BACK</button>
            <div id="teamContent"></div>
        </div>
    </div>

    <div id="player-tab" class="hidden pt-20 pb-6">
        <div class="px-4">
            <button onclick="backToView()" class="text-[10px] font-black text-[#00ff85] mb-4">‚Üê BACK</button>
            <div id="playerContent"></div>
        </div>
    </div>

    <nav class="nav-bottom">
        <div class="nav-item active" onclick="switchTab('hub')">
            <span class="text-lg">‚öΩ</span>
            <span>MAIN HUB</span>
        </div>
        <div class="nav-item" onclick="switchTab('standings')">
            <span class="text-lg">üèÜ</span>
            <span>STANDINGS</span>
        </div>
        <div class="nav-item" onclick="switchTab('stats')">
            <span class="text-lg">üìä</span>
            <span>STATS</span>
        </div>
    </nav>

<script>
const LOGOS = {
    "Liverpool": "https://resources.premierleague.com/premierleague25/badges-alt/14.svg",
    "Newcastle": "https://resources.premierleague.com/premierleague25/badges-alt/4.svg",
    "Chelsea": "https://resources.premierleague.com/premierleague25/badges-alt/8.svg",
    "Aston Villa": "https://resources.premierleague.com/premierleague25/badges-alt/7.svg",
    "Man City": "https://resources.premierleague.com/premierleague25/badges-alt/43.svg",
    "Man United": "https://resources.premierleague.com/premierleague25/badges-alt/1.svg",
    "Arsenal": "https://resources.premierleague.com/premierleague25/badges-alt/3.svg",
    "Southampton": "https://upload.wikimedia.org/wikipedia/en/thumb/c/c9/FC_Southampton.svg/1051px-FC_Southampton.svg.png",
    "Bournemouth": "https://resources.premierleague.com/premierleague25/badges-alt/91.svg",
    "Leeds": "https://resources.premierleague.com/premierleague25/badges-alt/2.svg",
    "Brighton": "https://resources.premierleague.com/premierleague25/badges-alt/36.svg",
    "West Ham": "https://resources.premierleague.com/premierleague25/badges-alt/21.svg",
    "Brentford": "https://resources.premierleague.com/premierleague25/badges-alt/94.svg",
    "Tottenham": "https://resources.premierleague.com/premierleague25/badges-alt/6.svg",
    "Crystal Palace": "https://resources.premierleague.com/premierleague25/badges-alt/31.svg",
    "Leicester": "https://upload.wikimedia.org/wikipedia/en/thumb/2/2d/Leicester_City_crest.svg/1200px-Leicester_City_crest.svg.png",
    "Nott'm Forest": "https://resources.premierleague.com/premierleague25/badges-alt/17.svg",
    "Sunderland": "https://resources.premierleague.com/premierleague25/badges-alt/56.svg",
    "Burnley": "https://resources.premierleague.com/premierleague25/badges-alt/90.svg",
    "Wolves": "https://resources.premierleague.com/premierleague25/badges-alt/39.svg",
    "Fulham": "https://resources.premierleague.com/premierleague25/badges-alt/54.svg",
    "Everton": "https://resources.premierleague.com/premierleague25/badges-alt/11.svg",
    "Ipswich": "https://resources.premierleague.com/premierleague25/badges-alt/40.svg",

    "Barcelona": "https://ssl.gstatic.com/onebox/media/sports/logos/paYnEE8hcrP96neHRNofhQ_48x48.png",
    "Real Madrid": "https://ssl.gstatic.com/onebox/media/sports/logos/Th4fAVAZeCJWRcKoLW7koA_48x48.png",
    "Sevilla": "https://ssl.gstatic.com/onebox/media/sports/logos/hCTs5EX3WjCMC5Jl3QE4Rw_48x48.png",
    "Real Sociedad": "https://ssl.gstatic.com/onebox/media/sports/logos/w8tb1aeBfVZIj9tZXf7eZg_48x48.png",
    "Girona": "https://ssl.gstatic.com/onebox/media/sports/logos/sHiSmLm_rA0BOC5MfrNt8A_48x48.png",
    "Atletico Madrid": "https://ssl.gstatic.com/onebox/media/sports/logos/pEqmA7CL-VRo4Llq3rwIPA_48x48.png",
    "Athletic Bilbao": "https://ssl.gstatic.com/onebox/media/sports/logos/OSL_5Zm6kYPP1J17Bo5uDA_48x48.png",
    "Elche": "https://ssl.gstatic.com/onebox/media/sports/logos/uyyqqxLIYT_lQIXRyMI_RA_48x48.png",
    "Osasuna": "https://ssl.gstatic.com/onebox/media/sports/logos/pk-hNCNpGM_JDoHHvLVF-Q_48x48.png",
    "Villarreal": "https://ssl.gstatic.com/onebox/media/sports/logos/WKH7Ak5cYD6Qm1EEqXzmVw_48x48.png",
    "Levante": "https://ssl.gstatic.com/onebox/media/sports/logos/SQB-jlVosxVV1Ce79FhbOA_48x48.png",
    "Las Palmas": "https://upload.wikimedia.org/wikipedia/sco/thumb/2/20/UD_Las_Palmas_logo.svg/1188px-UD_Las_Palmas_logo.svg.png",
    "Mallorca": "https://ssl.gstatic.com/onebox/media/sports/logos/Ss21P4CUmigjrEtcoapjVg_48x48.png",
    "Espanyol": "https://ssl.gstatic.com/onebox/media/sports/logos/TKitIqelDyN6M-kYt4Uc0g_48x48.png",
    "Valencia": "https://ssl.gstatic.com/onebox/media/sports/logos/QPbjvDwI_0Wuu4tCS2O6uw_48x48.png",
    "Real Betis": "https://ssl.gstatic.com/onebox/media/sports/logos/XDClkrMKtkm3UTP2YKN6oQ_48x48.png",
    "Oviedo": "https://ssl.gstatic.com/onebox/media/sports/logos/2hbZVQulcYqiPFXkWDkB_g_48x48.png",
    "Celta Vigo": "https://ssl.gstatic.com/onebox/media/sports/logos/wpdhixHP_sloegfP0UlwAw_48x48.png",
    "Rayo Vallecano": "https://ssl.gstatic.com/onebox/media/sports/logos/i5LifmxEVIl0sbvIysiyhw_48x48.png",
    "Alaves": "https://ssl.gstatic.com/onebox/media/sports/logos/RUcTOeFcBc7q7uku1nR_iQ_48x48.png",
    "Getafe": "https://ssl.gstatic.com/onebox/media/sports/logos/KfkDhn99TYUcNr8aBaLjqA_48x48.png",
    "Leganes": "https://ssl.gstatic.com/onebox/media/sports/logos/WM1T3GdEWT_BvbUQ0UInaw_48x48.png",
    "Valladolid": "https://ssl.gstatic.com/onebox/media/sports/logos/fsE7yqRo-8qLhH4dqKBMNg_48x48.png",

    "Miami": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755405/assets/logos/mls-clubs/Club_Logo-Miami_tyqe64.png",
    "LAFC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v174775309/assets/logos/mls-clubs/Club_Logo-LAFC_djrhru.png",
    "Atlanta": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747499879/assets/logos/mls-clubs/Club_Logo-Atlanta_jtk7ku.png",
    "Toronto": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265251/assets/logos/mls-clubs/Club_Logo-Toronto_vz6hao.png",
    "San Diego": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748261519/assets/logos/mls-clubs/Club_Logo-San_Diego_nwpyul.png",
    "Orlando": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747769281/assets/logos/mls-clubs/Club_Logo-Orlando_ryyn7a.png",
    "Houston": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500939/assets/logos/mls-clubs/Club_Logo-Houston_oifm77.png",
    "Charlotte": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500045/assets/logos/mls-clubs/Club_Logo-Charlotte_p7sznf.png",
    "Salt Lake": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747776403/assets/logos/mls-clubs/Club_Logo-Salt_Lake_City_hpvde5.png",
    "Vancouver": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265547/assets/logos/mls-clubs/Club_Logo-Vancouver_ao9phl.png",
    "LA Galaxy": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755165/assets/logos/mls-clubs/Club_Logo-LA_Galaxy_fg0wjp.png",
    "Seattle": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265125/assets/logos/mls-clubs/Club_Logo-Seattle_e6jk2x.png",
    "Columbus": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500414/assets/logos/mls-clubs/Club_Logo-Columbus_light_z3eq8l.png",
    "Montreal": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755806/assets/logos/mls-clubs/Club_Logo-Montreal_beeqnh.png",
    "San Jose": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748262048/assets/logos/mls-clubs/Club_Logo-San_Jose_opzlmo.png",
    "NY Red Bulls": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747771783/assets/logos/mls-clubs/Club_Logo-RBNY_dwawvt.png",
    "Colorado": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500322/assets/logos/mls-clubs/Club_Logo-Colorado_n5kpss.png",
    "New England": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1766020750/assets/NE_Logo_PRI_FC_RGB_480x480_fdx2us.png",
    "Minnesota": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747754826/assets/logos/mls-clubs/Club_Logo-Minnesota_ftweor.png",
    "Chicago": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500178/assets/logos/mls-clubs/Club_Logo-Chicago_jm2yev.png",
    "Portland": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747769540/assets/logos/mls-clubs/Club_Logo-Portland_qihpaz.png",
    "Nashville": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747754937/assets/logos/mls-clubs/Club_Logo-Nashville_owcihx.png",
    "Austin": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500115/assets/logos/mls-clubs/Club_Logo-Austin_u0tpqe.png",
    "FC Dallas": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500587/assets/logos/mls-clubs/Club_Logo-Dallas_oxywdo.png",
    "St Louis": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265198/assets/logos/mls-clubs/Club_Logo-St._Louis_oikgm5.png",
    "NYCFC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747755975/assets/logos/mls-clubs/Club_Logo-NYC_vhnmkv.png",
    "Philadelphia": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747772038/assets/logos/mls-clubs/Club_Logo-Philadelphia_l8yj9f.png",
    "Sporting KC": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1748265350/assets/logos/mls-clubs/Club_Logo-Sporting_Kansas_City_rrkzdb.png",
    "DC United": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500504/assets/logos/mls-clubs/Club_Logo-D.C_t03ekm.png",
    "Cincinnati": "https://images.mlssoccer.com/image/upload/t_club_logo_medium/v1747500252/assets/logos/mls-clubs/Club_Logo-Cincinatti_ohmgcp.png"
};

function _normMatch(s) {
    return (s || '')
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, ' ')
        .trim()
        .replace(/\s+/g, ' ');
}

const TEAM_ALIASES = {
    "real oviedo": "Oviedo",
    "oviedo": "Oviedo",
    "nott m forest": "Nott'm Forest",
    "nottingham forest": "Nott'm Forest",
    "man united": "Man United",
    "manchester united": "Man United",
    "man utd": "Man United",
    "man city": "Man City",
    "manchester city": "Man City",
    "spurs": "Tottenham",
    "tottenham hotspur": "Tottenham",
    "athletic": "Athletic Bilbao",
    "athletic club": "Athletic Bilbao",
    "betis": "Real Betis",
    "celta": "Celta Vigo",
    "c f montreal": "Montreal",
    "inter miami": "Miami",
    "inter miami cf": "Miami",
    "miami": "Miami",
    "lafc": "LAFC",
    "los angeles fc": "LAFC",
    "la galaxy": "LA Galaxy",
    "nycfc": "NYCFC",
    "new york city": "NYCFC",
    "new york red bulls": "NY Red Bulls",
    "rbny": "NY Red Bulls",
    "sporting kc": "Sporting KC",
    "skc": "Sporting KC",
    "dc united": "DC United",
    "st louis city": "St Louis",
    "real salt lake": "Salt Lake",
    "rsl": "Salt Lake",
    "seattle sounders": "Seattle",
    "columbus crew": "Columbus",
    "fc dallas": "FC Dallas",
    "dallas": "FC Dallas"
};

function canonicalTeamName(name) {
    const raw = (name || '').toString().trim();
    const key = _normMatch(raw);
    if (!key) return raw;
    return TEAM_ALIASES[key] || raw;
}

function _jsEscapeSingle(s) {
    return (s || '').toString().replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function getLogo(team) {
    if (!team) return "";
    const t = canonicalTeamName(team).trim();
    for (let key in LOGOS) {
        if (t.toLowerCase().includes(key.toLowerCase())) return LOGOS[key];
    }
    return `https://via.placeholder.com/24?text=${t.charAt(0)}`;
}

const SCHEDULE_URLS = {
    PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGHDcX_hIIzPlyqTZhiySqRNTQho5XFkyRaHqHa0tiPDC3D7zO_b3Mud054IRLzPKaHV1cERaYj3w0/pub?gid=1616061697&single=true&output=csv',
    LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGHDcX_hIIzPlyqTZhiySqRNTQho5XFkyRaHqHa0tiPDC3D7zO_b3Mud054IRLzPKaHV1cERaYj3w0/pub?gid=1516477023&single=true&output=csv',
    MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGHDcX_hIIzPlyqTZhiySqRNTQho5XFkyRaHqHa0tiPDC3D7zO_b3Mud054IRLzPKaHV1cERaYj3w0/pub?gid=1689966801&single=true&output=csv'
};

const STANDINGS_URLS = {
    PREM: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGHDcX_hIIzPlyqTZhiySqRNTQho5XFkyRaHqHa0tiPDC3D7zO_b3Mud054IRLzPKaHV1cERaYj3w0/pub?gid=935978435&single=true&output=csv',
    LALIGA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGHDcX_hIIzPlyqTZhiySqRNTQho5XFkyRaHqHa0tiPDC3D7zO_b3Mud054IRLzPKaHV1cERaYj3w0/pub?gid=886605383&single=true&output=csv',
    MLS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT03H3Or-8DCxNZkAnIdhVuwJsej-AEuo6VgZO3pG4WsBYt1HPxCLN0CsGa5P33XghzKltG5AiymB4q/pub?gid=1177278404&single=true&output=csv'
};

const LEAGUE_META = {
    PREM: { name: 'England - Premier League', logo: 'https://images.fotmob.com/image_resources/logo/teamlogo/eng.png' },
    LALIGA: { name: 'Spain - La Liga', logo: 'https://images.fotmob.com/image_resources/logo/teamlogo/esp.png' },
    MLS: { name: 'USA - MLS', logo: 'https://images.fotmob.com/image_resources/logo/teamlogo/usa.png' }
};

const STATS_URLS = {
    PREM: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=0&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1828601090&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=1875623411&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=812230696&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRc0sBW3bukg08_oX2R3oM-dfBXJZ9bfDwi1VNwZxsS2i7ufQ3jpsY5H9Z7NxaWmo8XsDSFldLhgqVH/pub?gid=692292778&single=true&output=csv'
    },
    LALIGA: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=0&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1828601090&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1875623411&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=1955113818&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTIqkW6tUlxDXdN1SXahdS7jNf_3TtBNFctLfwtL21hO4MAh5wHTtNPjTPwfaro0rqYekJVBRtszK6U/pub?gid=692292778&single=true&output=csv'
    },
    MLS: {
        goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=0&single=true&output=csv',
        assists: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1828601090&single=true&output=csv',
        cleanSheets: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=1875623411&single=true&output=csv',
        ratingsLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=812230696&single=true&output=csv',
        avgRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuw34XoWFJCJm7vYxAmfNNOOuVnprbE2kuVb9OpEgUZQsA6KhbxCYtW81oe1BkaGJ01fFMBpV5he31/pub?gid=692292778&single=true&output=csv'
    }
};

let allMatches = [];
let uniqueDates = [];
let dateIdx = 0;
let currentView = 'hub';
let currentTeam = null;
let currentTeamPlayersList = [];
let currentTeamLeague = '';
let currentTeamName = '';
let __searchIndex = { players: [], teams: [] };
let __searchIndexReady = false;
let __suggestTimer = null;

const statsData = {
    PREM: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false },
    LALIGA: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false },
    MLS: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false },
    COMBINED: { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false }
};

function _formatShortDate(d) {
    const dt = new Date(d);
    const m = dt.getMonth()+1;
    const day = dt.getDate();
    return `${m}/${day}`;
}

function _stripLeadingPosFromTeam(pos, team) {
    const p = (pos || '').toString().trim();
    let t = (team || '').toString().trim();
    if (!p) {
        const m = t.match(/^(\d+)\s+(.*)$/);
        if (m) return { pos: m[1], team: m[2] };
        return { pos: p, team: t };
    }
    const m2 = t.match(/^(\d+)\s+(.*)$/);
    if (m2) t = m2[2];
    return { pos: p, team: t };
}

function _leagueForTeamFast(teamName) {
    const tk = canonicalTeamName(teamName);
    const m = allMatches.find(x => x.homeKey === tk || x.awayKey === tk);
    if (m) return m.league;
    const logo = getLogo(teamName) || '';
    if (logo.includes('mlssoccer')) return 'MLS';
    if (logo.includes('premierleague')) return 'PREM';
    return 'LALIGA';
}

function searchPlayer(event) {
    if (event.key === "Enter") {
        const q = (event.target.value || '').trim();
        if (!q) return;
        const match = _bestSearchMatch(q);
        if (!match) return;
        if (match.type === 'player') viewPlayer(match.key);
        else viewTeam(match.name, _findTeamLeague(match.name));
        event.target.value = '';
        const box = document.getElementById('globalSearchSuggestions');
        if (box) { box.classList.add('hidden'); box.innerHTML=''; }
    }
}

async function ensureSearchIndex() {
    if (__searchIndexReady) return;
    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);
    const players = [];
    const teams = new Map();

    ['PREM','LALIGA','MLS'].forEach(lg => {
        const d = statsData[lg] || {};
        Object.values(d.players || {}).forEach(p => {
            if (!p || !p.name) return;
            players.push({ type: 'player', name: p.name, key: p.key, team: p.team, league: lg });
            const tn = canonicalTeamName(p.team);
            if (tn && !teams.has(tn)) teams.set(tn, { type: 'team', name: p.team, league: lg });
        });
    });

    const uniqPlayers = new Map();
    players.forEach(p => { if (!uniqPlayers.has(p.key)) uniqPlayers.set(p.key, p); });

    __searchIndex.players = Array.from(uniqPlayers.values());
    __searchIndex.teams = Array.from(teams.values());
    __searchIndexReady = true;
}

function _levDist(a,b, lim=50) {
    a = _normMatch(a);
    b = _normMatch(b);
    if (!a || !b) return 999;
    const la = a.length, lb = b.length;
    if (Math.abs(la - lb) > lim) return 999;
    const dp = Array.from({length: la+1}, ()=>Array(lb+1).fill(0));
    for (let i=0;i<=la;i++) dp[i][0]=i;
    for (let j=0;j<=lb;j++) dp[0][j]=j;
    for (let i=1;i<=la;i++){
        for (let j=1;j<=lb;j++){
            const cost = a[i-1]===b[j-1]?0:1;
            dp[i][j] = Math.min(
                dp[i-1][j]+1,
                dp[i][j-1]+1,
                dp[i-1][j-1]+cost
            );
        }
    }
    return dp[la][lb];
}

function _bestSearchMatch(query) {
    const q = _normMatch(query);
    if (!q) return null;
    const candidates = []
        .concat(__searchIndex.players || [])
        .concat(__searchIndex.teams || []);
    let best = null;
    let best2 = null;

    for (const c of candidates) {
        const d = _levDist(c.name, q, 60);
        if (d === 999) continue;
        if (best === null || d < best.d) { best2 = best; best = { c, d }; }
        else if (best2 === null || d < best2.d) { best2 = { c, d }; }
    }

    if (!best) return null;

    const nameLen = Math.max(_normMatch(best.c.name).length, q.length);
    const threshold = Math.max(2, Math.floor(nameLen * 0.25));
    if (best.d > threshold) return null;
    if (best2 && best2.d === best.d) return null;

    return best.c;
}

function _guessLeagueForTeam(teamName) {
    const logo = getLogo(teamName) || '';
    if (logo.includes('mlssoccer')) return 'MLS';
    if (logo.includes('premierleague')) return 'PREM';
    return 'LALIGA';
}
function _findTeamLeague(teamName) {
    const tk = canonicalTeamName(teamName);
    const m = allMatches.find(x => x.homeKey === tk || x.awayKey === tk);
    if (m) return m.league;
    return _guessLeagueForTeam(teamName);
}

async function loadStats(league) {
    if (!STATS_URLS[league]) {
        statsData[league] = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
        return;
    }
    if (statsData[league] && statsData[league].loaded) return;

    const src = STATS_URLS[league];
    const data = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: false };

    const parseCsv = (url, header=false) => new Promise((resolve) => {
        if (!url) return resolve([]);
        Papa.parse(url, {
            download: true,
            header: !!header,
            complete: (r) => resolve(r.data || []),
            error: () => resolve([])
        });
    });

    const upsertPlayer = (name, team) => {
        const n = (name || '').toString().trim();
        const t = (team || '').toString().trim();
        if (!n) return null;

        const teamKey = canonicalTeamName(t);
        const key = _makePlayerKey(league, teamKey, n);

        if (!data.players[key]) {
            data.players[key] = {
                key,
                league,
                name: n,
                team: t,
                teamKey,
                goals: 0,
                assists: 0,
                cleanSheets: 0,
                avgRating: null,
                matches: 0,
                recentRatings: [],
                position: '',
                photoUrl: ''
            };
        } else {
            if (t && !data.players[key].team) {
                data.players[key].team = t;
                data.players[key].teamKey = teamKey;
            }
        }
        return data.players[key];
    };

    const ingestABC = async (url, field, outArr) => {
        const rows = await parseCsv(url, false);
        rows.forEach((row, i) => {
            if (!Array.isArray(row)) return;
            const a = (row[0] || '').toString().trim();
            const b = (row[1] || '').toString().trim();
            const c = (row[2] || '').toString().trim();
            if (!a) return;
            if (i === 0 && (a.toLowerCase() === 'player' || a.toLowerCase().includes('name'))) return;

            const val = parseInt(b, 10);
            const p = upsertPlayer(a, c);
            if (!p) return;

            p[field] = Number.isNaN(val) ? (p[field] || 0) : val;
            outArr.push({ name: p.name, value: p[field] || 0, team: p.team, league, key: p.key });
        });
    };

    try {
        await ingestABC(src.goals, 'goals', data.goals);
        await ingestABC(src.assists, 'assists', data.assists);
        await ingestABC(src.cleanSheets, 'cleanSheets', data.cleanSheets);

        if (src.avgRatings) {
            const objRows = await parseCsv(src.avgRatings, true);
            const isObj = objRows.length && typeof objRows[0] === 'object' && !Array.isArray(objRows[0]);

            if (isObj) {
                objRows.forEach((r) => {
                    const name = (r.Player || r.Name || r['Player Name'] || r['player'] || '').toString().trim();
                    if (!name) return;
                    const team = (r.Team || r.Club || r['team'] || '').toString().trim();
                    const ratingRaw = (r.Avg || r['Avg Rating'] || r['Average Rating'] || r.Rating || r['rating'] || '').toString().trim();
                    const matchesRaw = (r.Matches || r.Games || r.Appearances || r['games'] || r['matches'] || '').toString().trim();
                    const pos = (r.Position || r.Pos || '').toString().trim();
                    const photo = (r.Photo || r.PhotoUrl || r['Photo URL'] || r['photo'] || '').toString().trim();

                    const p = upsertPlayer(name, team);
                    if (!p) return;

                    const val = parseFloat(ratingRaw);
                    if (!Number.isNaN(val)) p.avgRating = val;

                    const m = parseInt(matchesRaw, 10);
                    if (!Number.isNaN(m) && m > 0) p.matches = Math.max(p.matches || 0, m);

                    if (pos && !p.position) p.position = pos;
                    if (photo && !p.photoUrl) p.photoUrl = photo;

                    data.ratings.push({ name: p.name, value: p.avgRating || 0, team: p.team, league, key: p.key });
                });
            }
        }

        if (src.ratingsLog) {
            const rows = await parseCsv(src.ratingsLog, false);
            rows.forEach((row, i) => {
                if (!Array.isArray(row)) return;
                const name = (row[0] || '').toString().trim();
                const ratingRaw = (row[1] || '').toString().trim();
                const team = (row[2] || '').toString().trim();
                const date = (row[3] || '').toString().trim();
                const opp = (row[4] || '').toString().trim();
                if (!name) return;
                if (i === 0 && (name.toLowerCase() === 'player' || name.toLowerCase().includes('name'))) return;

                const rating = parseFloat(ratingRaw);
                if (Number.isNaN(rating)) return;

                const p = upsertPlayer(name, team);
                if (!p) return;

                p.matches = (p.matches || 0) + 1;
                p.recentRatings.push({ date, opponent: opp, rating });
            });
        }

        const dedupeByKey = (arr) => {
            const seen = new Map();
            arr.forEach(x => { if (x && x.key && !seen.has(x.key)) seen.set(x.key, x); });
            return Array.from(seen.values());
        };

        data.goals = dedupeByKey(data.goals);
        data.assists = dedupeByKey(data.assists);
        data.cleanSheets = dedupeByKey(data.cleanSheets);

        if (data.ratings && data.ratings.length) {
            const byKey = new Map();
            data.ratings.forEach(x => {
                if (!x || !x.key) return;
                if (!byKey.has(x.key) || (x.value && !byKey.get(x.key).value)) byKey.set(x.key, x);
            });
            data.ratings = Array.from(byKey.values());
        }

        const rankInt = (arr) => {
            arr.sort((a,b) => (parseInt(b.value,10) || 0) - (parseInt(a.value,10) || 0));
            arr.forEach((x,i)=>x.rank=i+1);
        };
        const rankFloat = (arr) => {
            arr.sort((a,b) => (parseFloat(b.value) || 0) - (parseFloat(a.value) || 0));
            arr.forEach((x,i)=>x.rank=i+1);
        };
        rankInt(data.goals);
        rankInt(data.assists);
        rankInt(data.cleanSheets);
        rankFloat(data.ratings);

        Object.values(data.players).forEach(p => {
            if (!p || !p.recentRatings) return;
            if (p.recentRatings.length > 5) p.recentRatings = p.recentRatings.slice(-5);
        });

        data.loaded = true;
        statsData[league] = data;
    } catch (e) {
        data.loaded = true;
        statsData[league] = data;
    }
}

function _makePlayerKey(league, teamKey, name) {
    const n = _normMatch(name);
    const t = _normMatch(teamKey);
    return `${league}::${t}::${n}`;
}

function _isGoalie(playerObj) {
    if (!playerObj) return false;
    const pos = (playerObj.position || '').toString().toLowerCase();
    return pos.includes('gk') || pos.includes('goal');
}

function _fmtRating(x){
    const v = Number(x);
    if (Number.isNaN(v)) return '-';
    return v.toFixed(2);
}
function _ratingPerfClass(r){
    const v = Number(r);
    if (Number.isNaN(v)) return 'px-3 py-1 rounded-full bg-zinc-800 border border-zinc-700 text-[11px] font-black';
    if (v >= 8.0) return 'px-3 py-1 rounded-full bg-green-500/15 border border-green-500/40 text-green-400 text-[11px] font-black tracking-tight';
    if (v >= 7.0) return 'px-3 py-1 rounded-full bg-lime-500/15 border border-lime-500/40 text-lime-300 text-[11px] font-black tracking-tight';
    if (v >= 6.0) return 'px-3 py-1 rounded-full bg-yellow-500/15 border border-yellow-500/40 text-yellow-300 text-[11px] font-black tracking-tight';
    return 'px-3 py-1 rounded-full bg-red-500/15 border border-red-500/40 text-red-400 text-[11px] font-black tracking-tight';
}

function getQualifyColor(lg, pos) {
    pos = parseInt(pos);
    if (lg === 'MLS') {
        if (pos === 1) return '#fbbf24';
        if (pos <= 8) return '#22c55e';
        if (pos === 18) return '#facc15';
        if (pos >= 19) return '#ef4444';
    } else {
        if (pos === 1) return '#00ff85';
        if (pos <= 4) return '#3b82f6';
        if (pos === 5) return '#fbbf24';
        if (pos === 6) return '#166534';
        if (pos >= 18) return '#ef4444';
    }
    return 'transparent';
}

function renderStandings(lg) {
    document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('active-league'));
    document.getElementById(`btn-${lg}`).classList.add('active-league');
    const head = document.getElementById('standingsHead');
    const body = document.getElementById('standingsBody');
    const legend = document.getElementById('legend');

    head.innerHTML = `<th class="pl-4 py-3">POS</th><th>Team</th><th class="text-center">MP</th><th class="text-center">W-D-L</th><th class="text-center">GF</th><th class="text-center">GA</th><th class="text-center">GD</th><th class="pr-4 text-right">PTS</th>`;

    Papa.parse(STANDINGS_URLS[lg], {
        download: true, header: true,
        complete: (res) => {
            body.innerHTML = (res.data || []).map(r => {
                let pos = r.Position || r.position || r['#'] || '';
                let team = r.Team || r.team || '';
                const fixed = _stripLeadingPosFromTeam(pos, team);
                pos = fixed.pos;
                team = fixed.team;

                const gf = r.GF || 0; const ga = r.GA || 0;
                const color = getQualifyColor(lg, pos);
                return `<tr class="border-b border-zinc-800/30">
                    <td class="pl-4 py-5 flex items-center"><div class="qualify-indicator" style="background:${color}"></div><span class="text-zinc-500">${pos}</span></td>
                    <td><div class="flex items-center gap-3 cursor-pointer hover:text-[#00ff85]" onclick="viewTeam('${_jsEscapeSingle(team)}', '${lg}')"><img src="${getLogo(team)}" class="w-6 h-6 object-contain"><span class="font-bold">${team}</span></div></td>
                    <td class="text-center text-zinc-400 font-mono">${r.MP || r.Played || 0}</td>
                    <td class="text-center text-zinc-400 font-mono">${r['W-D-L'] || r.Record || `${r.W||0}-${r.D||0}-${r.L||0}`}</td>
                    <td class="text-center text-zinc-400 font-mono">${gf}</td>
                    <td class="text-center text-zinc-400 font-mono">${ga}</td>
                    <td class="text-center text-zinc-400 font-mono">${(parseInt(gf,10)||0)-(parseInt(ga,10)||0)}</td>
                    <td class="pr-4 text-right font-black text-[#00ff85] font-mono">${r.PTS || r.Points || 0}</td>
                </tr>`;
            }).join('');

            const items = [];
            if (lg === 'MLS') {
                items.push({ label: 'Supporters Shield', color: '#fbbf24' });
                items.push({ label: 'Playoffs', color: '#22c55e' });
                items.push({ label: 'Relegation Playoff', color: '#facc15' });
                items.push({ label: 'Relegation', color: '#ef4444' });
            } else {
                items.push({ label: 'Champion', color: '#00ff85' });
                items.push({ label: 'Champions League', color: '#3b82f6' });
                items.push({ label: 'Europa League', color: '#fbbf24' });
                items.push({ label: 'Conference League', color: '#166534' });
                items.push({ label: 'Relegation', color: '#ef4444' });
            }

            legend.innerHTML = items.map(i => `<div class="flex items-center gap-2 text-[10px] font-black text-zinc-500 uppercase">
                <div class="w-3 h-3 rounded-sm" style="background:${i.color}"></div>
                <span>${i.label}</span>
            </div>`).join('');
        }
    });
}

function renderMatches() {
    const container = document.getElementById('league-list');
    const target = uniqueDates[dateIdx];
    if (!target) {
        document.getElementById('dateText').textContent = "NO DATA";
        container.innerHTML = "";
        return;
    }
    const dObj = new Date(target);
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    document.getElementById('dateText').textContent = `${days[dObj.getDay()]}, ${months[dObj.getMonth()]} ${dObj.getDate()}`;

    const filtered = allMatches.filter(m => m.date.getTime() === target);
    container.innerHTML = ['PREM', 'LALIGA', 'MLS'].map(lg => {
        const matches = filtered.filter(m => m.league === lg);
        if (matches.length === 0) return '';
        return `
            <div class="league-container">
                <div class="league-header"><img src="${LEAGUE_META[lg].logo}" class="league-logo"><span>${LEAGUE_META[lg].name}</span></div>
                ${matches.map(m => {
                    return `
                    <div class="match-row">
                        <div class="team-box justify-end cursor-pointer hover:opacity-70" onclick="viewTeam('${_jsEscapeSingle(m.home)}', '${lg}')"><span class="team-name text-right">${m.home}</span><img src="${getLogo(m.home)}" class="team-logo"></div>
                        <div class="match-info">
                            <div class="match-score">${m.score === 'v' ? 'v' : m.score}</div>
                        </div>
                        <div class="team-box justify-start cursor-pointer hover:opacity-70" onclick="viewTeam('${_jsEscapeSingle(m.away)}', '${lg}')"><img src="${getLogo(m.away)}" class="team-logo"><span class="team-name">${m.away}</span></div>
                    </div>`;
                }).join('')}
            </div>`;
    }).join('');
}

function changeDate(step) {
    dateIdx = Math.max(0, Math.min(uniqueDates.length - 1, dateIdx + step));
    renderMatches();
}

function jumpToToday() {
    const today = new Date(); today.setHours(0,0,0,0);
    let bestIdx = 0;
    let bestDiff = Infinity;
    uniqueDates.forEach((d,i) => {
        const diff = Math.abs(d - today.getTime());
        if (diff < bestDiff) { bestDiff = diff; bestIdx = i; }
    });
    dateIdx = bestIdx;
    renderMatches();
}

function switchTab(t) {
    currentView = t;
    document.getElementById('hub-tab').classList.toggle('hidden', t !== 'hub');
    document.getElementById('standings-tab').classList.toggle('hidden', t !== 'standings');
    document.getElementById('stats-tab').classList.toggle('hidden', t !== 'stats');
    document.getElementById('team-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    document.querySelectorAll('.nav-item').forEach(el => {
        const spanText = el.querySelector('span:last-child').textContent;
        if (t === 'hub' && spanText === 'MAIN HUB') el.classList.add('active');
        else if (t === 'standings' && spanText === 'STANDINGS') el.classList.add('active');
        else if (t === 'stats' && spanText === 'STATS') el.classList.add('active');
        else el.classList.remove('active');
    });

    if (t === 'standings') renderStandings('PREM');
    if (t === 'stats') renderStats('PREM');
}

function backToView() {
    if (currentView === 'hub') switchTab('hub');
    else if (currentView === 'standings') switchTab('standings');
    else if (currentView === 'stats') switchTab('stats');
}

async function renderStats(lg) {
    document.querySelectorAll('[id^="stat-btn-"]').forEach(b => b.classList.remove('active-league'));
    const btn = document.getElementById(`stat-btn-${lg}`);
    if (btn) btn.classList.add('active-league');

    if (lg === 'COMBINED') {
        await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

        const cloneArr = (arr) => (arr || []).map(x => ({ ...x }));

        const combined = { goals: [], assists: [], cleanSheets: [], ratings: [], players: {}, loaded: true };
        ['PREM','LALIGA','MLS'].forEach(l => {
            const d = statsData[l] || {};
            combined.goals = combined.goals.concat(cloneArr(d.goals || []));
            combined.assists = combined.assists.concat(cloneArr(d.assists || []));
            combined.cleanSheets = combined.cleanSheets.concat(cloneArr(d.cleanSheets || []));
            combined.ratings = combined.ratings.concat(cloneArr(d.ratings || []));
            Object.assign(combined.players, d.players || {});
        });

        const dedupeByKey = (arr) => {
            const seen = new Map();
            arr.forEach(x => { if (x && x.key && !seen.has(x.key)) seen.set(x.key, x); });
            return Array.from(seen.values());
        };

        combined.goals = dedupeByKey(combined.goals);
        combined.assists = dedupeByKey(combined.assists);
        combined.cleanSheets = dedupeByKey(combined.cleanSheets);

        if (combined.ratings && combined.ratings.length) {
            const byKey = new Map();
            combined.ratings.forEach(x => {
                if (!x || !x.key) return;
                if (!byKey.has(x.key) || (x.value && !byKey.get(x.key).value)) byKey.set(x.key, x);
            });
            combined.ratings = Array.from(byKey.values());
        }

        const rankInt = (arr) => {
            arr.sort((a,b) => (parseInt(b.value,10) || 0) - (parseInt(a.value,10) || 0));
            arr.forEach((x,i)=>x.rank=i+1);
        };
        const rankFloat = (arr) => {
            arr.sort((a,b) => (parseFloat(b.value) || 0) - (parseFloat(a.value) || 0));
            arr.forEach((x,i)=>x.rank=i+1);
        };
        rankInt(combined.goals);
        rankInt(combined.assists);
        rankInt(combined.cleanSheets);
        rankFloat(combined.ratings);

        statsData.COMBINED = combined;
    } else {
        await loadStats(lg);
    }

    const data = statsData[lg] || { goals:[], assists:[], cleanSheets:[], ratings:[], players:{} };
    const el = document.getElementById('statsContent');

    const makeList = (title, arr, tag) => {
        const list = (arr || []).slice(0, 10);
        return `
            <div class="stat-card mb-4">
                <div class="flex items-center justify-between">
                    <div class="font-black text-sm">${title}</div>
                    <div class="text-[10px] text-zinc-500 font-black">${tag}</div>
                </div>
                <div class="mt-3">
                    ${list.map(p => `
                        <div class="flex items-center justify-between py-2 border-b border-zinc-800/30 last:border-b-0">
                            <div class="flex items-center gap-3">
                                <div class="text-[10px] font-black text-zinc-500 w-5">${p.rank || ''}</div>
                                <div class="font-bold cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${_jsEscapeSingle(p.key)}')">${p.name}</div>
                            </div>
                            <div class="font-black text-[#00ff85] font-mono">${title === 'Average Rating' ? (Number(p.value).toFixed(2)) : p.value}</div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    };

    const goalieCleanSheets = (data.cleanSheets || []).filter(cs => {
        const pl = (data.players && data.players[cs.key]) ? data.players[cs.key] : null;
        return _isGoalie(pl);
    });

    el.innerHTML = `
        ${makeList('Goals', data.goals, 'GOALS')}
        ${makeList('Assists', data.assists, 'ASSISTS')}
        ${makeList('Clean Sheets', goalieCleanSheets, 'CLEAN')}
        ${makeList('Average Rating', data.ratings, 'RATING')}
    `;
}

/* UPDATED: clickable team names in last/next lists */
function _matchRowClickable(m) {
    const homeLg = _leagueForTeamFast(m.home);
    const awayLg = _leagueForTeamFast(m.away);
    return `
        <div class="flex items-center justify-between py-2 border-b border-zinc-800/40 last:border-b-0">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="text-[10px] font-black text-zinc-500 w-12">${_formatShortDate(m.date)}</span>

                <img src="${getLogo(m.home)}" class="w-4 h-4 object-contain">
                <button class="text-[11px] font-bold hover:text-[#00ff85]" onclick="viewTeam('${_jsEscapeSingle(m.home)}','${homeLg}')">${m.home}</button>

                <span class="text-zinc-500 text-[10px] font-black">vs</span>

                <button class="text-[11px] font-bold hover:text-[#00ff85]" onclick="viewTeam('${_jsEscapeSingle(m.away)}','${awayLg}')">${m.away}</button>
                <img src="${getLogo(m.away)}" class="w-4 h-4 object-contain">
            </div>
            <div class="font-mono text-[#00ff85] font-black">${m.score}</div>
        </div>
    `;
}

async function viewTeam(teamName, league) {
    currentTeam = { name: teamName, league };
    document.getElementById('team-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('player-tab').classList.add('hidden');

    const content = document.getElementById('teamContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading team...</div>';

    await loadStats(league);

    const tk = canonicalTeamName(teamName);
    const teamPlayers = Object.values(statsData[league].players || {}).filter(p => canonicalTeamName(p.team) === tk);

    currentTeamPlayersList = teamPlayers.slice();
    currentTeamLeague = league;
    currentTeamName = teamName;

    const { goalsLeader, assistsLeader, ratingLeader } = _teamLeaders(teamPlayers);

    const teamMatchesAll = allMatches
        .filter(m => m.league === league && (m.homeKey === tk || m.awayKey === tk))
        .slice()
        .sort((a,b)=>a.date-b.date);

    const today = new Date(); today.setHours(0,0,0,0);

    const played = teamMatchesAll.filter(m => (m.score || '').trim().toLowerCase() !== 'v');
    const upcoming = teamMatchesAll.filter(m => (m.score || '').trim().toLowerCase() === 'v' && m.date >= today);

    const last5 = played.slice().sort((a,b)=>b.date-a.date).slice(0,5).reverse();
    const next5 = upcoming.slice(0,5);

    content.innerHTML = `
        <div class="stat-card">
            <div class="flex items-center gap-3">
                <img src="${getLogo(teamName)}" class="w-10 h-10 object-contain">
                <div class="flex flex-col">
                    <div class="text-xl font-black">${teamName}</div>
                    <div class="text-zinc-500 text-xs font-black uppercase">${LEAGUE_META[league].name}</div>
                </div>
            </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-3">
            <div class="leader-pill" onclick="showTeamLeaderboard('goals')">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Leading Goal Scorer</div>
                <div class="mt-1 flex items-center justify-between">
                    <div class="font-black">${goalsLeader ? goalsLeader.name : '-'}</div>
                    <div class="font-black text-[#00ff85] font-mono">${goalsLeader ? (goalsLeader.goals||0) : '-'}</div>
                </div>
                <div class="text-[10px] text-zinc-500 mt-1">Tap to view full goals leaderboard</div>
            </div>

            <div class="leader-pill" onclick="showTeamLeaderboard('assists')">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Assist Leader</div>
                <div class="mt-1 flex items-center justify-between">
                    <div class="font-black">${assistsLeader ? assistsLeader.name : '-'}</div>
                    <div class="font-black text-[#00ff85] font-mono">${assistsLeader ? (assistsLeader.assists||0) : '-'}</div>
                </div>
                <div class="text-[10px] text-zinc-500 mt-1">Tap to view full assists leaderboard</div>
            </div>

            <div class="leader-pill" onclick="showTeamLeaderboard('rating')">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Match Rating Leader</div>
                <div class="mt-1 flex items-center justify-between">
                    <div class="font-black">${ratingLeader ? ratingLeader.name : '-'}</div>
                    <div class="font-black text-[#00ff85] font-mono">${ratingLeader ? _fmtRating(ratingLeader.avgRating) : '-'}</div>
                </div>
                <div class="text-[10px] text-zinc-500 mt-1">Tap to view full rating leaderboard</div>
            </div>
        </div>

        <div id="teamLeaderboard" class="mt-4"></div>

        <div class="mt-6 stat-card">
            <div class="text-[10px] font-black text-zinc-500 uppercase mb-2">Last 5 Results</div>
            <div class="bg-zinc-900/40 border border-zinc-800 rounded-xl p-3">
                ${last5.map(m => _matchRowClickable(m)).join('') || '<div class="text-zinc-500 text-sm py-2">No results yet.</div>'}
            </div>
        </div>

        <div class="mt-4 stat-card">
            <div class="text-[10px] font-black text-zinc-500 uppercase mb-2">Next 5 Matches</div>
            <div class="bg-zinc-900/40 border border-zinc-800 rounded-xl p-3">
                ${next5.map(m => _matchRowClickable(m)).join('') || '<div class="text-zinc-500 text-sm py-2">No upcoming matches.</div>'}
            </div>
        </div>
    `;
}

function _teamLeaders(players){
    const valid = (players || []).slice();

    const goalsSorted = valid.filter(p => (p && p.goals) ? (p.goals||0) > 0 : false).slice()
        .sort((a,b)=> (b.goals||0)-(a.goals||0));
    const assistsSorted = valid.filter(p => (p && p.assists) ? (p.assists||0) > 0 : false).slice()
        .sort((a,b)=> (b.assists||0)-(a.assists||0));
    const ratingSorted = valid.filter(p => (p && p.avgRating != null) ? Number(p.avgRating||0) > 0 : false).slice()
        .sort((a,b)=> (Number(b.avgRating||0))-(Number(a.avgRating||0)));

    const goalsLeader = goalsSorted[0] || null;
    const assistsLeader = assistsSorted[0] || null;
    const ratingLeader = ratingSorted[0] || null;

    return { goalsLeader, assistsLeader, ratingLeader, goalsSorted, assistsSorted, ratingSorted };
}

function showTeamLeaderboard(type){
    const box = document.getElementById('teamLeaderboard');
    if (!box) return;

    const players = currentTeamPlayersList || [];
    const { goalsSorted, assistsSorted, ratingSorted } = _teamLeaders(players);

    let title = '';
    let list = [];
    if (type === 'goals') { title = 'Goals Leaderboard'; list = goalsSorted; }
    else if (type === 'assists') { title = 'Assists Leaderboard'; list = assistsSorted; }
    else { title = 'Match Rating Leaderboard'; list = ratingSorted; }

    const filtered = (list || []).filter(p => {
        if (!p || !p.name) return false;
        if (type === 'goals') return (p.goals||0) > 0;
        if (type === 'assists') return (p.assists||0) > 0;
        return Number(p.avgRating||0) > 0;
    });

    const rows = filtered.map((p, idx) => {
        const val = type === 'goals' ? (p.goals||0) : type === 'assists' ? (p.assists||0) : _fmtRating(p.avgRating);
        return `
            <div class="flex items-center justify-between py-2 border-b border-zinc-800/40 last:border-b-0">
                <div class="flex items-center gap-3">
                    <div class="text-[10px] font-black text-zinc-500 w-6">${idx+1}</div>
                    <div class="font-bold cursor-pointer hover:text-[#00ff85]" onclick="viewPlayer('${_jsEscapeSingle(p.key)}')">${p.name}</div>
                </div>
                <div class="font-black text-[#00ff85] font-mono">${val}</div>
            </div>
        `;
    }).join('');

    box.innerHTML = `
        <div class="text-[10px] font-black text-zinc-500 uppercase mb-2">${title}</div>
        <div class="bg-zinc-900/40 border border-zinc-800 rounded-xl p-3">
            ${rows || '<div class="text-zinc-500 text-sm py-2">No data yet.</div>'}
        </div>
    `;
}

function queueSuggestions(inputId, boxId){
    if (__suggestTimer) clearTimeout(__suggestTimer);
    const el = document.getElementById(inputId);
    if (!el) return;
    __suggestTimer = setTimeout(() => {
        showSearchSuggestions(el.value, inputId, boxId);
    }, 90);
}

async function showSearchSuggestions(query, inputId, boxId) {
    const box = document.getElementById(boxId);
    const input = document.getElementById(inputId);
    if (!box || !input) return;

    const q = (query || '').trim();
    if (q.length < 1) { box.classList.add('hidden'); box.innerHTML=''; return; }

    await ensureSearchIndex();

    const qn = _normMatch(q);

    const pMatches = __searchIndex.players
        .filter(p => _normMatch(p.name).includes(qn))
        .slice(0, 8);

    const tMatches = __searchIndex.teams
        .filter(t => _normMatch(t.name).includes(qn))
        .slice(0, 6);

    const items = pMatches.concat(tMatches).slice(0, 12);

    if (!items.length) { box.classList.add('hidden'); box.innerHTML=''; return; }

    box.innerHTML = items.map(item => {
        if (item.type === 'player') {
            return `<div class="search-suggestion" onclick="selectSuggestion('player','${_jsEscapeSingle(item.key)}','${_jsEscapeSingle(item.name)}','${inputId}','${boxId}')">
                <span class="text-[#00ff85] font-black">P</span>
                <div class="flex flex-col leading-tight">
                    <span class="font-bold">${item.name}</span>
                    <span class="text-zinc-500 text-[10px]">${item.team}</span>
                </div>
            </div>`;
        }
        return `<div class="search-suggestion" onclick="selectSuggestion('team','${_jsEscapeSingle(item.name)}','${_jsEscapeSingle(item.name)}','${inputId}','${boxId}')">
            <span class="text-[#00ff85] font-black">T</span>
            <div class="flex items-center gap-2">
                <img src="${getLogo(item.name)}" class="w-4 h-4 object-contain">
                <span class="font-bold">${item.name}</span>
            </div>
        </div>`;
    }).join('');

    box.classList.remove('hidden');
}

function selectSuggestion(type, value, displayName, inputId, boxId) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(boxId);
    if (input) input.value = displayName || value;
    if (box) { box.classList.add('hidden'); box.innerHTML=''; }

    if (type === 'player') viewPlayer(value);
    else viewTeam(value, _findTeamLeague(value));
}

document.addEventListener('click', (e) => {
    const box = document.getElementById('globalSearchSuggestions');
    const input = document.getElementById('globalSearch');
    if (!box || !input) return;
    if (box.contains(e.target) || input.contains(e.target)) return;
    box.classList.add('hidden');
});

async function viewPlayer(playerKeyOrName) {
    document.getElementById('player-tab').classList.remove('hidden');
    document.getElementById('hub-tab').classList.add('hidden');
    document.getElementById('standings-tab').classList.add('hidden');
    document.getElementById('stats-tab').classList.add('hidden');
    document.getElementById('team-tab').classList.add('hidden');

    const content = document.getElementById('playerContent');
    content.innerHTML = '<div class="text-center text-zinc-500 py-8">Loading player...</div>';

    await Promise.all([loadStats('PREM'), loadStats('LALIGA'), loadStats('MLS')]);

    let playerData = null;
    const searchKey = (playerKeyOrName || '').toString().trim();

    const pools = [statsData.PREM.players, statsData.LALIGA.players, statsData.MLS.players];
    for (const pool of pools) {
        if (!pool) continue;
        if (pool[searchKey]) { playerData = pool[searchKey]; break; }
    }

    if (!playerData) {
        const q = _normMatch(searchKey);
        for (const pool of pools) {
            const vals = Object.values(pool || {});
            const hit = vals.find(p => _normMatch(p.name) === q);
            if (hit) { playerData = hit; break; }
        }
    }

    if (!playerData) {
        content.innerHTML = '<div class="text-center text-zinc-500 py-8">Player not found.</div>';
        return;
    }

    const isGK = _isGoalie(playerData);

    content.innerHTML = `
        <div class="stat-card">
            <div class="flex items-center gap-4">
                ${playerData.photoUrl ? `<img src="${playerData.photoUrl}" class="player-avatar object-cover">` : `<div class="player-avatar">${(playerData.name||'?').trim().charAt(0).toUpperCase()}</div>`}
                <div class="flex flex-col">
                    <div class="text-xl font-black">${playerData.name}</div>
                    <p class="text-zinc-500 text-xs font-black uppercase">
                        <span class="cursor-pointer hover:text-[#00ff85]" onclick="viewTeam('${_jsEscapeSingle(playerData.team)}', '${playerData.league}')">${playerData.team}</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-6 stat-card">
            <div class="text-[10px] font-black text-zinc-500 uppercase mb-2">Last 5 Match Ratings</div>
            <div class="flex gap-2 flex-wrap">
                ${(playerData.recentRatings && playerData.recentRatings.length ? playerData.recentRatings.slice(-5) : []).map(r => {
                    const cls = _ratingPerfClass(r.rating);
                    const val = (r.rating != null && !Number.isNaN(Number(r.rating))) ? Number(r.rating).toFixed(1) : '-';
                    return `
                        <div class="${cls}">${val}</div>
                    `;
                }).join('') || '<div class="text-zinc-500 text-sm">No ratings yet</div>'}
            </div>
        </div>

        <div class="grid grid-cols-${isGK ? 4 : 3} gap-3 mt-6">
            <div class="stat-card text-center relative overflow-hidden">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Goals</div>
                <div class="text-2xl font-black text-[#00ff85] mt-1">${playerData.goals || 0}</div>
                <img src="${getLogo(playerData.team)}" class="absolute -bottom-10 -right-10 w-32 h-32 object-contain opacity-10 pointer-events-none player-logo-dup">
            </div>
            <div class="stat-card text-center relative overflow-hidden">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Assists</div>
                <div class="text-2xl font-black text-[#00ff85] mt-1">${playerData.assists || 0}</div>
                <img src="${getLogo(playerData.team)}" class="absolute -bottom-10 -right-10 w-32 h-32 object-contain opacity-10 pointer-events-none player-logo-dup">
            </div>
            <div class="stat-card text-center relative overflow-hidden">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Games</div>
                <div class="text-2xl font-black text-[#00ff85] mt-1">${playerData.matches || 0}</div>
                <img src="${getLogo(playerData.team)}" class="absolute -bottom-10 -right-10 w-32 h-32 object-contain opacity-10 pointer-events-none player-logo-dup">
            </div>
            ${isGK ? `
            <div class="stat-card text-center relative overflow-hidden">
                <div class="text-[10px] font-black text-zinc-500 uppercase">Clean Sheets</div>
                <div class="text-2xl font-black text-[#00ff85] mt-1">${playerData.cleanSheets || 0}</div>
                <img src="${getLogo(playerData.team)}" class="absolute -bottom-10 -right-10 w-32 h-32 object-contain opacity-10 pointer-events-none player-logo-dup">
            </div>` : ''}
        </div>

        <div class="mt-4 stat-card">
            <div class="text-[10px] font-black text-zinc-500 uppercase">Average Rating</div>
            <div class="text-3xl font-black text-[#00ff85] mt-1 font-mono">${playerData.avgRating != null ? _fmtRating(playerData.avgRating) : '-'}</div>
        </div>
    `;
}

async function loadSchedules() {
    const parse = (lg) => new Promise((resolve) => {
        Papa.parse(SCHEDULE_URLS[lg], {
            download: true,
            header: true,
            complete: (res) => {
                const rows = res.data || [];
                const matches = [];
                rows.forEach(r => {
                    const dateStr = (r.Date || r.date || r.MatchDate || '').toString().trim();
                    const home = (r.Home || r.HomeTeam || r.home || r['Home Team'] || '').toString().trim();
                    const away = (r.Away || r.AwayTeam || r.away || r['Away Team'] || '').toString().trim();
                    const score = (r.Score || r.score || r.Result || 'v').toString().trim() || 'v';
                    if (!dateStr || !home || !away) return;
                    const d = new Date(dateStr);
                    if (isNaN(d.getTime())) return;
                    d.setHours(0,0,0,0);
                    matches.push({
                        league: lg,
                        date: d,
                        home,
                        away,
                        homeKey: canonicalTeamName(home),
                        awayKey: canonicalTeamName(away),
                        score
                    });
                });
                resolve(matches);
            },
            error: () => resolve([])
        });
    });

    const all = (await Promise.all(['PREM','LALIGA','MLS'].map(parse))).flat();
    allMatches = all.sort((a,b)=>a.date-b.date);

    uniqueDates = Array.from(new Set(allMatches.map(m => m.date.getTime()))).sort((a,b)=>a-b);

    const today = new Date(); today.setHours(0,0,0,0);
    let bestIdx = 0;
    let bestDiff = Infinity;
    uniqueDates.forEach((d,i) => {
        const diff = Math.abs(d - today.getTime());
        if (diff < bestDiff) { bestDiff = diff; bestIdx = i; }
    });
    dateIdx = bestIdx;

    renderMatches();
}

loadSchedules();
</script>
</body>
</html>
